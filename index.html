<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCALCULO</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
    <!-- SheetJS para exportar a Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js para gr치ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Cookie Consent for AdSense -->
    <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" />
</head>
<body>
    <!-- Pop-up inicial -->
    <div id="popup" class="popup">
        <div class="popup-content">
            <span class="close-btn" onclick="cerrarPopup()">칑</span>
            <h2 id="popup-title">춰Optimiza tu producci칩n con JCALCULO!</h2>
            <p id="popup-message">Descubre la herramienta que revoluciona la gesti칩n de pezoneras. 춰Reg칤strate y toma el control hoy!</p>
            <p id="popup-contact">游닎 Soporte: <a href="mailto:alfstiven@gmail.com">alfstiven@gmail.com</a></p>
        </div>
    </div>

    <!-- Pop-up para usuarios no verificados -->
    <div id="unverified-popup" class="popup">
        <div class="popup-content">
            <span class="close-btn" onclick="cerrarUnverifiedPopup()">칑</span>
            <h2>춰Convi칠rtete en usuario verificado!</h2>
            <p>Beneficios exclusivos:</p>
            <ul>
                <li>Gr치ficos avanzados de desgaste de pezoneras.</li>
                <li>Gesti칩n completa de tus c치lculos.</li>
                <li>Experiencia sin publicidad.</li>
                <li>Notificaciones personalizadas.</li>
            </ul>
            <p>Cont치ctanos en <a href="mailto:alfstiven@gmail.com">alfstiven@gmail.com</a> para m치s informaci칩n.</p>
        </div>
    </div>

    <div class="container">
        <a href="#" class="admin-link" onclick="mostrarLoginAdmin()">Admin</a>
        <img id="app-logo" class="logo" style="display: none;" alt="Logo de JCALCULO">
        <h1>JCALCULO</h1>

        <div id="auth-message" class="auth-message">
            Por favor, reg칤strate o inicia sesi칩n para usar la calculadora.
        </div>

        <div id="calculator-info">
            <h3>춰Gestiona tus Pezoneras como Nunca Antes! 游</h3>
            <p>Con <strong>JCALCULO</strong>, optimiza el cambio de tus pezoneras de manera f치cil y precisa. Nuestra herramienta calcula el n칰mero exacto de pezoneras necesarias, estima su durabilidad y te <strong>notifica el pr칩ximo cambio</strong> para que nunca pierdas el control. 游댒 Ahorra tiempo, mejora la eficiencia de tu orde침o y lleva tu producci칩n al siguiente nivel. 춰Conf칤a en JCALCULO, la soluci칩n que todo ganadero necesita! 游낷</p>
        </div>

        <!-- Formulario de Registro -->
        <div id="registro-section">
            <h3>Reg칤strate</h3>
            <label for="nombre">Nombre:</label>
            <input type="text" id="nombre" placeholder="Tu nombre" required>
            <label for="profesion">Profesi칩n:</label>
            <select id="profesion" onchange="mostrarCamposProfesion()" required>
                <option value="" selected>Selecciona...</option>
                <option value="ganadero">Ganadero</option>
                <option value="tecnico">T칠cnico</option>
                <option value="otro">Otro</option>
            </select>
            <div id="empresa-section" style="display: none;">
                <label for="empresa">Nombre de la Granja o Explotaci칩n:</label>
                <input type="text" id="empresa" placeholder="Nombre de la granja o explotaci칩n" required>
            </div>
            <div id="otra-profesion-section" style="display: none;">
                <label for="otra-profesion">Especifica tu Profesi칩n:</label>
                <input type="text" id="otra-profesion" placeholder="Escribe tu profesi칩n">
            </div>
            <label for="telefono">N칰mero de Celular o Tel칠fono:</label>
            <input type="tel" id="telefono" placeholder="Ej. +573001234567" pattern="[0-9+]+" required>
            <label for="email">Correo Electr칩nico:</label>
            <input type="email" id="email" placeholder="tu@correo.com" required>
            <label for="password">Contrase침a:</label>
            <input type="password" id="password" placeholder="Contrase침a" required>
            <button type="button" onclick="registrarUsuario()">Registrarse</button>
            <p>쯏a tienes cuenta? <a href="#" onclick="mostrarLoginUsuario()">Inicia sesi칩n</a></p>
        </div>

        <!-- Formulario de Login de Usuario -->
        <div id="login-section">
            <h3>Iniciar Sesi칩n</h3>
            <label for="login-email">Correo Electr칩nico:</label>
            <input type="email" id="login-email" placeholder="tu@correo.com" required>
            <label for="login-password">Contrase침a:</label>
            <input type="password" id="login-password" placeholder="Contrase침a" required>
            <button type="button" onclick="loginUsuario()">Iniciar Sesi칩n</button>
            <p><a href="#" onclick="recuperarContrasena()">쯆lvidaste tu contrase침a?</a></p>
            <p>쯅o tienes cuenta? <a href="#" onclick="mostrarRegistro()">Reg칤strate</a></p>
        </div>

        <!-- Secci칩n de usuario logueado -->
        <div id="user-section">
            <h3>Bienvenido, <span id="user-name">Usuario</span><span id="verified-badge" class="verified-badge" style="display: none;">Verificado</span></h3>
            <p>Profesi칩n: <span id="user-profesion">N/A</span></p>
            <label for="notificacion-preferencia">Notificarme sobre el cambio de pezoneras:</label>
            <select id="notificacion-preferencia">
                <option value="email">Por Correo Electr칩nico</option>
                <option value="movil">Por Notificaci칩n M칩vil</option>
                <option value="ninguna">No notificar</option>
            </select>
            <button type="button" onclick="guardarPreferenciaNotificacion()">Guardar Preferencia</button>
            <button type="button" onclick="cerrarSesionUsuario()">Cerrar Sesi칩n</button>
        </div>

        <!-- Formulario de la calculadora -->
        <div id="formulario-section">
            <form id="formulario">
                <label for="ordenosDia">Orde침os por D칤a:</label>
                <input type="number" id="ordenosDia" required>

                <label for="puntosOrdeno">Puntos de Orde침o (Inicial):</label>
                <input type="number" id="puntosOrdeno" required>

                <label for="vacas">Vacas Orde침adas (Inicial):</label>
                <input type="number" id="vacas" required>

                <label for="durabilidad">Durabilidad de Pezoneras por Orde침o por Punto:</label>
                <input type="number" id="durabilidad" value="2500" required>

                <label for="fechaInicio">Fecha de Inicio (opcional):</label>
                <input type="date" id="fechaInicio" placeholder="YYYY-MM-DD">

                <label for="diasEspecificos">Calcular para D칤as Espec칤ficos (opcional):</label>
                <input type="number" id="diasEspecificos" placeholder="N칰mero de d칤as">

                <label for="realizarModificacion">쯄odificar Vacas o Puntos?</label>
                <select id="realizarModificacion" onchange="mostrarCamposModificacion()">
                    <option value="no">No</option>
                    <option value="si">S칤</option>
                </select>

                <div id="modificacion-campos" class="modificacion-campos">
                    <label for="fechaCambio">Fecha de Cambio:</label>
                    <input type="date" id="fechaCambio" placeholder="YYYY-MM-DD">

                    <label for="nuevoNumeroVacas">Nuevo N칰mero de Vacas:</label>
                    <input type="number" id="nuevoNumeroVacas" placeholder="Nuevo n칰mero de vacas">

                    <label for="nuevoPuntosOrdeno">Nuevo N칰mero de Puntos:</label>
                    <input type="number" id="nuevoPuntosOrdeno" placeholder="Nuevo n칰mero de puntos">
                </div>

                <button type="button" onclick="calcular()">Calcular</button>
                <button type="button" onclick="limpiarPantalla()">Limpiar</button>
                <button type="button" id="cancelar-modificacion" style="display: none; background: #d32f2f;" onclick="cancelarModificacion()">Cancelar Modificaci칩n</button>
            </form>
            <div id="resultado"></div>
            <button id="guardar-resultado" style="display: none;" onclick="guardarResultado()">Guardar Resultado</button>
            <div id="calculos-registrados">
                <h3>C치lculos Guardados</h3>
                <button id="export-excel-btn" style="display: none;" onclick="exportarCalculosExcel()">Exportar a Excel</button>
                <button id="view-report-btn" style="display: none;" onclick="mostrarReporteGrafico()">Ver Reporte Gr치fico</button>
                <ul id="lista-calculos"></ul>
            </div>
            <!-- Nueva gr치fica para usuarios verificados -->
            <div id="wear-report-section" style="display: none; margin-top: 20px; padding: 15px; background: #f9f9f9; border-radius: 5px;">
                <h3>Desgaste de Pezoneras</h3>
                <canvas id="wear-report-canvas"></canvas>
            </div>
            <div id="report-section">
                <h3>An치lisis de Consumo de Pezoneras</h3>
                <canvas id="report-canvas"></canvas>
            </div>
        </div>

        <!-- Publicidad con Google AdSense -->
        <div id="adsense-section" style="margin-top: 20px; text-align: center; display: none;">
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6163239656988692"></script>
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-6163239656988692"
                 data-ad-slot="YOUR_AD_SLOT_ID"
                 data-ad-format="auto"></ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
            <div class="adsense-fallback">No se pudo cargar el anuncio. Por favor, revisa tu conexi칩n o desactiva el bloqueador de anuncios.</div>
        </div>

        <div id="publicidad-section"></div>

        <!-- Formulario de login para admin -->
        <div id="admin-login" style="display: none; margin-top: 20px;">
            <h3>Iniciar Sesi칩n (Admin)</h3>
            <label for="admin-email">Correo Electr칩nico:</label>
            <input type="email" id="admin-email" placeholder="alfstiven@gmail.com">
            <label for="admin-password">Contrase침a:</label>
            <input type="password" id="admin-password" placeholder="Contrase침a">
            <button type="button" onclick="loginAdmin()">Iniciar Sesi칩n</button>
            <div id="admin-login-loading" class="admin-loading" style="display: none;">Cargando...</div>
        </div>

        <!-- Formulario para admin -->
        <div id="admin-form" style="display: none;">
            <h3>Administrar Configuraci칩n</h3>

            <!-- Gesti칩n del Logo -->
            <h4>Actualizar Logo</h4>
            <label for="logo-source">Fuente del Logo:</label>
            <select id="logo-source" onchange="mostrarCamposLogo()">
                <option value="url">URL</option>
                <option value="upload">Subir desde el dispositivo</option>
            </select>
            <div id="logo-url-section" style="display: block;">
                <label for="logo-url">URL del Logo:</label>
                <input type="text" id="logo-url" placeholder="Ingresa la URL del logo">
            </div>
            <div id="logo-upload-section" style="display: none;">
                <label for="logo-upload">Subir Logo:</label>
                <input type="file" id="logo-upload" accept="image/*">
            </div>
            <button type="button" onclick="guardarLogo()">Guardar Logo</button>

            <!-- Publicidad Principal -->
            <h4>Publicidad Principal (Texto o Imagen)</h4>
            <label for="ad-type">Tipo de Publicidad:</label>
            <select id="ad-type" onchange="mostrarCamposPublicidad()">
                <option value="texto">Texto</option>
                <option value="imagen">Imagen</option>
            </select>
            <div id="ad-texto" style="display: block;">
                <label for="ad-texto-content">Texto de la Publicidad:</label>
                <textarea id="ad-texto-content" placeholder="Escribe el texto de la publicidad"></textarea>
            </div>
            <div id="ad-imagen" style="display: none;">
                <label for="ad-imagen-source">Fuente de la Imagen:</label>
                <select id="ad-imagen-source" onchange="mostrarCamposImagen()">
                    <option value="url">URL</option>
                    <option value="upload">Subir desde el dispositivo</option>
                </select>
                <div id="ad-imagen-url-section" style="display: block;">
                    <label for="ad-imagen-url">URL de la Imagen:</label>
                    <input type="text" id="ad-imagen-url" placeholder="Ingresa la URL de la imagen (opcional)">
                </div>
                <div id="ad-imagen-upload-section" style="display: none;">
                    <label for="ad-imagen-upload">Subir Imagen:</label>
                    <input type="file" id="ad-imagen-upload" accept="image/*">
                </div>
            </div>
            <button type="button" onclick="guardarPublicidad()">Guardar Publicidad Principal</button>

            <!-- Publicidad Secundaria -->
            <h4>Publicidad Secundaria (Imagen con Enlace)</h4>
            <label for="ad-secundaria-source">Fuente de la Imagen:</label>
            <select id="ad-secundaria-source" onchange="mostrarCamposImagenSecundaria()">
                <option value="url">URL</option>
                <option value="upload">Subir desde el dispositivo</option>
            </select>
            <div id="ad-secundaria-url-section" style="display: block;">
                <label for="ad-secundaria-imagen-url">URL de la Imagen:</label>
                <input type="text" id="ad-secundaria-imagen-url" placeholder="Ingresa la URL de la imagen (opcional)">
            </div>
            <div id="ad-secundaria-upload-section" style="display: none;">
                <label for="ad-secundaria-imagen-upload">Subir Imagen:</label>
                <input type="file" id="ad-secundaria-imagen-upload" accept="image/*">
            </div>
            <label for="ad-secundaria-link">Enlace de la Publicidad:</label>
            <input type="text" id="ad-secundaria-link" placeholder="Ingresa el enlace (ej. https://ejemplo.com)">
            <button type="button" onclick="guardarPublicidadSecundaria()">Guardar Publicidad Secundaria</button>

            <!-- Mensaje del Pop-up -->
            <h4>Mensaje del Pop-up</h4>
            <label for="popup-message-content">Mensaje del Pop-up:</label>
            <textarea id="popup-message-content" placeholder="Escribe el mensaje del pop-up"></textarea>
            <button type="button" onclick="guardarPopupMessage()">Guardar Mensaje del Pop-up</button>

            <!-- Prueba de Notificaci칩n -->
            <h4>Probar Notificaci칩n</h4>
            <button type="button" onclick="probarNotificacion()">Enviar Notificaci칩n de Prueba</button>

            <!-- Gesti칩n de usuarios verificados -->
            <h4>Gestionar Usuarios Verificados</h4>
            <label for="user-verification-email">Correo del Usuario:</label>
            <input type="email" id="user-verification-email" placeholder="correo@ejemplo.com">
            <button type="button" onclick="verificarUsuario()">Asignar Insignia de Verificado</button>
            <button type="button" onclick="quitarVerificacionUsuario()">Quitar Insignia de Verificado</button>

            <!-- Lista filtrable de usuarios -->
            <div id="admin-users" style="margin-top: 20px;">
                <h4>Lista de Usuarios</h4>
                <label for="user-filter">Filtrar por estado:</label>
                <select id="user-filter" onchange="filtrarUsuarios()">
                    <option value="todos">Todos</option>
                    <option value="verificados">Verificados</option>
                    <option value="no-verificados">No Verificados</option>
                </select>
                <table style="width: 100%; margin-top: 10px; border-collapse: collapse;">
                    <thead>
                        <tr style="background: #005566; color: #fff;">
                            <th style="padding: 8px; border: 1px solid #ccc;">Correo</th>
                            <th style="padding: 8px; border: 1px solid #ccc;">Estado</th>
                            <th style="padding: 8px; border: 1px solid #ccc;">Fecha Verificaci칩n</th>
                            <th style="padding: 8px; border: 1px solid #ccc;">Fecha Caducidad</th>
                        </tr>
                    </thead>
                    <tbody id="lista-usuarios"></tbody>
                </table>
            </div>

            <!-- Registro de nuevos administradores -->
            <div id="admin-registro">
                <h4>Registrar Nuevo Administrador</h4>
                <label for="admin-nombre">Nombre:</label>
                <input type="text" id="admin-nombre" placeholder="Nombre del administrador">
                <label for="admin-registro-email">Correo Electr칩nico:</label>
                <input type="email" id="admin-registro-email" placeholder="correo@ejemplo.com">
                <label for="admin-registro-password">Contrase침a:</label>
                <input type="password" id="admin-registro-password" placeholder="Contrase침a">
                <button type="button" onclick="registrarAdmin()">Registrar Administrador</button>
            </div>

            <!-- Historial de c치lculos -->
            <div id="admin-calculos">
                <h4>Historial de C치lculos</h4>
                <button type="button" onclick="exportarHistorialExcel()">Exportar a Excel</button>
                <h5>Usuarios con cambio este mes:</h5>
                <ul id="lista-calculos-admin"></ul>
            </div>

            <button type="button" onclick="cerrarSesionAdmin()">Cerrar Sesi칩n</button>
        </div>

        <div id="whatsapp-section">
            <label for="codigoCliente">C칩digo del Cliente:</label>
            <input type="text" id="codigoCliente" placeholder="Ingresa el c칩digo del cliente" required>
            <button type="button" onclick="enviarWhatsApp()">Enviar por WhatsApp</button>
        </div>

        <div id="donaciones-section" style="text-align: center;"></div>

        <div style="margin-top: 20px; text-align: center;">
            <p>쯅ecesitas pezoneras nuevas? <a href="/comprar-pezoneras" target="_blank">Compra aqu칤</a>.</p>
        </div>

        <div class="signature">J.Castle</div>

        <div class="footer-links">
            <a href="/politica-de-privacidad.html" target="_blank">Pol칤tica de Privacidad</a>
        </div>
    </div>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: #005566;
        color: #333;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .container {
        max-width: 700px;
        width: 100%;
        margin: 0 auto;
        background: #fff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: relative;
        box-sizing: border-box;
    }
    .logo {
        display: block;
        margin: 0 auto 20px;
        width: 150px;
    }
    h1 {
        text-align: center;
        color: #005566;
        font-size: 24px;
        margin-bottom: 20px;
    }
    label {
        display: block;
        margin: 10px 0 5px;
        font-weight: bold;
        color: #005566;
    }
    input, select, textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        box-sizing: border-box;
        font-size: 14px;
    }
    input:focus, select:focus, textarea:focus {
        border-color: #005566;
        outline: none;
    }
    button {
        width: 100%;
        padding: 10px;
        background: #005566;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 15px;
        font-size: 14px;
    }
    button:hover {
        background: #003d4a;
    }
    #cancelar-modificacion:hover {
        background: #b71c1c;
    }
    #resultado {
        margin-top: 20px;
        padding: 15px;
        background: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 5px;
    }
    .modificacion-campos {
        display: none;
        background: #f0f0f0;
        padding: 15px;
        border-radius: 5px;
        margin-top: 10px;
    }
    #whatsapp-section, #donaciones-section {
        display: none;
        margin-top: 20px;
    }
    .signature {
        text-align: center;
        margin-top: 20px;
        font-family: 'Dancing Script', cursive;
        font-size: 28px;
        color: #005566;
        font-weight: bold;
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }
    .popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    .popup-content {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        position: relative;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }
    .popup-content h2 {
        color: #005566;
        margin-top: 0;
    }
    .popup-content p, .popup-content ul {
        margin: 10px 0;
    }
    .popup-content ul {
        list-style: none;
        padding: 0;
    }
    .popup-content ul li {
        margin: 5px 0;
    }
    .popup-content a {
        color: #005566;
        text-decoration: underline;
    }
    .close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 24px;
        cursor: pointer;
        color: #333;
    }
    .admin-link {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 12px;
        color: #005566;
        text-decoration: none;
        opacity: 0.5;
    }
    .admin-link:hover {
        opacity: 1;
    }
    #publicidad-section {
        margin-top: 20px;
        padding: 15px;
        background: #f0f0f0;
        border-radius: 5px;
        text-align: center;
        display: none;
    }
    #publicidad-section img {
        max-width: 100%;
        height: auto;
    }
    #donaciones-section {
        margin-top: 20px;
        padding: 15px;
        background: #f0f0f0;
        border-radius: 5px;
        text-align: center;
        display: none;
    }
    #donaciones-section img {
        max-width: 300px;
        height: auto;
        display: block;
        margin: 0 auto;
    }
    #admin-form, #admin-login {
        display: none;
        margin-top: 20px;
    }
    .admin-loading {
        text-align: center;
        color: #005566;
        font-style: italic;
        margin-top: 10px;
    }
    #registro-section, #login-section {
        margin-top: 20px;
        padding: 15px;
        background: #f0f0f0;
        border-radius: 5px;
    }
    #user-section {
        display: none;
        margin-top: 20px;
    }
    #formulario-section {
        display: none;
    }
    .auth-message {
        text-align: center;
        margin-bottom: 20px;
        color: #005566;
    }
    #calculos-registrados {
        margin-top: 20px;
        padding: 15px;
        background: #f0f0f0;
        border-radius: 5px;
    }
    #calculos-registrados ul {
        list-style: none;
        padding: 0;
    }
    #calculos-registrados li {
        padding: 5px 0;
        border-bottom: 1px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .delete-calc-btn {
        background: #d32f2f;
        padding: 5px 10px;
        font-size: 12px;
        width: auto;
    }
    .delete-calc-btn:hover {
        background: #b71c1c;
    }
    #admin-calculos {
        display: none;
        margin-top: 20px;
        padding: 15px;
        background: #f0f0f0;
        border-radius: 5px;
    }
    #admin-calculos ul {
        list-style: none;
        padding: 0;
    }
    #admin-calculos li {
        padding: 5px 0;
        border-bottom: 1px solid #ddd;
    }
    #admin-registro {
        display: none;
        margin-top: 20px;
        padding: 15px;
        background: #f0f0f0;
        border-radius: 5px;
    }
    #calculator-info {
        margin-top: 20px;
        padding: 15px;
        background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    #calculator-info h3 {
        color: #005566;
        font-size: 20px;
        margin-bottom: 10px;
    }
    #calculator-info p {
        color: #333;
        font-size: 14px;
        line-height: 1.5;
    }
    #calculator-info strong {
        color: #d32f2f;
    }
    .verified-badge {
        display: inline-block;
        background: #28a745;
        color: #fff;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        margin-left: 5px;
    }
    #export-excel-btn, #view-report-btn {
        background: #28a745;
        margin-top: 10px;
    }
    #export-excel-btn:hover, #view-report-btn:hover {
        background: #218838;
    }
    #report-section, #wear-report-section {
        display: none;
        margin-top: 20px;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 5px;
    }
    #report-canvas, #wear-report-canvas {
        max-width: 100%;
    }
    .adsense-fallback {
        text-align: center;
        color: #d32f2f;
        font-style: italic;
        margin-top: 10px;
        display: none;
    }
    .footer-links {
        text-align: center;
        margin-top: 20px;
        font-size: 12px;
    }
    .footer-links a {
        color: #005566;
        text-decoration: none;
        margin: 0 10px;
    }
    .footer-links a:hover {
        text-decoration: underline;
    }
    #admin-users table {
        width: 100%;
        border-collapse: collapse;
    }
    #admin-users th, #admin-users td {
        padding: 8px;
        border: 1px solid #ccc;
        text-align: left;
    }
    #admin-users tbody tr:nth-child(even) {
        background: #f9f9f9;
    }
</style>
<script>
// Configuraci칩n de Firebase
const firebaseConfig = {
    apiKey: "AIzaSyDokCTsjDgQ94nu23rXf_HkvLeXpZmJU2c",
    authDomain: "jcalculador-ac481.firebaseapp.com",
    projectId: "jcalculador-ac481",
    storageBucket: "jcalculador-ac481.firebasestorage.app",
    messagingSenderId: "597989051329",
    appId: "1:597989051329:web:33b32c795cf7f51c63bd40",
    measurementId: "G-X4Z78DYMLD"
};

// Inicializar Firebase
let app, auth, db, storage, messaging;
try {
    app = firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.firestore();
    storage = firebase.storage();
    messaging = firebase.messaging();
    console.log("Firebase inicializado correctamente.");
} catch (error) {
    console.error("Error al inicializar Firebase:", error);
    alert("Error al cargar la aplicaci칩n. Por favor, revisa la consola para m치s detalles.");
}

let resultadoTexto = '';
let vacasIniciales = 0;
let puntosOrdenoIniciales = 0;
let totalPezoneras = 0;
let isAdminLoggedIn = false;
let fechaProximoCambio = null;
let currentUser = null;
let adminUser = null;
let isVerifiedUser = false;
let calculosData = [];
let ultimoCalculo = null;

// UID del administrador principal
const ADMIN_UID = 'KBb7nqyZFIMDDFHEGdX31stvp1L2';
const ADMIN_EMAIL = 'alfstiven@gmail.com';

// Inicializar Cookie Consent para AdSense
window.addEventListener("load", function(){
    try {
        window.cookieconsent.initialise({
            "palette": {
                "popup": { "background": "#005566" },
                "button": { "background": "#28a745" }
            },
            "position": "bottom-right",
            "content": {
                "message": "Este sitio utiliza cookies para mostrar anuncios personalizados a trav칠s de Google AdSense. Al continuar navegando, aceptas nuestra pol칤tica de privacidad.",
                "dismiss": "Aceptar",
                "link": "Ver Pol칤tica de Privacidad",
                "href": "/politica-de-privacidad.html"
            },
            onStatusChange: function(status) {
                if (status === 'accept') {
                    const adsenseSection = document.getElementById('adsense-section');
                    if (adsenseSection) {
                        adsenseSection.style.display = isVerifiedUser ? 'none' : 'block';
                    }
                }
            }
        });
        console.log("Cookie Consent inicializado.");
    } catch (error) {
        console.error("Error al inicializar Cookie Consent:", error);
    }
});

// Solicitar permiso para notificaciones
function solicitarPermisoNotificaciones() {
    if (!('Notification' in window)) {
        console.log("Este navegador no soporta notificaciones.");
        return;
    }
    Notification.requestPermission().then(permission => {
        if (permission === 'granted') {
            console.log('Permiso de notificaciones concedido.');
            messaging.getToken({ vapidKey: 'BCaTUfW00kYdZyQ2BqdbR6HeTnAZtpxRWrF3jscJQXz4-3SaDNP2Z-y8EtWMtEu6DeUNekFhZQCQOYqRmEn-9Xg' }).then(token => {
                console.log('Token FCM:', token);
                if (currentUser) {
                    db.collection('users').doc(currentUser.uid).update({
                        fcmToken: token
                    }).catch(error => {
                        console.error('Error al guardar el token FCM:', error);
                    });
                }
            }).catch(error => {
                console.error('Error al obtener el token FCM:', error);
            });
        } else {
            console.log('Permiso de notificaciones denegado.');
        }
    }).catch(error => {
        console.error('Error al solicitar permiso de notificaciones:', error);
    });
}

// Cargar el logo al iniciar
function cargarLogo() {
    try {
        db.collection('config').doc('logo').get()
            .then(doc => {
                if (doc.exists) {
                    const logoUrl = doc.data().url;
                    const logoElement = document.getElementById('app-logo');
                    if (logoElement) {
                        logoElement.src = logoUrl;
                        logoElement.style.display = 'block';
                    }
                } else {
                    document.getElementById('app-logo').style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error al cargar el logo:', error);
                document.getElementById('app-logo').style.display = 'none';
            });
    } catch (error) {
        console.error("Error en cargarLogo:", error);
    }
}

// Mostrar el pop-up y cargar configuraciones al cargar la p치gina
window.onload = function() {
    try {
        const popup = document.getElementById('popup');
        if (popup) {
            popup.style.display = 'flex';
        }
        cargarLogo();
        cargarPublicidad();
        cargarPublicidadSecundaria();
        cargarPopupMessage();

        auth.onAuthStateChanged(user => {
            if (user) {
                if (!user.emailVerified) {
                    alert('Por favor, verifica tu correo electr칩nico para continuar.');
                    auth.signOut();
                    return;
                }
                currentUser = user;
                cargarDatosUsuario(user.uid);
                document.getElementById('registro-section').style.display = 'none';
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('user-section').style.display = 'block';
                document.getElementById('formulario-section').style.display = 'block';
                document.getElementById('auth-message').style.display = 'none';
                solicitarPermisoNotificaciones();
                programarNotificacion(user.uid);
                cargarCalculosGuardados(user.uid);
            } else {
                currentUser = null;
                document.getElementById('registro-section').style.display = 'block';
                document.getElementById('user-section').style.display = 'none';
                document.getElementById('form```
```javascript
formulario-section').style.display = 'none';
                document.getElementById('auth-message').style.display = 'block';
                cargarPublicidad();
                cargarPublicidadSecundaria();
            }
        });
    } catch (error) {
        console.error("Error en window.onload:", error);
    }
};

function cerrarPopup() {
    try {
        const popup = document.getElementById('popup');
        if (popup) {
            popup.style.display = 'none';
        }
    } catch (error) {
        console.error("Error en cerrarPopup:", error);
    }
}

function cerrarUnverifiedPopup() {
    try {
        const popup = document.getElementById('unverified-popup');
        if (popup) {
            popup.style.display = 'none';
        }
    } catch (error) {
        console.error("Error en cerrarUnverifiedPopup:", error);
    }
}

function mostrarCamposModificacion() {
    try {
        const seleccion = document.getElementById('realizarModificacion').value;
        const modificacionCampos = document.getElementById('modificacion-campos');
        const cancelarBtn = document.getElementById('cancelar-modificacion');
        if (modificacionCampos && cancelarBtn) {
            modificacionCampos.style.display = seleccion === 'si' ? 'block' : 'none';
            cancelarBtn.style.display = seleccion === 'si' ? 'block' : 'none';
        }
    } catch (error) {
        console.error("Error en mostrarCamposModificacion:", error);
    }
}

function cancelarModificacion() {
    try {
        document.getElementById('realizarModificacion').value = 'no';
        document.getElementById('fechaCambio').value = '';
        document.getElementById('nuevoNumeroVacas').value = '';
        document.getElementById('nuevoPuntosOrdeno').value = '';
        document.getElementById('modificacion-campos').style.display = 'none';
        document.getElementById('cancelar-modificacion').style.display = 'none';
    } catch (error) {
        console.error("Error en cancelarModificacion:", error);
    }
}

function mostrarCamposProfesion() {
    try {
        const profesion = document.getElementById('profesion').value;
        const empresaSection = document.getElementById('empresa-section');
        const otraProfesionSection = document.getElementById('otra-profesion-section');

        if (empresaSection && otraProfesionSection) {
            empresaSection.style.display = profesion === 'ganadero' ? 'block' : 'none';
            otraProfesionSection.style.display = profesion === 'otro' ? 'block' : 'none';
        }
    } catch (error) {
        console.error("Error en mostrarCamposProfesion:", error);
    }
}

function mostrarLoginAdmin() {
    try {
        const adminLoginSection = document.getElementById('admin-login');
        const adminFormSection = document.getElementById('admin-form');
        const adminLoading = document.getElementById('admin-login-loading');

        document.getElementById('registro-section').style.display = 'none';
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('user-section').style.display = 'none';
        document.getElementById('formulario-section').style.display = 'none';
        document.getElementById('auth-message').style.display = 'none';

        if (adminLoginSection && adminFormSection) {
            adminLoginSection.style.display = 'block';
            adminFormSection.style.display = 'none';
        }

        if (adminLoading) {
            adminLoading.style.display = 'block';
            setTimeout(() => {
                adminLoading.style.display = 'none';
            }, 1000);
        }
    } catch (error) {
        console.error("Error en mostrarLoginAdmin:", error);
    }
}

function calcular() {
    try {
        const ordenosDiaInput = document.getElementById('ordenosDia').value;
        const puntosOrdenoInput = document.getElementById('puntosOrdeno').value;
        const vacasInput = document.getElementById('vacas').value;
        const durabilidadInput = document.getElementById('durabilidad').value;
        const fechaInicioInput = document.getElementById('fechaInicio').value;
        const diasEspecificosInput = document.getElementById('diasEspecificos').value;
        const realizarModificacion = document.getElementById('realizarModificacion').value;
        const fechaCambioInput = document.getElementById('fechaCambio').value;
        const nuevoNumeroVacasInput = document.getElementById('nuevoNumeroVacas').value;
        const nuevoPuntosOrdenoInput = document.getElementById('nuevoPuntosOrdeno').value;

        const ordenosDia = parseInt(ordenosDiaInput) || 0;
        let puntosOrdeno = parseInt(puntosOrdenoInput) || 0;
        const vacas = parseInt(vacasInput) || 0;
        const durabilidad = parseInt(durabilidadInput) || 0;
        const diasEspecificos = parseInt(diasEspecificosInput) || 0;
        const nuevoNumeroVacas = parseInt(nuevoNumeroVacasInput) || 0;
        const nuevoPuntosOrdeno = parseInt(nuevoPuntosOrdenoInput) || 0;

        vacasIniciales = vacas;
        puntosOrdenoIniciales = puntosOrdeno;

        if (ordenosDia <= 0) {
            alert("Por favor, ingresa un n칰mero v치lido de orde침os por d칤a (mayor que 0).");
            return;
        }
        if (puntosOrdeno <= 0) {
            alert("Por favor, ingresa un n칰mero v치lido de puntos de orde침o (mayor que 0).");
            return;
        }
        if (vacas <= 0) {
            alert("Por favor, ingresa un n칰mero v치lido de vacas orde침adas (mayor que 0).");
            return;
        }
        if (durabilidad <= 0) {
            alert("Por favor, ingresa una durabilidad v치lida para las pezoneras (mayor que 0).");
            return;
        }

        let fechaInicio = fechaInicioInput ? new Date(fechaInicioInput) : new Date();
        if (isNaN(fechaInicio.getTime())) {
            alert("Por favor, selecciona una fecha de inicio v치lida.");
            return;
        }

        if (diasEspecificos > 0 && ordenosDia === 0 && puntosOrdeno === 0 && vacas === 0) {
            const fechaDiasEspecificos = new Date(fechaInicio.getTime() + diasEspecificos * 86400000);
            resultadoTexto = `
                Calculadora JCALCULO Cambio de Pezoneras
                Fecha Inicio: ${fechaInicio.toLocaleDateString('es-ES')}
                Fecha para ${diasEspecificos} D칤as: ${fechaDiasEspecificos.toLocaleDateString('es-ES')}
            `;
            mostrarResultados();
            return;
        }

        const orde침osTotalesPorDia = ordenosDia * vacas;
        const orde침osPorPuntoPorDia = orde침osTotalesPorDia / puntosOrdeno;
        const diasDurabilidadInicial = durabilidad / orde침osPorPuntoPorDia;

        const fechaProximoCambioInicial = new Date(fechaInicio);
        fechaProximoCambioInicial.setDate(fechaInicio.getDate() + Math.floor(diasDurabilidadInicial));

        let fechaDiasEspecificos = diasEspecificos > 0 ? `Fecha para ${diasEspecificos} D칤as: ${new Date(fechaInicio.getTime() + diasEspecificos * 86400000).toLocaleDateString('es-ES')}` : '';

        const diasEnMes = 30.42;
        const mesesEquivalentes = Math.round(diasDurabilidadInicial / diasEnMes);

        const pezonerasPorPunto = 4;
        totalPezoneras = puntosOrdeno * pezonerasPorPunto;
        let desgastePezonerasPorDiaInicial = totalPezoneras / diasDurabilidadInicial;

        let durabilidadAjustada = diasDurabilidadInicial;
        let fechaProximoCambioAjustada = fechaProximoCambioInicial;
        let desgastePezonerasPorDiaAjustada = desgastePezonerasPorDiaInicial;
        let mensajeAjuste = '';

        if (realizarModificacion === 'si' && fechaCambioInput && (nuevoNumeroVacas > 0 || nuevoPuntosOrdeno > 0)) {
            const fechaCambio = new Date(fechaCambioInput);
            if (isNaN(fechaCambio.getTime())) {
                alert("Por favor, selecciona una fecha de cambio v치lida.");
                return;
            }

            const diasTranscurridos = Math.floor((fechaCambio - fechaInicio) / (1000 * 60 * 60 * 24));

            if (diasTranscurridos < 0) {
                alert("La fecha de cambio no puede ser anterior a la fecha de inicio.");
                return;
            }

            const orde침osPorPuntoHastaCambio = orde침osPorPuntoPorDia * diasTranscurridos;
            const durabilidadRestante = durabilidad - orde침osPorPuntoHastaCambio;

            if (durabilidadRestante <= 0) {
                mensajeAjuste = `Nota: Las pezoneras ya debieron cambiarse antes de ${fechaCambio.toLocaleDateString('es-ES')}.`;
            } else {
                const vacasAjustadas = nuevoNumeroVacas > 0 ? nuevoNumeroVacas : vacas;
                const puntosOrdenoAjustados = nuevoPuntosOrdeno > 0 ? nuevoPuntosOrdeno : puntosOrdeno;
                totalPezoneras = puntosOrdenoAjustados * pezonerasPorPunto;
                const nuevosOrde침osTotalesPorDia = ordenosDia * vacasAjustadas;
                const nuevosOrde침osPorPuntoPorDia = nuevosOrde침osTotalesPorDia / puntosOrdenoAjustados;
                const diasDurabilidadRestante = durabilidadRestante / nuevosOrde침osPorPuntoPorDia;

                fechaProximoCambioAjustada = new Date(fechaCambio);
                fechaProximoCambioAjustada.setDate(fechaCambio.getDate() + Math.floor(diasDurabilidadRestante));

                durabilidadAjustada = diasTranscurridos + diasDurabilidadRestante;
                desgastePezonerasPorDiaAjustada = totalPezoneras / durabilidadAjustada;

                mensajeAjuste = `
                    Ajuste por Modificaci칩n:
                    Fecha de Cambio: ${fechaCambio.toLocaleDateString('es-ES')}
                    Nuevo N칰mero de Vacas: ${vacasAjustadas}
                    Nuevo N칰mero de Puntos: ${puntosOrdenoAjustados}
                    Durabilidad Ajustada: ${Math.floor(durabilidadAjustada)} d칤as
                    Nueva Fecha de Cambio: ${fechaProximoCambioAjustada.toLocaleDateString('es-ES')}
                    Total Pezoneras: ${totalPezoneras}
                    Desgaste por D칤a: ${desgastePezonerasPorDiaAjustada.toFixed(2)}
                `;
            }
        }

        fechaProximoCambio = realizarModificacion === 'si' ? fechaProximoCambioAjustada : fechaProximoCambioInicial;

        resultadoTexto = isVerifiedUser ? `
            <div style="background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); padding: 15px; border-radius: 5px;">
                <h3 style="color: #005566;">游늵 Reporte Premium JCALCULO</h3>
                <p><strong>Fecha Inicio:</strong> ${fechaInicio.toLocaleDateString('es-ES')}</p>
                <p><strong>Vacas Iniciales:</strong> ${vacasIniciales}</p>
                <p><strong>Puntos Iniciales:</strong> ${puntosOrdenoIniciales}</p>
                <p><strong>Durabilidad Inicial:</strong> ${Math.floor(diasDurabilidadInicial)} d칤as</p>
                <p><strong>游뚿 Pr칩ximo Cambio:</strong> ${fechaProximoCambioInicial.toLocaleDateString('es-ES')}</p>
                <p><strong>Meses Equivalentes:</strong> ${mesesEquivalentes}</p>
                ${fechaDiasEspecificos ? `<p><strong>Fecha Espec칤fica:</strong> ${fechaDiasEspecificos}</p>` : ''}
                <p><strong>Total Pezoneras:</strong> ${totalPezoneras}</p>
                <p><strong>Desgaste Diario:</strong> ${desgastePezonerasPorDiaInicial.toFixed(2)}</p>
                ${mensajeAjuste ? `<p style="color: #d32f2f;"><strong>Ajustes Aplicados:</strong><br>${mensajeAjuste.replace(/\n/g, '<br>')}</p>` : ''}
                <p style="font-style: italic;">Gracias por ser un usuario verificado. 춰Disfruta de una experiencia sin publicidad y reportes avanzados!</p>
            </div>
        ` : `
            Calculadora JCALCULO Cambio de Pezoneras
            Fecha Inicio: ${fechaInicio.toLocaleDateString('es-ES')}
            Vacas Iniciales: ${vacasIniciales}
            Puntos Iniciales: ${puntosOrdenoIniciales}
            Durabilidad Inicial: ${Math.floor(diasDurabilidadInicial)} d칤as
            Pr칩ximo Cambio Inicial: ${fechaProximoCambioInicial.toLocaleDateString('es-ES')}
            Meses Equivalentes: ${mesesEquivalentes}
            ${fechaDiasEspecificos}
            Total Pezoneras Inicial: ${totalPezoneras}
            Desgaste por D칤a Inicial: ${desgastePezonerasPorDiaInicial.toFixed(2)}
            ${mensajeAjuste}
        `;
        ultimoCalculo = {
            fechaInicio: fechaInicio,
            fechaProximoCambio: fechaProximoCambio,
            totalPezoneras: totalPezoneras,
            desgasteDiario: realizarModificacion === 'si' ? desgastePezonerasPorDiaAjustada : desgastePezonerasPorDiaInicial,
            durabilidad: realizarModificacion === 'si' ? durabilidadAjustada : diasDurabilidadInicial
        };
        mostrarResultados();
        if (isVerifiedUser) {
            mostrarGraficoDesgaste();
        } else {
            document.getElementById('unverified-popup').style.display = 'flex';
        }

        if (currentUser) {
            guardarFechaProximoCambio(currentUser.uid, fechaProximoCambio);
        }
    } catch (error) {
        console.error("Error en calcular:", error);
        alert("Error al realizar el c치lculo. Por favor, revisa la consola para m치s detalles.");
    }
}

function mostrarGraficoDesgaste() {
    try {
        if (!ultimoCalculo || !isVerifiedUser) return;

        const ctx = document.getElementById('wear-report-canvas').getContext('2d');
        document.getElementById('wear-report-section').style.display = 'block';

        const dias = Math.floor(ultimoCalculo.durabilidad);
        const labels = Array.from({ length: dias + 1 }, (_, i) => {
            const fecha = new Date(ultimoCalculo.fechaInicio);
            fecha.setDate(fecha.getDate() + i);
            return fecha.toLocaleDateString('es-ES');
        });
        const desgaste = Array.from({ length: dias + 1 }, (_, i) => {
            return Math.max(0, ultimoCalculo.totalPezoneras - (i * ultimoCalculo.desgasteDiario));
        });

        if (window.wearChart) {
            window.wearChart.destroy();
        }

        window.wearChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Pezoneras Restantes',
                    data: desgaste,
                    borderColor: '#d32f2f',
                    backgroundColor: 'rgba(211, 47, 47, 0.2)',
                    fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Fecha'
                        },
                        ticks: {
                            maxTicksLimit: 10
                        }
                    },
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'N칰mero de Pezoneras'
                        }
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Desgaste de Pezoneras a lo largo del Tiempo'
                    }
                }
            }
        });
    } catch (error) {
        console.error("Error en mostrarGraficoDesgaste:", error);
    }
}

function mostrarResultados() {
    try {
        const resultado = document.getElementById('resultado');
        const whatsappSection = document.getElementById('whatsapp-section');
        const guardarResultadoBtn = document.getElementById('guardar-resultado');

        if (resultado && whatsappSection && guardarResultadoBtn) {
            resultado.innerHTML = resultadoTexto.replace(/\n/g, '<br>');
            whatsappSection.style.display = 'block';
            guardarResultadoBtn.style.display = 'block';
        }
    } catch (error) {
        console.error("Error en mostrarResultados:", error);
    }
}

function enviarWhatsApp() {
    try {
        const codigoCliente = document.getElementById('codigoCliente').value.trim();
        if (!codigoCliente) {
            alert("Ingresa el c칩digo del cliente.");
            return;
        }
        const mensajeWhatsApp = `C칩digo del Cliente: ${codigoCliente}\n${resultadoTexto}`;
        const urlWhatsApp = `https://api.whatsapp.com/send?text=${encodeURIComponent(mensajeWhatsApp)}`;
        window.open(urlWhatsApp, '_blank');
    } catch (error) {
        console.error("Error en enviarWhatsApp:", error);
    }
}

function limpiarPantalla() {
    try {
        const durabilidad = document.getElementById('durabilidad').value;
        document.getElementById('formulario').reset();
        document.getElementById('durabilidad').value = durabilidad;
        document.getElementById('modificacion-campos').style.display = 'none';
        document.getElementById('cancelar-modificacion').style.display = 'none';
        document.getElementById('resultado').innerHTML = '';
        document.getElementById('whatsapp-section').style.display = 'none';
        document.getElementById('guardar-resultado').style.display = 'none';
        document.getElementById('codigoCliente').value = '';
        document.getElementById('report-section').style.display = 'none';
        document.getElementById('wear-report-section').style.display = 'none';
        resultadoTexto = '';
        vacasIniciales = 0;
        puntosOrdenoIniciales = 0;
        totalPezoneras = 0;
        fechaProximoCambio = null;
        ultimoCalculo = null;
        if (window.wearChart) {
            window.wearChart.destroy();
        }
    } catch (error) {
        console.error("Error en limpiarPantalla:", error);
    }
}

function guardarResultado() {
    try {
        if (!currentUser) {
            alert('Debes estar autenticado para guardar el resultado.');
            return;
        }

        const calculo = {
            resultado: resultadoTexto,
            fechaProximoCambio: fechaProximoCambio ? fechaProximoCambio.toISOString() : null,
            vacas: vacasIniciales,
            puntos: puntosOrdenoIniciales,
            pezoneras: totalPezoneras,
            timestamp: new Date().toISOString(),
            fechaInicio: ultimoCalculo ? ultimoCalculo.fechaInicio.toISOString() : null,
            desgasteDiario: ultimoCalculo ? ultimoCalculo.desgasteDiario : 0,
            durabilidad: ultimoCalculo ? ultimoCalculo.durabilidad : 0
        };

        const userCalcsRef = db.collection('calculos').doc(currentUser.uid).collection('registros');

        userCalcsRef.orderBy('timestamp', 'asc').get()
            .then(snapshot => {
                const calculos = snapshot.docs;
                if (calculos.length >= 10) {
                    const oldestCalculo = calculos[0];
                    userCalcsRef.doc(oldestCalculo.id).delete();
                }
                return userCalcsRef.add(calculo);
            })
            .then(() => {
                alert('Resultado guardado correctamente.');
                cargarCalculosGuardados(currentUser.uid);
            })
            .catch(error => {
                console.error('Error al guardar el resultado:', error);
                alert('Error al guardar el resultado: ' + error.message);
            });
    } catch (error) {
        console.error("Error en guardarResultado:", error);
    }
}

function eliminarCalculo(calcId) {
    try {
        if (!currentUser || !isVerifiedUser) {
            alert('Debes ser un usuario verificado para eliminar c치lculos.');
            return;
        }
        if (confirm('쮼st치s seguro de que deseas eliminar este c치lculo?')) {
            db.collection('calculos').doc(currentUser.uid).collection('registros').doc(calcId)
                .delete()
                .then(() => {
                    alert('C치lculo eliminado correctamente.');
                    cargarCalculosGuardados(currentUser.uid);
                })
                .catch(error => {
                    console.error('Error al eliminar c치lculo:', error);
                    alert('Error al eliminar c치lculo: ' + error.message);
                });
        }
    } catch (error) {
        console.error("Error en eliminarCalculo:", error);
    }
}

function cargarCalculosGuardados(uid) {
    try {
        const listaCalculos = document.getElementById('lista-calculos');
        listaCalculos.innerHTML = '';
        calculosData = [];

        db.collection('calculos').doc(uid).collection('registros')
            .orderBy('timestamp', 'desc')
            .get()
            .then(snapshot => {
                snapshot.forEach(doc => {
                    const calc = doc.data();
                    const calcId = doc.id;
                    calculosData.push({
                        id: calcId,
                        fecha: new Date(calc.timestamp).toLocaleString('es-ES'),
                        resultado: calc.resultado,
                        pezoneras: calc.pezoneras,
                        vacas: calc.vacas,
                        puntos: calc.puntos,
                        fechaCambio: calc.fechaProximoCambio ? new Date(calc.fechaProximoCambio).toLocaleDateString('es-ES') : 'N/A',
                        fechaInicio: calc.fechaInicio ? new Date(calc.fechaInicio) : null,
                        desgasteDiario: calc.desgasteDiario || 0,
                        durabilidad: calc.durabilidad || 0
                    });
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <div>
                            <strong>Fecha:</strong> ${new Date(calc.timestamp).toLocaleString('es-ES')}<br>
                            ${calc.resultado.replace(/\n/g, '<br>')}
                        </div>
                        ${isVerifiedUser ? `<button class="delete-calc-btn" onclick="eliminarCalculo('${calcId}')">Eliminar</button>` : ''}
                    `;
                    listaCalculos.appendChild(li);
                });
                if (isVerifiedUser && calculosData.length > 0) {
                    ultimoCalculo = calculosData[0];
                    mostrarGraficoDesgaste();
                }
            }).catch(error => {
                console.error('Error al cargar c치lculos guardados:', error);
            });
    } catch (error) {
        console.error("Error en cargarCalculosGuardados:", error);
    }
}
function exportarCalculosExcel() {
    try {
        const data = calculosData.map(calc => ({
            Fecha: calc.fecha,
            'Vacas Iniciales': calc.vacas,
            'Puntos Iniciales': calc.puntos,
            'Pezoneras Totales': calc.pezoneras,
            'Fecha Pr칩ximo Cambio': calc.fechaCambio
        }));

        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'C치lculos');
        XLSX.writeFile(wb, 'CalculosPezoneras.xlsx');
    } catch (error) {
        console.error("Error en exportarCalculosExcel:", error);
    }
}

function mostrarReporteGrafico() {
    try {
        const ctx = document.getElementById('report-canvas').getContext('2d');
        document.getElementById('report-section').style.display = 'block';

        const labels = calculosData.map(calc => calc.fecha);
        const pezoneras = calculosData.map(calc => calc.pezoneras);
        const vacas = calculosData.map(calc => calc.vacas);

        if (window.myChart) {
            window.myChart.destroy();
        }

        window.myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Pezoneras Totales',
                        data: pezoneras,
                        borderColor: '#005566',
                        backgroundColor: 'rgba(0, 85, 102, 0.2)',
                        fill: true
                    },
                    {
                        label: 'Vacas Orde침adas',
                        data: vacas,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.2)',
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Consumo de Pezoneras y Vacas a lo largo del Tiempo'
                    }
                }
            }
        });
    } catch (error) {
        console.error("Error en mostrarReporteGrafico:", error);
    }
}

function cargarHistorialAdmin() {
    try {
        const listaCalculosAdmin = document.getElementById('lista-calculos-admin');
        listaCalculosAdmin.innerHTML = '';

        const hoy = new Date();
        const mesActual = hoy.getMonth();
        const a침oActual = hoy.getFullYear();

        db.collection('users').get()
            .then(userSnapshot => {
                const promesas = [];
                userSnapshot.forEach(userDoc => {
                    const userId = userDoc.id;
                    const userData = userDoc.data();
                    const email = userData.email;

                    const promesa = db.collection('calculos').doc(userId).collection('registros')
                        .orderBy('timestamp', 'desc')
                        .get()
                        .then(snapshot => {
                            snapshot.forEach(doc => {
                                const calc = doc.data();
                                if (calc.fechaProximoCambio) {
                                    const fechaCambio = new Date(calc.fechaProximoCambio);
                                    if (fechaCambio.getMonth() === mesActual && fechaCambio.getFullYear() === a침oActual) {
                                        const li = document.createElement('li');
                                        li.innerHTML = `
                                            Correo: ${email} | 
                                            Fecha de Cambio: ${fechaCambio.toLocaleDateString('es-ES')} | 
                                            Puntos: ${calc.puntos} | 
                                            Pezoneras: ${calc.pezoneras}
                                        `;
                                        listaCalculosAdmin.appendChild(li);
                                    }
                                }
                            });
                        })
                        .catch(error => {
                            console.error(`Error al cargar c치lculos de ${email}:`, error);
                        });
                    promesas.push(promesa);
                });
                return Promise.all(promesas);
            })
            .catch(error => {
                console.error('Error al cargar historial de usuarios:', error);
                listaCalculosAdmin.innerHTML = '<li>Error al cargar el historial.</li>';
            });
    } catch (error) {
        console.error("Error en cargarHistorialAdmin:", error);
}
function cargarUsuariosAdmin() {
    try {
        const listaUsuarios = document.getElementById('lista-usuarios');
        listaUsuarios.innerHTML = '';

        db.collection('users').get()
            .then(snapshot => {
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const tr = document.createElement('tr');
                    const verificationDate = user.verificationDate ? new Date(user.verificationDate).toLocaleDateString('es-ES') : 'N/A';
                    const expirationDate = user.expirationDate ? new Date(user.expirationDate).toLocaleDateString('es-ES') : 'N/A';
                    tr.innerHTML = `
                        <td>${user.email}</td>
                        <td>${user.isVerified ? 'Verificado' : 'No Verificado'}</td>
                        <td>${verificationDate}</td>
                        <td>${expirationDate}</td>
                    `;
                    listaUsuarios.appendChild(tr);
                });
            })
            .catch(error => {
                console.error('Error al cargar usuarios:', error);
                listaUsuarios.innerHTML = '<tr><td colspan="4">Error al cargar usuarios.</td></tr>';
            });
    } catch (error) {
        console.error("Error en cargarUsuariosAdmin:", error);
    }
}

function filtrarUsuarios() {
    try {
        const filtro = document.getElementById('user-filter').value;
        const listaUsuarios = document.getElementById('lista-usuarios');
        listaUsuarios.innerHTML = '';

        let query = db.collection('users');
        if (filtro === 'verificados') {
            query = query.where('isVerified', '==', true);
        } else if (filtro === 'no-verificados') {
            query = query.where('isVerified', '==', false);
        }

        query.get()
            .then(snapshot => {
                snapshot.forEach(doc => {
                    const user = doc.data();
                    const tr = document.createElement('tr');
                    const verificationDate = user.verificationDate ? new Date(user.verificationDate).toLocaleDateString('es-ES') : 'N/A';
                    const expirationDate = user.expirationDate ? new Date(user.expirationDate).toLocaleDateString('es-ES') : 'N/A';
                    tr.innerHTML = `
                        <td>${user.email}</td>
                        <td>${user.isVerified ? 'Verificado' : 'No Verificado'}</td>
                        <td>${verificationDate}</td>
                        <td>${expirationDate}</td>
                    `;
                    listaUsuarios.appendChild(tr);
                });
                if (snapshot.empty) {
                    listaUsuarios.innerHTML = '<tr><td colspan="4">No hay usuarios en esta categor칤a.</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error al filtrar usuarios:', error);
                listaUsuarios.innerHTML = '<tr><td colspan="4">Error al filtrar usuarios.</td></tr>';
            });
    } catch (error) {
        console.error("Error en filtrarUsuarios:", error);
    }
}

function exportarHistorialExcel() {
    try {
        const hoy = new Date();
        const mesActual = hoy.getMonth();
        const a침oActual = hoy.getFullYear();
        const historialData = [];

        db.collection('users').get()
            .then(userSnapshot => {
                const promesas = [];
                userSnapshot.forEach(userDoc => {
                    const userId = userDoc.id;
                    const userData = userDoc.data();
                    const email = userData.email;

                    const promesa = db.collection('calculos').doc(userId).collection('registros')
                        .orderBy('timestamp', 'desc')
                        .get()
                        .then(snapshot => {
                            snapshot.forEach(doc => {
                                const calc = doc.data();
                                if (calc.fechaProximoCambio) {
                                    const fechaCambio = new Date(calc.fechaProximoCambio);
                                    if (fechaCambio.getMonth() === mesActual && fechaCambio.getFullYear() === a침oActual) {
                                        historialData.push({
                                            Email: email,
                                            'Fecha Cambio': fechaCambio.toLocaleDateString('es-ES'),
                                            'Vacas': calc.vacas,
                                            'Puntos': calc.puntos,
                                            'Pezoneras': calc.pezoneras
                                        });
                                    }
                                }
                            });
                        })
                        .catch(error => {
                            console.error(`Error al cargar c치lculos de ${email}:`, error);
                        });
                    promesas.push(promesa);
                });
                return Promise.all(promesas);
            })
            .then(() => {
                if (historialData.length === 0) {
                    alert('No hay c치lculos para exportar en el mes actual.');
                    return;
                }
                const ws = XLSX.utils.json_to_sheet(historialData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Historial');
                XLSX.writeFile(wb, `HistorialCalculos_${a침oActual}_${mesActual + 1}.xlsx`);
            })
            .catch(error => {
                console.error('Error al exportar historial:', error);
                alert('Error al exportar historial: ' + error.message);
            });
    } catch (error) {
        console.error("Error en exportarHistorialExcel:", error);
    }
}

function registrarUsuario() {
    try {
        const nombre = document.getElementById('nombre').value.trim();
        const profesion = document.getElementById('profesion').value;
        const empresa = document.getElementById('empresa').value.trim();
        const otraProfesion = document.getElementById('otra-profesion').value.trim();
        const telefono = document.getElementById('telefono').value.trim();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;

        if (!nombre || !profesion || !telefono || !email || !password) {
            alert('Por favor, completa todos los campos obligatorios.');
            return;
        }
        if (profesion === 'ganadero' && !empresa) {
            alert('Por favor, ingresa el nombre de la granja o explotaci칩n.');
            return;
        }
        if (profesion === 'otro' && !otraProfesion) {
            alert('Por favor, especifica tu profesi칩n.');
            return;
        }

        auth.createUserWithEmailAndPassword(email, password)
            .then(userCredential => {
                const user = userCredential.user;
                user.sendEmailVerification()
                    .then(() => {
                        alert('Se ha enviado un correo de verificaci칩n. Por favor, verifica tu correo electr칩nico.');
                    })
                    .catch(error => {
                        console.error('Error al enviar correo de verificaci칩n:', error);
                        alert('Error al enviar correo de verificaci칩n: ' + error.message);
                    });

                const userData = {
                    nombre,
                    profesion,
                    empresa: profesion === 'ganadero' ? empresa : '',
                    otraProfesion: profesion === 'otro' ? otraProfesion : '',
                    telefono,
                    email,
                    isVerified: false,
                    verificationDate: null,
                    expirationDate: null,
                    createdAt: new Date().toISOString(),
                    fcmToken: ''
                };

                db.collection('users').doc(user.uid).set(userData)
                    .then(() => {
                        console.log('Usuario registrado en Firestore:', user.uid);
                        document.getElementById('registro-section').style.display = 'none';
                        document.getElementById('login-section').style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error al guardar datos del usuario:', error);
                        alert('Error al guardar datos del usuario: ' + error.message);
                    });
            })
            .catch(error => {
                console.error('Error al registrar usuario:', error);
                alert('Error al registrar usuario: ' + error.message);
            });
    } catch (error) {
        console.error("Error en registrarUsuario:", error);
    }
}

function loginUsuario() {
    try {
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;

        auth.signInWithEmailAndPassword(email, password)
            .then(userCredential => {
                const user = userCredential.user;
                if (!user.emailVerified) {
                    alert('Por favor, verifica tu correo electr칩nico antes de iniciar sesi칩n.');
                    auth.signOut();
                    return;
                }
                console.log('Usuario logueado:', user.uid);
            })
            .catch(error => {
                console.error('Error al iniciar sesi칩n:', error);
                alert('Error al iniciar sesi칩n: ' + error.message);
            });
    } catch (error) {
        console.error("Error en loginUsuario:", error);
    }
}

function recuperarContrasena() {
    try {
        const email = prompt('Ingresa tu correo electr칩nico para recuperar la contrase침a:');
        if (email) {
            auth.sendPasswordResetEmail(email)
                .then(() => {
                    alert('Se ha enviado un correo para restablecer tu contrase침a.');
                })
                .catch(error => {
                    console.error('Error al enviar correo de recuperaci칩n:', error);
                    alert('Error al enviar correo de recuperaci칩n: ' + error.message);
                });
        }
    } catch (error) {
        console.error("Error en recuperarContrasena:", error);
    }
}

function cerrarSesionUsuario() {
    try {
        auth.signOut()
            .then(() => {
                console.log('Sesi칩n de usuario cerrada.');
                document.getElementById('user-section').style.display = 'none';
                document.getElementById('formulario-section').style.display = 'none';
                document.getElementById('registro-section').style.display = 'block';
                document.getElementById('auth-message').style.display = 'block';
                document.getElementById('adsense-section').style.display = 'block';
                document.getElementById('wear-report-section').style.display = 'none';
                currentUser = null;
                isVerifiedUser = false;
                ultimoCalculo = null;
                if (window.wearChart) {
                    window.wearChart.destroy();
                }
            })
            .catch(error => {
                console.error('Error al cerrar sesi칩n:', error);
                alert('Error al cerrar sesi칩n: ' + error.message);
            });
    } catch (error) {
        console.error("Error en cerrarSesionUsuario:", error);
    }
}

function guardarPreferenciaNotificacion() {
    try {
        if (!currentUser) {
            alert('Debes estar autenticado para guardar preferencias.');
            return;
        }
        const preferencia = document.getElementById('notificacion-preferencia').value;
        db.collection('users').doc(currentUser.uid).update({
            notificacionPreferencia: preferencia
        })
            .then(() => {
                alert('Preferencia de notificaci칩n guardada correctamente.');
            })
            .catch(error => {
                console.error('Error al guardar preferencia:', error);
                alert('Error al guardar preferencia: ' + error.message);
            });
    } catch (error) {
        console.error("Error en guardarPreferenciaNotificacion:", error);
    }
}

function cargarDatosUsuario(uid) {
    try {
        db.collection('users').doc(uid).get()
            .then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('user-name').textContent = data.nombre || 'Usuario';
                    document.getElementById('user-profesion').textContent = data.profesion || 'N/A';
                    document.getElementById('notificacion-preferencia').value = data.notificacionPreferencia || 'ninguna';
                    isVerifiedUser = data.isVerified || false;
                    document.getElementById('verified-badge').style.display = isVerifiedUser ? 'inline-block' : 'none';
                    document.getElementById('adsense-section').style.display = isVerifiedUser ? 'none' : 'block';
                    document.getElementById('export-excel-btn').style.display = isVerifiedUser ? 'block' : 'none';
                    document.getElementById('view-report-btn').style.display = isVerifiedUser ? 'block' : 'none';
                    if (isVerifiedUser && calculosData.length > 0) {
                        ultimoCalculo = calculosData[0];
                        mostrarGraficoDesgaste();
                    }
                }
            })
            .catch(error => {
                console.error('Error al cargar datos del usuario:', error);
            });
    } catch (error) {
        console.error("Error en cargarDatosUsuario:", error);
    }
}

function loginAdmin() {
    try {
        const email = document.getElementById('admin-email').value.trim();
        const password = document.getElementById('admin-password').value;

        auth.signInWithEmailAndPassword(email, password)
            .then(userCredential => {
                const user = userCredential.user;
                if (user.uid === ADMIN_UID || email === ADMIN_EMAIL) {
                    isAdminLoggedIn = true;
                    adminUser = user;
                    document.getElementById('admin-login').style.display = 'none';
                    document.getElementById('admin-form').style.display = 'block';
                    document.getElementById('admin-registro').style.display = 'block';
                    document.getElementById('admin-calculos').style.display = 'block';
                    cargarHistorialAdmin();
                    cargarUsuariosAdmin();
                } else {
                    alert('No tienes permisos de administrador.');
                    auth.signOut();
                }
            })
            .catch(error => {
                console.error('Error al iniciar sesi칩n como admin:', error);
                alert('Error al iniciar sesi칩n como admin: ' + error.message);
            });
    } catch (error) {
        console.error("Error en loginAdmin:", error);
    }
}

function cerrarSesionAdmin() {
    try {
        auth.signOut()
            .then(() => {
                console.log('Sesi칩n de admin cerrada.');
                isAdminLoggedIn = false;
                adminUser = null;
                document.getElementById('admin-form').style.display = 'none';
                document.getElementById('admin-registro').style.display = 'none';
                document.getElementById('admin-calculos').style.display = 'none';
                document.getElementById('admin-login').style.display = 'block';
                document.getElementById('registro-section').style.display = 'block';
            })
            .catch(error => {
                console.error('Error al cerrar sesi칩n de admin:', error);
                alert('Error al cerrar sesi칩n de admin: ' + error.message);
            });
    } catch (error) {
        console.error("Error en cerrarSesionAdmin:", error);
    }
}

function registrarAdmin() {
    try {
        if (!isAdminLoggedIn || !adminUser) {
            alert('Debes ser administrador para registrar nuevos administradores.');
            return;
        }
        const nombre = document.getElementById('admin-nombre').value.trim();
        const email = document.getElementById('admin-registro-email').value.trim();
        const password = document.getElementById('admin-registro-password').value;

        if (!nombre || !email || !password) {
            alert('Por favor, completa todos los campos.');
            return;
        }

        auth.createUserWithEmailAndPassword(email, password)
            .then(userCredential => {
                const user = userCredential.user;
                user.sendEmailVerification()
                    .then(() => {
                        alert('Se ha enviado un correo de verificaci칩n al nuevo administrador.');
                    })
                    .catch(error => {
                        console.error('Error al enviar correo de verificaci칩n:', error);
                    });

                const adminData = {
                    nombre,
                    email,
                    isAdmin: true,
                    createdAt: new Date().toISOString()
                };

                db.collection('admins').doc(user.uid).set(adminData)
                    .then(() => {
                        alert('Administrador registrado correctamente.');
                        document.getElementById('admin-nombre').value = '';
                        document.getElementById('admin-registro-email').value = '';
                        document.getElementById('admin-registro-password').value = '';
                    })
                    .catch(error => {
                        console.error('Error al guardar datos del administrador:', error);
                        alert('Error al guardar datos del administrador: ' + error.message);
                    });
            })
            .catch(error => {
                console.error('Error al registrar administrador:', error);
                alert('Error al registrar administrador: ' + error.message);
            });
    } catch (error) {
        console.error("Error en registrarAdmin:", error);
    }
}

function verificarUsuario() {
    try {
        if (!isAdminLoggedIn) {
            alert('Debes ser administrador para verificar usuarios.');
            return;
        }
        const email = document.getElementById('user-verification-email').value.trim();
        if (!email) {
            alert('Por favor, ingresa el correo del usuario.');
            return;
        }

        db.collection('users').where('email', '==', email).get()
            .then(snapshot => {
                if (snapshot.empty) {
                    alert('No se encontr칩 un usuario con ese correo.');
                    return;
                }
                snapshot.forEach(doc => {
                    const expirationDate = new Date();
                    expirationDate.setFullYear(expirationDate.getFullYear() + 1);
                    db.collection('users').doc(doc.id).update({
                        isVerified: true,
                        verificationDate: new Date().toISOString(),
                        expirationDate: expirationDate.toISOString()
                    })
                        .then(() => {
                            alert(`Usuario ${email} verificado correctamente.`);
                            document.getElementById('user-verification-email').value = '';
                            cargarUsuariosAdmin();
                        })
                        .catch(error => {
                            console.error('Error al verificar usuario:', error);
                            alert('Error al verificar usuario: ' + error.message);
                        });
                });
            })
            .catch(error => {
                console.error('Error al buscar usuario:', error);
                alert('Error al buscar usuario: ' + error.message);
            });
    } catch (error) {
        console.error("Error en verificarUsuario:", error);
    }
}

function quitarVerificacionUsuario() {
    try {
        if (!isAdminLoggedIn) {
            alert('Debes ser administrador para quitar verificaciones.');
            return;
        }
        const email = document.getElementById('user-verification-email').value.trim();
        if (!email) {
            alert('Por favor, ingresa el correo del usuario.');
            return;
        }

        db.collection('users').where('email', '==', email).get()
            .then(snapshot => {
                if (snapshot.empty) {
                    alert('No se encontr칩 un usuario con ese correo.');
                    return;
                }
                snapshot.forEach(doc => {
                    db.collection('users').doc(doc.id).update({
                        isVerified: false,
                        verificationDate: null,
                        expirationDate: null
                    })
                        .then(() => {
                            alert(`Se ha quitado la verificaci칩n del usuario ${email}.`);
                            document.getElementById('user-verification-email').value = '';
                            cargarUsuariosAdmin();
                        })
                        .catch(error => {
                            console.error('Error al quitar verificaci칩n:', error);
                            alert('Error al quitar verificaci칩n: ' + error.message);
                        });
                });
            })
            .catch(error => {
                console.error('Error al buscar usuario:', error);
                alert('Error al buscar usuario: ' + error.message);
            });
    } catch (error) {
        console.error("Error en quitarVerificacionUsuario:", error);
    }
}

function guardarLogo() {
    try {
        if (!isAdminLoggedIn) {
            alert('Debes ser administrador para actualizar el logo.');
            return;
        }
        const logoSource = document.getElementById('logo-source').value;
        if (logoSource === 'url') {
            const logoUrl = document.getElementById('logo-url').value.trim();
            if (!logoUrl) {
                alert('Por favor, ingresa una URL v치lida para el logo.');
                return;
            }
            db.collection('config').doc('logo').set({ url: logoUrl })
                .then(() => {
                    alert('Logo actualizado correctamente.');
                    cargarLogo();
                })
                .catch(error => {
                    console.error('Error al guardar logo:', error);
                    alert('Error al guardar logo: ' + error.message);
                });
        } else {
            const logoFile = document.getElementById('logo-upload').files[0];
            if (!logoFile) {
                alert('Por favor, selecciona un archivo para el logo.');
                return;
            }
            const storageRef = storage.ref(`logos/${logoFile.name}`);
            storageRef.put(logoFile)
                .then(snapshot => snapshot.ref.getDownloadURL())
                .then(url => {
                    db.collection('config').doc('logo').set({ url })
                        .then(() => {
                            alert('Logo subido correctamente.');
                            cargarLogo();
                        })
                        .catch(error => {
                            console.error('Error al guardar logo:', error);
                            alert('Error al guardar logo: ' + error.message);
                        });
                })
                .catch(error => {
                    console.error('Error al subir logo:', error);
                    alert('Error al subir logo: ' + error.message);
                });
        }
    } catch (error) {
        console.error("Error en guardarLogo:", error);
    }
}

function cargarPublicidad() {
    try {
        db.collection('config').doc('publicidad').get()
            .then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    const publicidadSection = document.getElementById('publicidad-section');
                    if (data.tipo === 'texto') {
                        publicidadSection.innerHTML = `<p>${data.contenido}</p>`;
                    } else if (data.tipo === 'imagen') {
                        publicidadSection.innerHTML = `<img src="${data.url}" alt="Publicidad" style="max-width: 100%; height: auto;">`;
                    }
                    publicidadSection.style.display = isVerifiedUser ? 'none' : 'block';
                }
            })
            .catch(error => {
                console.error('Error al cargar publicidad:', error);
            });
    } catch (error) {
        console.error("Error en cargarPublicidad:", error);
    }
}

function guardarPublicidad() {
    try {
        if (!isAdminLoggedIn) {
            alert('Debes ser administrador para actualizar la publicidad.');
            return;
        }
        const adType = document.getElementById('ad-type').value;
        if (adType === 'texto') {
            const contenido = document.getElementById('ad-texto-content').value.trim();
            if (!contenido) {
                alert('Por favor, ingresa el texto de la publicidad.');
                return;
            }
            db.collection('config').doc('publicidad').set({
                tipo: 'texto',
                contenido
            })
                .then(() => {
                    alert('Publicidad actualizada correctamente.');
                    cargarPublicidad();
                })
                .catch(error => {
                    console.error('Error al guardar publicidad:', error);
                    alert('Error al guardar publicidad: ' + error.message);
                });
        } else {
            const adImagenSource = document.getElementById('ad-imagen-source').value;
            if (adImagenSource === 'url') {
                const url = document.getElementById('ad-imagen-url').value.trim();
                if (!url) {
                    alert('Por favor, ingresa una URL v치lida para la imagen.');
                    return;
                }
                db.collection('config').doc('publicidad').set({
                    tipo: 'imagen',
                    url
                })
                    .then(() => {
                        alert('Publicidad actualizada correctamente.');
                        cargarPublicidad();
                    })
                    .catch(error => {
                        console.error('Error al guardar publicidad:', error);
                        alert('Error al guardar publicidad: ' + error.message);
                    });
            } else {
                const adFile = document.getElementById('ad-imagen-upload').files[0];
                if (!adFile) {
                    alert('Por favor, selecciona un archivo para la publicidad.');
                    return;
                }
                const storageRef = storage.ref(`publicidad/${adFile.name}`);
                storageRef.put(adFile)
                    .then(snapshot => snapshot.ref.getDownloadURL())
                    .then(url => {
                        db.collection('config').doc('publicidad').set({
                            tipo: 'imagen',
                            url
                        })
                            .then(() => {
                                alert('Publicidad subida correctamente.');
                                cargarPublicidad();
                            })
                            .catch(error => {
                                console.error('Error al guardar publicidad:', error);
                                alert('Error al guardar publicidad: ' + error.message);
                            });
                    })
                    .catch(error => {
                        console.error('Error al subir publicidad:', error);
                        alert('Error al subir publicidad: ' + error.message);
                    });
            }
        }
    } catch (error) {
        console.error("Error en guardarPublicidad:", error);
    }
}

function cargarPublicidadSecundaria() {
    try {
        db.collection('config').doc('publicidadSecundaria').get()
            .then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    const donacionesSection = document.getElementById('donaciones-section');
                    donacionesSection.innerHTML = `
                        <a href="${data.link}" target="_blank">
                            <img src="${data.url}" alt="Publicidad Secundaria">
                        </a>
                    `;
                    donacionesSection.style.display = isVerifiedUser ? 'none' : 'block';
                }
            })
            .catch(error => {
                console.error('Error al cargar publicidad secundaria:', error);
            });
    } catch (error) {
        console.error("Error en cargarPublicidadSecundaria:", error);
    }
}

function guardarPublicidadSecundaria() {
    try {
        if (!isAdminLoggedIn) {
            alert('Debes ser administrador para actualizar la publicidad secundaria.');
            return;
        }
        const adSecundariaSource = document.getElementById('ad-secundaria-source').value;
        const link = document.getElementById('ad-secundaria-link').value.trim();
        if (!link) {
            alert('Por favor, ingresa un enlace v치lido para la publicidad secundaria.');
            return;
        }
        if (adSecundariaSource === 'url') {
            const url = document.getElementById('ad-secundaria-imagen-url').value.trim();
            if (!url) {
                alert('Por favor, ingresa una URL v치lida para la imagen.');
                return;
            }
            db.collection('config').doc('publicidadSecundaria').set({
                url,
                link
            })
                .then(() => {
                    alert('Publicidad secundaria actualizada correctamente.');
                    cargarPublicidadSecundaria();
                })
                .catch(error => {
                    console.error('Error al guardar publicidad secundaria:', error);
                    alert('Error al guardar publicidad secundaria: ' + error.message);
                });
        } else {
            const adFile = document.getElementById('ad-secundaria-imagen-upload').files[0];
            if (!adFile) {
                alert('Por favor, selecciona un archivo para la publicidad secundaria.');
                return;
            }
            const storageRef = storage.ref(`publicidadSecundaria/${adFile.name}`);
            storageRef.put(adFile)
                .then(snapshot => snapshot.ref.getDownloadURL())
                .then(url => {
                    db.collection('config').doc('publicidadSecundaria').set({
                        url,
                        link
                    })
                        .then(() => {
                            alert('Publicidad secundaria subida correctamente.');
                            cargarPublicidadSecundaria();
                        })
                        .catch(error => {
                            console.error('Error al guardar publicidad secundaria:', error);
                            alert('Error al guardar publicidad secundaria: ' + error.message);
                        });
                })
                .catch(error => {
                    console.error('Error al subir publicidad secundaria:', error);
                    alert('Error al subir publicidad secundaria: ' + error.message);
                });
        }
    } catch (error) {
        console.error("Error en guardarPublicidadSecundaria:", error);
    }
}

function mostrarCamposLogo() {
    try {
        const logoSource = document.getElementById('logo-source').value;
        document.getElementById('logo-url-section').style.display = logoSource === 'url' ? 'block' : 'none';
        document.getElementById('logo-upload-section').style.display = logoSource === 'upload' ? 'block' : 'none';
    } catch (error) {
        console.error("Error en mostrarCamposLogo:", error);
    }
}

function mostrarCamposPublicidad() {
    try {
        const adType = document.getElementById('ad-type').value;
        document.getElementById('ad-texto').style.display = adType === 'texto' ? 'block' : 'none';
        document.getElementById('ad-imagen').style.display = adType === 'imagen' ? 'block' : 'none';
    } catch (error) {
        console.error("Error en mostrarCamposPublicidad:", error);
    }
}

function mostrarCamposImagen() {
    try {
        const adImagenSource = document.getElementById('ad-imagen-source').value;
        document.getElementById('ad-imagen-url-section').style.display = adImagenSource === 'url' ? 'block' : 'none';
        document.getElementById('ad-imagen-upload-section').style.display = adImagenSource === 'upload' ? 'block' : 'none';
    } catch (error) {
        console.error("Error en mostrarCamposImagen:", error);
    }
}

function mostrarCamposImagenSecundaria() {
    try {
        const adSecundariaSource = document.getElementById('ad-secundaria-source').value;
        document.getElementById('ad-secundaria-url-section').style.display = adSecundariaSource === 'url' ? 'block' : 'none';
        document.getElementById('ad-secundaria-upload-section').style.display = adSecundariaSource === 'upload' ? 'block' : 'none';
    } catch (error) {
        console.error("Error en mostrarCamposImagenSecundaria:", error);
    }
}

function cargarPopupMessage() {
    try {
        db.collection('config').doc('popup').get()
            .then(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById('popup-title').textContent = data.title || '춰Optimiza tu producci칩n con JCALCULO!';
                    document.getElementById('popup-message').textContent = data.message || 'Descubre la herramienta que revoluciona la gesti칩n de pezoneras. 춰Reg칤strate y toma el control hoy!';
                    document.getElementById('popup-contact').innerHTML = `游닎 Soporte: <a href="mailto:${data.contactEmail || 'alfstiven@gmail.com'}">${data.contactEmail || 'alfstiven@gmail.com'}</a>`;
                }
            })
            .catch(error => {
                console.error('Error al cargar mensaje del popup:', error);
            });
    } catch (error) {
        console.error("Error en cargarPopupMessage:", error);
    }
}

function guardarPopupMessage() {
    try {
        if (!isAdminLoggedIn) {
            alert('Debes ser administrador para actualizar el mensaje del popup.');
            return;
        }
        const message = document.getElementById('popup-message-content').value.trim();
        if (!message) {
            alert('Por favor, ingresa un mensaje para el popup.');
            return;
        }
        db.collection('config').doc('popup').set({
            title: '춰Optimiza tu producci칩n con JCALCULO!',
            message,
            contactEmail: 'alfstiven@gmail.com'
        })
            .then(() => {
                alert('Mensaje del popup actualizado correctamente.');
                cargarPopupMessage();
            })
            .catch(error => {
                console.error('Error al guardar mensaje del popup:', error);
                alert('Error al guardar mensaje del popup: ' + error.message);
            });
    } catch (error) {
        console.error("Error en guardarPopupMessage:", error);
    }
}

function probarNotificacion() {
    try {
        if (!isAdminLoggedIn) {
            alert('Debes ser administrador para probar notificaciones.');
            return;
        }
        if (!currentUser) {
            alert('No hay usuario autenticado para probar la notificaci칩n.');
            return;
        }
        db.collection('users').doc(currentUser.uid).get()
            .then(doc => {
                if (doc.exists && doc.data().fcmToken) {
                    const message = {
                        notification: {
                            title: 'Prueba de Notificaci칩n - JCALCULO',
                            body: 'Esta es una notificaci칩n de prueba para verificar el sistema.'
                        },
                        token: doc.data().fcmToken
                    };
                    messaging.send(message)
                        .then(() => {
                            alert('Notificaci칩n de prueba enviada correctamente.');
                        })
                        .catch(error => {
                            console.error('Error al enviar notificaci칩n de prueba:', error);
                            alert('Error al enviar notificaci칩n de prueba: ' + error.message);
                        });
                } else {
                    alert('El usuario no tiene un token FCM registrado.');
                }
            })
            .catch(error => {
                console.error('Error al obtener datos del usuario:', error);
                alert('Error al obtener datos del usuario: ' + error.message);
            });
    } catch (error) {
        console.error("Error en probarNotificacion:", error);
    }
}

function guardarFechaProximoCambio(uid, fecha) {
    try {
        db.collection('users').doc(uid).update({
            fechaProximoCambio: fecha.toISOString()
        })
            .catch(error => {
                console.error('Error al guardar fecha de pr칩ximo cambio:', error);
            });
    } catch (error) {
        console.error("Error en guardarFechaProximoCambio:", error);
    }
}

function programarNotificacion(uid) {
    try {
        db.collection('users').doc(uid).get()
            .then(doc => {
                if (doc.exists && doc.data().fechaProximoCambio && doc.data().notificacionPreferencia !== 'ninguna') {
                    const fechaProximoCambio = new Date(doc.data().fechaProximoCambio);
                    const ahora = new Date();
                    const diasRestantes = Math.floor((fechaProximoCambio - ahora) / (1000 * 60 * 60 * 24));
                    if (diasRestantes <= 7 && diasRestantes >= 0 && doc.data().fcmToken) {
                        const message = {
                            notification: {
                                title: 'JCALCULO - Recordatorio de Cambio de Pezoneras',
                                body: `춰Faltan ${diasRestantes} d칤as para el pr칩ximo cambio de pezoneras! Planifica tu reemplazo.`
                            },
                            token: doc.data().fcmToken
                        };
                        messaging.send(message)
                            .catch(error => {
                                console.error('Error al enviar notificaci칩n programada:', error);
                            });
                    }
                }
            })
            .catch(error => {
                console.error('Error al programar notificaci칩n:', error);
            });
    } catch (error) {
        console.error("Error en programarNotificacion:", error);
    }
}
</script>



