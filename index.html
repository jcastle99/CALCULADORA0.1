<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="JCALCULO: Optimiza el cambio de pezoneras para ganaderos de manera fácil y precisa.">
    <title>JCALCULO - Gestión de Pezoneras</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
    <!-- SheetJS para exportar a Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Cookie Consent for AdSense Compliance -->
    <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" />
</head>
<body>
    <!-- Cookie Consent Popup -->
    <script>
        window.cookieconsent.initialise({
            "palette": { "popup": { "background": "#005566" }, "button": { "background": "#fff" } },
            "content": {
                "message": "Este sitio usa cookies para mejorar tu experiencia y mostrar anuncios personalizados.",
                "dismiss": "Aceptar",
                "link": "Política de Privacidad",
                "href": "politica-de-privacidad.html"
            }
        });
    </script>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 10px;
        background: #e0f7fa;
        color: #333;
    }
    .container {
        max-width: 800px;
        margin: 0 auto;
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: relative;
        border: 1px solid #ddd;
    }
    .admin-link {
        position: absolute;
        top: 10px;
        right: 10px;
        font-size: 12px;
        color: #005566;
        text-decoration: none;
        opacity: 0.5;
        transition: opacity 0.3s;
    }
    .admin-link:hover {
        opacity: 1;
    }
    .logo {
        display: block;
        margin: 0 auto 10px;
        width: 120px;
    }
    h1 {
        text-align: center;
        color: #005566;
        font-size: 28px;
        margin-bottom: 15px;
        font-weight: bold;
    }
</style>
<style>
    .popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .popup-content {
        background: #fff;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        max-width: 400px;
        width: 90%;
    }
    .close-btn {
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 24px;
        cursor: pointer;
    }
    label {
        display: block;
        margin: 5px 0 2px;
        font-weight: bold;
        color: #005566;
    }
    input, select, textarea {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        box-sizing: border-box;
    }
    button {
        background: #005566;
        color: #fff;
        padding: 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        width: 100%;
        margin: 5px 0;
        transition: background 0.3s;
    }
    button:hover {
        background: #003d4a;
    }
</style>
<style>
    .auth-message {
        text-align: center;
        color: #d32f2f;
        margin-bottom: 15px;
        font-weight: bold;
    }
    .modificacion-campos {
        display: none;
        margin-top: 10px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: #f9f9f9;
    }
    ul {
        list-style-type: none;
        padding: 0;
    }
    li {
        background: #f1f1f1;
        padding: 10px;
        margin-bottom: 5px;
        border-radius: 5px;
    }
    #report-section {
        margin-top: 20px;
        display: none;
    }
    .signature {
        text-align: center;
        margin-top: 20px;
        font-family: 'Dancing Script', cursive;
        font-size: 24px;
        color: #005566;
    }
    .verified-badge {
        background: #28a745;
        color: #fff;
        padding: 2px 8px;
        border-radius: 10px;
        margin-left: 10px;
        font-size: 12px;
    }
</style>
<style>
    @media (max-width: 600px) {
        .container {
            padding: 15px;
        }
        h1 {
            font-size: 24px;
        }
        button {
            padding: 8px;
        }
        input, select, textarea {
            padding: 6px;
        }
        .popup-content {
            width: 95%;
            padding: 15px;
        }
        .signature {
            font-size: 20px;
        }
    }
    #resultado {
        margin-top: 15px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        background: #f9f9f9;
    }
    #whatsapp-section, #calculos-registrados, #adsense-section, #publicidad-section, #donaciones-section {
        margin-top: 15px;
        text-align: center;
    }
    #whatsapp-section input {
        width: 70%;
        display: inline-block;
    }
    #whatsapp-section button {
        width: 25%;
        display: inline-block;
    }
</style>
<body>
    <!-- Pop-up -->
    <div id="popup" class="popup">
        <div class="popup-content">
            <span class="close-btn" onclick="cerrarPopup()">×</span>
            <h2 id="popup-title">¡Optimiza tu producción con JCALCULO!</h2>
            <p id="popup-message">Descubre la herramienta que revoluciona la gestión de pezoneras. ¡Regístrate y toma el control hoy!</p>
            <p id="popup-contact">📧 Soporte: <a href="mailto:alfstiven@gmail.com">alfstiven@gmail.com</a></p>
        </div>
    </div>

    <div class="container">
        <!-- Enlace discreto para admin -->
        <a href="#" class="admin-link" onclick="mostrarLoginAdmin()">Admin</a>

        <!-- Contenedor para el logo dinámico -->
        <img id="app-logo" class="logo" style="display: none;" alt="Logo de JCALCULO">

        <h1>JCALCULO</h1>

        <!-- Mensaje para usuarios no autenticados -->
        <div id="auth-message" class="auth-message">
            Por favor, regístrate o inicia sesión para usar la calculadora.
        </div>

        <!-- Información de la calculadora -->
        <div id="calculator-info">
            <h3>¡Gestiona tus Pezoneras como Nunca Antes! 🚀</h3>
            <p>Con <strong>JCALCULO</strong>, optimiza el cambio de tus pezoneras de manera fácil y precisa...</p>
        </div>
    </div>
</body>
<div class="container">
    <!-- Formulario de Registro -->
    <div id="registro-section" style="display: block;">
        <h3>Regístrate</h3>
        <label for="nombre">Nombre:</label>
        <input type="text" id="nombre" placeholder="Tu nombre" required>
        <label for="profesion">Profesión:</label>
        <select id="profesion" onchange="mostrarCamposProfesion()" required>
            <option value="" selected>Selecciona...</option>
            <option value="ganadero">Ganadero</option>
            <option value="tecnico">Técnico</option>
            <option value="otro">Otro</option>
        </select>
        <!-- Campo adicional para ganadero -->
        <div id="empresa-section" style="display: none;">
            <label for="empresa">Nombre de la Granja o Explotación:</label>
            <input type="text" id="empresa" placeholder="Nombre de la granja o explotación" required>
        </div>
        <!-- Campo adicional para otro -->
        <div id="otra-profesion-section" style="display: none;">
            <label for="otra-profesion">Especifica tu Profesión:</label>
            <input type="text" id="otra-profesion" placeholder="Escribe tu profesión">
        </div>
        <label for="telefono">Número de Celular o Teléfono:</label>
        <input type="tel" id="telefono" placeholder="Ej. +573001234567" pattern="[0-9+]+" required>
        <label for="email">Correo Electrónico:</label>
        <input type="email" id="email" placeholder="tu@correo.com" required>
        <label for="password">Contraseña:</label>
        <input type="password" id="password" placeholder="Contraseña" required>
        <button type="button" onclick="registrarUsuario()" id="register-btn">Registrarse</button>
        <p>¿Ya tienes cuenta? <a href="#" onclick="mostrarLoginUsuario()">Inicia sesión</a></p>
    </div>
</div>
<div class="container">
    <!-- Formulario de Login de Usuario -->
    <div id="login-section" style="display: none;">
        <h3>Iniciar Sesión</h3>
        <label for="login-email">Correo Electrónico:</label>
        <input type="email" id="login-email" placeholder="tu@correo.com" required>
        <label for="login-password">Contraseña:</label>
        <input type="password" id="login-password" placeholder="Contraseña" required>
        <button type="button" onclick="loginUsuario()" id="login-btn">Iniciar Sesión</button>
        <p><a href="#" onclick="recuperarContrasena()">¿Olvidaste tu contraseña?</a></p>
        <p>¿No tienes cuenta? <a href="#" onclick="mostrarRegistro()">Regístrate</a></p>
        <div id="login-error" style="color: red; margin-top: 10px; display: none;"></div>
    </div>
</div>
<div class="container">
    <!-- Sección de usuario logueado -->
    <div id="user-section" style="display: none;">
        <h3>Bienvenido, <span id="user-name">Usuario</span><span id="verified-badge" class="verified-badge" style="display: none;">Verificado</span></h3>
        <p>Profesión: <span id="user-profesion">N/A</span></p>
        <label for="notificacion-preferencia">Notificarme sobre el cambio de pezoneras:</label>
        <select id="notificacion-preferencia">
            <option value="email">Por Correo Electrónico</option>
            <option value="movil">Por Notificación Móvil</option>
            <option value="ninguna">No notificar</option>
        </select>
        <button type="button" onclick="guardarPreferenciaNotificacion()">Guardar Preferencia</button>
        <button type="button" onclick="cerrarSesionUsuario()">Cerrar Sesión</button>
    </div>
</div>
<script>
    // Configuración de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDokCTsjDgQ94nu23rXf_HkvLeXpZmJU2c",
        authDomain: "jcalculador-ac481.firebaseapp.com",
        projectId: "jcalculador-ac481",
        storageBucket: "jcalculador-ac481.firebasestorage.app",
        messagingSenderId: "597989051329",
        appId: "1:597989051329:web:33b32c795cf7f51c63bd40",
        measurementId: "G-X4Z78DYMLD"
    };

    // Inicializar Firebase
    let app, auth, db, storage, messaging;
    try {
        app = firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        storage = firebase.storage();
        messaging = firebase.messaging();
        console.log("Firebase initialized successfully");
    } catch (error) {
        console.error('Error al inicializar Firebase:', error);
        alert('Error al conectar con el servidor. Por favor, intenta de nuevo más tarde.');
    }

    let resultadoTexto = '';
    let vacasIniciales = 0;
    let puntosOrdenoIniciales = 0;
    let totalPezoneras = 0;
    let isAdminLoggedIn = false;
    let fechaProximoCambio = null;
    let currentUser = null;
    let adminUser = null;
    let isVerifiedUser = false;
    let calculosData = [];

    const ADMIN_UID = 'KBb7nqyZFIMDDFHEGdX31stvp1L2';
    const ADMIN_EMAIL = 'alfstiven@gmail.com';
</script>
<script>
    function registrarUsuario() {
        const nombre = document.getElementById('nombre').value.trim();
        const profesion = document.getElementById('profesion').value;
        const empresa = document.getElementById('empresa').value.trim();
        const otraProfesion = document.getElementById('otra-profesion').value.trim();
        const telefono = document.getElementById('telefono').value.trim();
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value.trim();
        const registerBtn = document.getElementById('register-btn');

        if (!nombre || !profesion || !telefono || !email || !password) {
            alert('Por favor, completa todos los campos obligatorios.');
            return;
        }
        if (profesion === 'ganadero' && !empresa) {
            alert('Por favor, ingresa el nombre de la granja o explotación.');
            return;
        }
        if (prof g

esion === 'otro' && !otraProfesion) {
            alert('Por favor, especifica tu profesión.');
            return;
        }

        registerBtn.disabled = true;
        auth.createUserWithEmailAndPassword(email, password)
            .then(userCredential => {
                const user = userCredential.user;
                const userData = {
                    nombre: nombre,
                    profesion: profesion === 'otro' ? otraProfesion : profesion,
                    empresa: profesion === 'ganadero' ? empresa : null,
                    telefono: telefono,
                    email: email,
                    isVerified: false,
                    notificacionPreferencia: 'email',
                    timestamp: new Date().toISOString()
                };
                return Promise.all([
                    db.collection('users').doc(user.uid).set(userData),
                    user.sendEmailVerification()
                ]);
            })
            .then(() => {
                alert('Usuario registrado correctamente. Por favor, verifica tu correo para continuar.');
                auth.signOut();
            })
            .catch(error => {
                console.error('Error al registrar usuario:', error);
                alert('Error al registrar: ' + error.message);
            })
            .finally(() => {
                registerBtn.disabled = false;
            });
    }
</script>
<div class="container">
    <!-- Formulario de la calculadora (visible solo para usuarios autenticados) -->
    <div id="formulario-section" style="display: none;">
        <form id="formulario">
            <label for="ordenosDia">Ordeños por Día:</label>
            <input type="number" id="ordenosDia" required>
            <label for="puntosOrdeno">Puntos de Ordeño (Inicial):</label>
            <input type="number" id="puntosOrdeno" required>
            <label for="vacas">Vacas Ordeñadas (Inicial):</label>
            <input type="number" id="vacas" required>
            <label for="durabilidad">Durabilidad de Pezoneras por Ordeño por Punto:</label>
            <input type="number" id="durabilidad" value="2500" required>
            <label for="fechaInicio">Fecha de Inicio (opcional):</label>
            <input type="date" id="fechaInicio" placeholder="YYYY-MM-DD">
            <label for="diasEspecificos">Calcular para Días Específicos (opcional):</label>
            <input type="number" id="diasEspecificos" placeholder="Número de días">
            <label for="realizarModificacion">¿Modificar Vacas o Puntos?</label>
            <select id="realizarModificacion" onchange="mostrarCamposModificacion()">
                <option value="no">No</option>
                <option value="si">Sí</option>
            </select>
            <div id="modificacion-campos" class="modificacion-campos">
                <label for="fechaCambio">Fecha de Cambio:</label>
                <input type="date" id="fechaCambio" placeholder="YYYY-MM-DD">
                <label for="nuevoNumeroVacas">Nuevo Número de Vacas:</label>
                <input type="number" id="nuevoNumeroVacas" placeholder="Nuevo número de vacas">
                <label for="nuevoPuntosOrdeno">Nuevo Número de Puntos:</label>
                <input type="number" id="nuevoPuntosOrdeno" placeholder="Nuevo número de puntos">
            </div>
            <button type="button" onclick="calcular()">Calcular</button>
            <button type="button" onclick="limpiarPantalla()">Limpiar</button>
        </form>
    </div>
</div>
<div class="container">
    <div id="formulario-section">
        <div id="resultado"></div>
        <button id="guardar-resultado" style="display: none;" onclick="guardarResultado()">Guardar Resultado</button>
        <div id="calculos-registrados">
            <h3>Cálculos Guardados</h3>
            <button id="export-excel-btn" style="display: none;" onclick="exportarCalculosExcel()">Exportar a Excel</button>
            <button id="view-report-btn" style="display: none;" onclick="mostrarReporteGrafico()">Ver Reporte Gráfico</button>
            <ul id="lista-calculos"></ul>
        </div>
        <div id="report-section">
            <h3>Análisis de Consumo de Pezoneras</h3>
            <canvas id="report-canvas"></canvas>
        </div>
    </div>
</div>
<div class="container">
    <!-- Publicidad con Google AdSense -->
    <div id="adsense-section" style="margin-top: 15px; text-align: center; display: none;">
        <p style="font-size: 12px; color: #666;">Advertisement</p>
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6163239656988692" crossorigin="anonymous"></script>
        <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-6163239656988692"
             data-ad-slot="9656988692"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
        <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
    </div>
    <!-- Sección de publicidad dinámica -->
    <div id="publicidad-section"></div>
</div>
<div class="container">
    <!-- Formulario de login para admin -->
    <div id="admin-login" style="display: none; margin-top: 15px;">
        <h3>Iniciar Sesión (Admin)</h3>
        <form id="admin-login-form" onsubmit="event.preventDefault(); loginAdmin();">
            <label for="admin-email">Correo Electrónico:</label>
            <input type="email" id="admin-email" placeholder="alfstiven@gmail.com" required>
            <label for="admin-password">Contraseña:</label>
            <input type="password" id="admin-password" placeholder="Contraseña" required>
            <button type="submit" id="admin-login-btn">Iniciar Sesión</button>
            <button type="button" onclick="volverAlInicio()">Volver al Inicio</button>
            <div id="admin-login-error" style="color: red; margin-top: 10px; display: none;"></div>
        </form>
    </div>
</div>
<div class="container">
    <!-- Formulario para agregar publicidad y gestionar logo -->
    <div id="admin-form" style="display: none;">
        <h3>Administrar Configuración</h3>
        <!-- Gestión del Logo -->
        <h4>Actualizar Logo</h4>
        <label for="logo-source">Fuente del Logo:</label>
        <select id="logo-source" onchange="mostrarCamposLogo()">
            <option value="url">URL</option>
            <option value="upload">Subir desde el dispositivo</option>
        </select>
        <div id="logo-url-section" style="display: block;">
            <label for="logo-url">URL del Logo:</label>
            <input type="text" id="logo-url" placeholder="Ingresa la URL del logo">
        </div>
        <div id="logo-upload-section" style="display: none;">
            <label for="logo-upload">Subir Logo:</label>
            <input type="file" id="logo-upload" accept="image/*">
        </div>
        <button type="button" onclick="guardarLogo()">Guardar Logo</button>
    </div>
</div>
<div class="container">
    <div id="admin-form">
        <!-- Publicidad Principal -->
        <h4>Publicidad Principal (Texto o Imagen)</h4>
        <label for="ad-type">Tipo de Publicidad:</label>
        <select id="ad-type" onchange="mostrarCamposPublicidad()">
            <option value="texto">Texto</option>
            <option value="imagen">Imagen</option>
        </select>
        <div id="ad-texto" style="display: block;">
            <label for="ad-texto-content">Texto de la Publicidad:</label>
            <textarea id="ad-texto-content" placeholder="Escribe el texto de la publicidad"></textarea>
        </div>
        <div id="ad-imagen" style="display: none;">
            <label for="ad-imagen-source">Fuente de la Imagen:</label>
            <select id="ad-imagen-source" onchange="mostrarCamposImagen()">
                <option value="url">URL</option>
                <option value="upload">Subir desde el dispositivo</option>
            </select>
            <div id="ad-imagen-url-section" style="display: block;">
                <label for="ad-imagen-url">URL de la Imagen:</label>
                <input type="text" id="ad-imagen-url" placeholder="Ingresa la URL de la imagen (opcional)">
            </div>
            <div id="ad-imagen-upload-section" style="display: none;">
                <label for="ad-imagen-upload">Subir Imagen:</label>
                <input type="file" id="ad-imagen-upload" accept="image/*">
            </div>
        </div>
        <button type="button" onclick="guardarPublicidad()">Guardar Publicidad Principal</button>
    </div>
</div>
<div class="container">
    <div id="admin-form">
        <!-- Publicidad Secundaria -->
        <h4>Publicidad Secundaria (Imagen con Enlace)</h4>
        <label for="ad-secundaria-source">Fuente de la Imagen:</label>
        <select id="ad-secundaria-source" onchange="mostrarCamposImagenSecundaria()">
            <option value="url">URL</option>
            <option value="upload">Subir desde el dispositivo</option>
        </select>
        <div id="ad-secundaria-url-section" style="display: block;">
            <label for="ad-secundaria-imagen-url">URL de la Imagen:</label>
            <input type="text" id="ad-secundaria-imagen-url" placeholder="Ingresa la URL de la imagen (opcional)">
        </div>
        <div id="ad-secundaria-upload-section" style="display: none;">
            <label for="ad-secundaria-imagen-upload">Subir Imagen:</label>
            <input type="file" id="ad-secundaria-imagen-upload" accept="image/*">
        </div>
        <label for="ad-secundaria-link">Enlace de la Publicidad:</label>
        <input type="text" id="ad-secundaria-link" placeholder="Ingresa el enlace (ej. https://ejemplo.com)">
        <button type="button" onclick="guardarPublicidadSecundaria()">Guardar Publicidad Secundaria</button>
        <!-- Mensaje del Pop-up -->
        <h4>Mensaje del Pop-up</h4>
        <label for="popup-message-content">Mensaje del Pop-up:</label>
        <textarea id="popup-message-content" placeholder="Escribe el mensaje del pop-up"></textarea>
        <button type="button" onclick="guardarPopupMessage()">Guardar Mensaje del Pop-up</button>
        <!-- Prueba de Notificación -->
        <h4>Probar Notificación</h4>
        <button type="button" onclick="probarNotificacion()">Enviar Notificación de Prueba</button>
    </div>
</div>
<div class="container">
    <div id="admin-form">
        <!-- Gestión de usuarios verificados -->
        <h4>Gestionar Usuarios Verificados</h4>
        <label for="user-verification-email">Correo del Usuario:</label>
        <input type="email" id="user-verification-email" placeholder="correo@ejemplo.com">
        <button type="button" onclick="verificarUsuario()">Asignar Insignia de Verificado</button>
        <button type="button" onclick="quitarVerificacionUsuario()">Quitar Insignia de Verificado</button>
        <!-- Registro de nuevos administradores -->
        <div id="admin-registro">
            <h4>Registrar Nuevo Administrador</h4>
            <label for="admin-nombre">Nombre:</label>
            <input type="text" id="admin-nombre" placeholder="Nombre del administrador">
            <label for="admin-registro-email">Correo Electrónico:</label>
            <input type="email" id="admin-registro-email" placeholder="correo@ejemplo.com">
            <label for="admin-registro-password">Contraseña:</label>
            <input type="password" id="admin-registro-password" placeholder="Contraseña">
            <button type="button" onclick="registrarAdmin()">Registrar Administrador</button>
        </div>
        <!-- Historial de cálculos -->
        <div id="admin-calculos">
            <h4>Historial de Cálculos</h4>
            <button type="button" onclick="exportarHistorialExcel()">Exportar a Excel</button>
            <h5>Usuarios con cambio este mes:</h5>
            <ul id="lista-calculos-admin"></ul>
        </div>
        <button type="button" onclick="cerrarSesionAdmin()">Cerrar Sesión</button>
    </div>
</div>
<div class="container">
    <!-- WhatsApp Section -->
    <div id="whatsapp-section">
        <label for="codigoCliente">Código del Cliente:</label>
        <input type="text" id="codigoCliente" placeholder="Ingresa el código del cliente" required>
        <button type="button" onclick="enviarWhatsApp()">Enviar por WhatsApp</button>
    </div>
    <!-- Sección de publicidad secundaria -->
    <div id="donaciones-section" style="text-align: center;"></div>
    <!-- Marketing de Afiliados -->
    <div style="margin-top: 15px; text-align: center;">
        <p>¿Necesitas pezoneras nuevas? <a href="/comprar-pezoneras" target="_blank">Compra aquí</a>.</p>
    </div>
    <div class="signature">J.Castle</div>
    <!-- Privacy Policy Link -->
    <div style="text-align: center; margin-top: 15px;">
        <a href="politica-de-privacidad.html" target="_blank">Política de Privacidad</a>
    </div>
</div>
</body>
<script>
    // Mostrar el pop-up y cargar configuraciones al cargar la página
    window.onload = function() {
        document.getElementById('popup').style.display = 'flex';
        try {
            cargarLogo();
            cargarPublicidad();
            cargarPublicidadSecundaria();
            cargarPopupMessage();
        } catch (error) {
            console.error('Error al cargar las configuraciones:', error);
        }
        auth.onAuthStateChanged(user => {
            if (user) {
                if (!user.emailVerified) {
                    alert('Por favor, verifica tu correo electrónico para continuar.');
                    auth.signOut();
                    return;
                }
                currentUser = user;
                cargarDatosUsuario(user.uid);
                document.getElementById('registro-section').style.display = 'none';
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('user-section').style.display = 'block';
                document.getElementById('formulario-section').style.display = 'block';
                document.getElementById('auth-message').style.display = 'none';
                document.getElementById('calculator-info').style.display = 'none';
                document.getElementById('adsense-section').style.display = 'none';
                solicitarPermisoNotificaciones();
                programarNotificacion(user.uid);
                cargarCalculosGuardados(user.uid);
            } else {
                currentUser = null;
                document.getElementById('registro-section').style.display = 'block';
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('user-section').style.display = 'none';
                document.getElementById('formulario-section').style.display = 'none';
                document.getElementById('auth-message').style.display = 'block';
                document.getElementById('calculator-info').style.display = 'block';
                document.getElementById('adsense-section').style.display = 'none';
                cargarPublicidad();
                cargarPublicidadSecundaria();
            }
        });
    };
</script>
<script>
    function calcular() {
        const ordenosDia = parseInt(document.getElementById('ordenosDia').value) || 0;
        let puntosOrdeno = parseInt(document.getElementById('puntosOrdeno').value) || 0;
        const vacas = parseInt(document.getElementById('vacas').value) || 0;
        const durabilidad = parseInt(document.getElementById('durabilidad').value) || 0;
        const fechaInicioInput = document.getElementById('fechaInicio').value;
        const diasEspecificos = parseInt(document.getElementById('diasEspecificos').value) || 0;
        const realizarModificacion = document.getElementById('realizarModificacion').value;
        const fechaCambioInput = document.getElementById('fechaCambio').value;
        const nuevoNumeroVacas = parseInt(document.getElementById('nuevoNumeroVacas').value) || 0;
        const nuevoPuntosOrdeno = parseInt(document.getElementById('nuevoPuntosOrdeno').value) || 0;

        vacasIniciales = vacas;
        puntosOrdenoIniciales = puntosOrdeno;

        if (ordenosDia <= 0 || puntosOrdeno <= 0 || vacas <= 0 || durabilidad <= 0) {
            alert("Por favor, ingresa valores válidos (mayores que 0) para ordeños, puntos, vacas y durabilidad.");
            return;
        }

        let fechaInicio = fechaInicioInput ? new Date(fechaInicioInput) : new Date();
        if (isNaN(fechaInicio.getTime())) {
            alert("Por favor, selecciona una fecha de inicio válida.");
            return;
        }

        const ordeñosTotalesPorDia = ordenosDia * vacas;
        const ordeñosPorPuntoPorDia = ordeñosTotalesPorDia / puntosOrdeno;
        const diasDurabilidadInicial = durabilidad / ordeñosPorPuntoPorDia;
        const fechaProximoCambioInicial = new Date(fechaInicio);
        fechaProximoCambioInicial.setDate(fechaInicio.getDate() + Math.floor(diasDurabilidadInicial));
    }
</script>
<script>
    let fechaDiasEspecificos = diasEspecificos > 0 ? `Fecha para ${diasEspecificos} Días: ${new Date(fechaInicio.getTime() + diasEspecificos * 86400000).toLocaleDateString('es-ES')}` : '';
    const diasEnMes = 30.42;
    const mesesEquivalentes = Math.round(diasDurabilidadInicial / diasEnMes);
    const pezonerasPorPunto = 4;
    totalPezoneras = puntosOrdeno * pezonerasPorPunto;
    let desgastePezonerasPorDiaInicial = totalPezoneras / diasDurabilidadInicial;

    let durabilidadAjustada = diasDurabilidadInicial;
    let fechaProximoCambioAjustada = fechaProximoCambioInicial;
    let desgastePezonerasPorDiaAjustada = desgastePezonerasPorDiaInicial;
    let mensajeAjuste = '';

    if (realizarModificacion === 'si' && fechaCambioInput && (nuevoNumeroVacas > 0 || nuevoPuntosOrdeno > 0)) {
        const fechaCambio = new Date(fechaCambioInput);
        if (isNaN(fechaCambio.getTime())) {
            alert("Por favor, selecciona una fecha de cambio válida.");
            return;
        }
        const diasTranscurridos = Math.floor((fechaCambio - fechaInicio) / (1000 * 60 * 60 * 24));
        if (diasTranscurridos < 0) {
            alert("La fecha de cambio no puede ser anterior a la fecha de inicio.");
            return;
        }
        const ordeñosPorPuntoHastaCambio = ordeñosPorPuntoPorDia * diasTranscurridos;
        const durabilidadRestante = durabilidad - ordeñosPorPuntoHastaCambio;
        if (durabilidadRestante <= 0) {
            mensajeAjuste = `Nota: Las pezoneras ya debieron cambiarse antes de ${fechaCambio.toLocaleDateString('es-ES')}.`;
        } else {
            const vacasAjustadas = nuevoNumeroVacas > 0 ? nuevoNumeroVacas : vacas;
            const puntosOrdenoAjustados = nuevoPuntosOrdeno > 0 ? nuevoPuntosOrdeno : puntosOrdeno;
            totalPezoneras = puntosOrdenoAjustados * pezonerasPorPunto;
            const nuevosOrdeñosTotalesPorDia = ordenosDia * vacasAjustadas;
            const nuevosOrdeñosPorPuntoPorDia = nuevosOrdeñosTotalesPorDia / puntosOrdenoAjustados;
            const diasDurabilidadRestante = durabilidadRestante / nuevosOrdeñosPorPuntoPorDia;
            fechaProximoCambioAjustada = new Date(fechaCambio);
            fechaProximoCambioAjustada.setDate(fechaCambio.getDate() + Math.floor(diasDurabilidadRestante));
            durabilidadAjustada = diasTranscurridos + diasDurabilidadRestante;
            desgastePezonerasPorDiaAjustada = totalPezoneras / durabilidadAjustada;
            mensajeAjuste = `
                Ajuste por Modificación:
                Fecha de Cambio: ${fechaCambio.toLocaleDateString('es-ES')}
                Nuevo Número de Vacas: ${vacasAjustadas}
                Nuevo Número de Puntos: ${puntosOrdenoAjustados}
                Durabilidad Ajustada: ${Math.floor(durabilidadAjustada)} días
                Nueva Fecha de Cambio: ${fechaProximoCambioAjustada.toLocaleDateString('es-ES')}
                Total Pezoneras: ${totalPezoneras}
                Desgaste por Día: ${desgastePezonerasPorDiaAjustada.toFixed(2)}
            `;
        }
    }

    fechaProximoCambio = realizarModificacion === 'si' ? fechaProximoCambioAjustada : fechaProximoCambioInicial;

    resultadoTexto = isVerifiedUser ? `
        <div style="background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); padding: 15px; border-radius: 5px;">
            <h3 style="color: #005566;">📊 Reporte Premium JCALCULO</h3>
            <p><strong>Fecha Inicio:</strong> ${fechaInicio.toLocaleDateString('es-ES')}</p>
            <p><strong>Vacas Iniciales:</strong> ${vacasIniciales}</p>
            <p><strong>Puntos Iniciales:</strong> ${puntosOrdenoIniciales}</p>
            <p><strong>Durabilidad Inicial:</strong> ${Math.floor(diasDurabilidadInicial)} días</p>
            <p><strong>🚨 Próximo Cambio:</strong> ${fechaProximoCambioInicial.toLocaleDateString('es-ES')}</p>
            <p><strong>Meses Equivalentes:</strong> ${mesesEquivalentes}</p>
            ${fechaDiasEspecificos ? `<p><strong>Fecha Específica:</strong> ${fechaDiasEspecificos}</p>` : ''}
            <p><strong>Total Pezoneras:</strong> ${totalPezoneras}</p>
            <p><strong>Desgaste Diario:</strong> ${desgastePezonerasPorDiaInicial.toFixed(2)}</p>
            ${mensajeAjuste ? `<p style="color: #d32f2f;"><strong>Ajustes Aplicados:</strong><br>${mensajeAjuste.replace(/\n/g, '<br>')}</p>` : ''}
            <p style="font-style: italic;">Gracias por ser un usuario verificado. ¡Disfruta de una experiencia sin publicidad y reportes avanzados!</p>
        </div>
    ` : `
        Calculadora JCALCULO Cambio de Pezoneras
        Fecha Inicio: ${fechaInicio.toLocaleDateString('es-ES')}
        Vacas Iniciales: ${vacasIniciales}
        Puntos Iniciales: ${puntosOrdenoIniciales}
        Durabilidad Inicial: ${Math.floor(diasDurabilidadInicial)} días
        Próximo Cambio Inicial: ${fechaProximoCambioInicial.toLocaleDateString('es-ES')}
        Meses Equivalentes: ${mesesEquivalentes}
        ${fechaDiasEspecificos}
        Total Pezoneras Inicial: ${totalPezoneras}
        Desgaste por Día Inicial: ${desgastePezonerasPorDiaInicial.toFixed(2)}
        ${mensajeAjuste}
    `;
    mostrarResultados();

    if (currentUser) {
        guardarFechaProximoCambio(currentUser.uid, fechaProximoCambio);
    }
}
</script>
<script>
    function mostrarResultados() {
        document.getElementById('resultado').innerHTML = resultadoTexto.replace(/\n/g, '<br>');
        document.getElementById('whatsapp-section').style.display = 'block';
        document.getElementById('guardar-resultado').style.display = 'block';
        if (!isVerifiedUser) {
            document.getElementById('adsense-section').style.display = 'block';
        }
    }

    function enviarWhatsApp() {
        const codigoCliente = document.getElementById('codigoCliente').value.trim();
        if (!codigoCliente) {
            alert("Ingresa el código del cliente.");
            return;
        }
        const mensajeWhatsApp = `Código del Cliente: ${codigoCliente}\n${resultadoTexto}`;
        const urlWhatsApp = `https://api.whatsapp.com/send?text=${encodeURIComponent(mensajeWhatsApp)}`;
        window.open(urlWhatsApp, '_blank');
    }

    function limpiarPantalla() {
        const durabilidad = document.getElementById('durabilidad').value;
        document.getElementById('formulario').reset();
        document.getElementById('durabilidad').value = durabilidad;
        document.getElementById('modificacion-campos').style.display = 'none';
        document.getElementById('resultado').innerHTML = '';
        document.getElementById('whatsapp-section').style.display = 'none';
        document.getElementById('guardar-resultado').style.display = 'none';
        document.getElementById('codigoCliente').value = '';
        document.getElementById('report-section').style.display = 'none';
        resultadoTexto = '';
        vacasIniciales = 0;
        puntosOrdenoIniciales = 0;
        totalPezoneras = 0;
        fechaProximoCambio = null;
    }
</script>
<script>
    function guardarResultado() {
        if (!currentUser) {
            alert('Debes estar autenticado para guardar el resultado.');
            return;
        }
        const calculo = {
            resultado: resultadoTexto,
            fechaProximoCambio: fechaProximoCambio ? fechaProximoCambio.toISOString() : null,
            vacas: vacasIniciales,
            puntos: puntosOrdenoIniciales,
            pezoneras: totalPezoneras,
            timestamp: new Date().toISOString()
        };
        const userCalcsRef = db.collection('calculos').doc(currentUser.uid).collection('registros');
        userCalcsRef.orderBy('timestamp', 'asc').get()
            .then(snapshot => {
                const calculos = snapshot.docs;
                if (calculos.length >= 10) {
                    const oldestCalculo = calculos[0];
                    userCalcsRef.doc(oldestCalculo.id).delete();
                }
                return userCalcsRef.add(calculo);
            })
            .then(() => {
                alert('Resultado guardado correctamente.');
                cargarCalculosGuardados(currentUser.uid);
            })
            .catch(error => {
                console.error('Error al guardar el resultado:', error);
                alert('Error al guardar el resultado: ' + error.message);
            });
    }
</script>
<script>
    function cargarCalculosGuardados(uid) {
        const listaCalculos = document.getElementById('lista-calculos');
        listaCalculos.innerHTML = '';
        calculosData = [];
        db.collection('calculos').doc(uid).collection('registros')
            .orderBy('timestamp', 'desc')
            .get()
            .then(snapshot => {
                snapshot.forEach(doc => {
                    const calc = doc.data();
                    calculosData.push({
                        fecha: new Date(calc.timestamp).toLocaleString('es-ES'),
                        resultado: calc.resultado,
                        pezoneras: calc.pezoneras,
                        vacas: calc.vacas,
                        puntos: calc.puntos,
                        fechaCambio: calc.fechaProximoCambio ? new Date(calc.fechaProximoCambio).toLocaleDateString('es-ES') : 'N/A'
                    });
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <strong>Fecha:</strong> ${new Date(calc.timestamp).toLocaleString('es-ES')}<br>
                        ${calc.resultado.replace(/\n/g, '<br>')}
                    `;
                    listaCalculos.appendChild(li);
                });
                document.getElementById('export-excel-btn').style.display = calculosData.length > 0 ? 'block' : 'none';
                document.getElementById('view-report-btn').style.display = calculosData.length > 0 ? 'block' : 'none';
            }).catch(error => {
                console.error('Error al cargar cálculos guardados:', error);
            });
    }
</script>
<script>
    function exportarCalculosExcel() {
        const data = calculosData.map(calc => ({
            Fecha: calc.fecha,
            'Vacas Iniciales': calc.vacas,
            'Puntos Iniciales': calc.puntos,
            'Pezoneras Totales': calc.pezoneras,
            'Fecha Próximo Cambio': calc.fechaCambio
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Cálculos');
        XLSX.writeFile(wb, 'CalculosPezoneras.xlsx');
    }
</script>
<script>
    function mostrarReporteGrafico() {
        const ctx = document.getElementById('report-canvas').getContext('2d');
        document.getElementById('report-section').style.display = 'block';
        const labels = calculosData.map(calc => calc.fecha);
        const pezoneras = calculosData.map(calc => calc.pezoneras);
        const vacas = calculosData.map(calc => calc.vacas);
        if (window.myChart) {
            window.myChart.destroy();
        }
        window.myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Pezoneras Totales',
                        data: pezoneras,
                        borderColor: '#005566',
                        backgroundColor: 'rgba(0, 85, 102, 0.2)',
                        fill: true
                    },
                    {
                        label: 'Vacas Ordeñadas',
                        data: vacas,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.2)',
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    title: {
                        display: true,
                        text: 'Consumo de Pezoneras y Vacas a lo largo del Tiempo'
                    }
                }
            }
        });
    }
</script>
<script>
    function cargarHistorialAdmin() {
        const listaCalculosAdmin = document.getElementById('lista-calculos-admin');
        listaCalculosAdmin.innerHTML = '';
        const hoy = new Date();
        const mesActual = hoy.getMonth();
        const añoActual = hoy.getFullYear();
        db.collection('users').get()
            .then(userSnapshot => {
                const promesas = [];
                userSnapshot.forEach(userDoc => {
                    const userId = userDoc.id;
                    const userData = userDoc.data();
                    const email = userData.email;
                    const promesa = db.collection('calculos').doc(userId).collection('registros')
                        .orderBy('timestamp', 'desc')
                        .get()
                        .then(snapshot => {
                            snapshot.forEach(doc => {
                                const calc = doc.data();
                                if (calc.fechaProximoCambio) {
                                    const fechaCambio = new Date(calc.fechaProximoCambio);
                                    if (fechaCambio.getMonth() === mesActual && fechaCambio.getFullYear() === añoActual) {
                                        const li = document.createElement('li');
                                        li.innerHTML = `
                                            Correo: ${email} | 
                                            Fecha de Cambio: ${fechaCambio.toLocaleDateString('es-ES')} | 
                                            Puntos: ${calc.puntos} | 
                                            Pezoneras: ${calc.pezoneras}
                                        `;
                                        listaCalculosAdmin.appendChild(li);
                                    }
                                }
                            });
                        })
                        .catch(error => {
                            console.error(`Error al cargar cálculos de ${email}:`, error);
                        });
                    promesas.push(promesa);
                });
                return Promise.all(promesas);
            })
            .catch(error => {
                console.error('Error al cargar historial de usuarios:', error);
                listaCalculosAdmin.innerHTML = '<li>Error al cargar el historial.</li>';
            });
    }
</script>
<script>
    function exportarHistorialExcel() {
        const hoy = new Date();
        const mesActual = hoy.getMonth();
        const añoActual = hoy.getFullYear();
        const historialData = [];
        db.collection('users').get()
            .then(userSnapshot => {
                const promesas = [];
                userSnapshot.forEach(userDoc => {
                    const userId = userDoc.id;
                    const userData = userDoc.data();
                    const email = userData.email;
                    const promesa = db.collection('calculos').doc(userId).collection('registros')
                        .orderBy('timestamp', 'desc')
                        .get()
                        .then(snapshot => {
                            snapshot.forEach(doc => {
                                const calc = doc.data();
                                if (calc.fechaProximoCambio) {
                                    const fechaCambio = new Date(calc.fechaProximoCambio);
                                    if (fechaCambio.getMonth() === mesActual && fechaCambio.getFullYear() === añoActual) {
                                        historialData.push({
                                            Email: email,
                                            'Fecha Cambio': fechaCambio.toLocaleDateString('es-ES'),
                                            'Vacas': calc.vacas,
                                            'Puntos': calc.puntos,
                                            'Pezoneras': calc.pezoneras
                                        });
                                    }
                                }
                            });
                        });
                    promesas.push(promesa);
                });
                return Promise.all(promesas);
            })
            .then(() => {
                const ws = XLSX.utils.json_to_sheet(historialData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Historial');
                XLSX.writeFile(wb, 'HistorialCalculos.xlsx');
            })
            .catch(error => {
                console.error('Error al exportar historial a Excel:', error);
                alert('Error al exportar historial: ' + error.message);
            });
    }
</script>
<script>
    function loginUsuario() {
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value.trim();
        const loginBtn = document.getElementById('login-btn');
        const errorDiv = document.getElementById('login-error');

        if (!email || !password) {
            errorDiv.style.display = 'block';
            errorDiv.textContent = 'Por favor, completa todos los campos.';
            return;
        }

        loginBtn.disabled = true;
        errorDiv.style.display = 'none';

        auth.signInWithEmailAndPassword(email, password)
            .then(userCredential => {
                const user = userCredential.user;
                if (!user.emailVerified) {
                    auth.signOut();
                    throw new Error('Por favor, verifica tu correo electrónico para continuar.');
                }
                currentUser = user;
                cargarDatosUsuario(user.uid);
            })
            .catch(error => {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Error al iniciar sesión: ' + error.message;
            })
            .finally(() => {
                loginBtn.disabled = false;
            });
    }
</script>
<script>
    function loginAdmin() {
        const email = document.getElementById('admin-email').value.trim();
        const password = document.getElementById('admin-password').value.trim();
        const loginBtn = document.getElementById('admin-login-btn');
        const errorDiv = document.getElementById('admin-login-error');

        if (!email || !password) {
            errorDiv.style.display = 'block';
            errorDiv.textContent = 'Por favor, completa todos los campos.';
            return;
        }

        loginBtn.disabled = true;
        errorDiv.style.display = 'none';

        auth.signInWithEmailAndPassword(email, password)
            .then(userCredential => {
                const user = userCredential.user;
                if (user.uid === ADMIN_UID || user.email === ADMIN_EMAIL) {
                    isAdminLoggedIn = true;
                    adminUser = user;
                    document.getElementById('admin-login').style.display = 'none';
                    document.getElementById('admin-form').style.display = 'block';
                    document.getElementById('admin-calculos').style.display = 'block';
                    document.getElementById('admin-registro').style.display = 'block';
                    cargarHistorialAdmin();
                } else {
                    auth.signOut();
                    throw new Error('No tienes permisos de administrador.');
                }
            })
            .catch(error => {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Error al iniciar sesión: ' + error.message;
            })
            .finally(() => {
                loginBtn.disabled = false;
            });
    }
</script>
<script>
    function recuperarContrasena() {
        const email = document.getElementById('login-email').value.trim();
        const errorDiv = document.getElementById('login-error');

        if (!email) {
            errorDiv.style.display = 'block';
            errorDiv.textContent = 'Por favor, ingresa tu correo electrónico.';
            return;
        }

        auth.sendPasswordResetEmail(email)
            .then(() => {
                alert('Se ha enviado un correo para restablecer tu contraseña. Revisa tu bandeja de entrada.');
            })
            .catch(error => {
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Error: ' + error.message;
            });
    }

    function cargarDatosUsuario(uid) {
        db.collection('users').doc(uid).get()
            .then(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    document.getElementById('user-name').textContent = userData.nombre;
                    document.getElementById('user-profesion').textContent = userData.profesion;
                    document.getElementById('notificacion-preferencia').value = userData.notificacionPreferencia || 'email';
                    isVerifiedUser = userData.isVerified || false;
                    if (isVerifiedUser) {
                        document.getElementById('verified-badge').style.display = 'inline-block';
                    }
                }
            })
            .catch(error => {
                console.error('Error al cargar datos del usuario:', error);
            });
    }
</script>
<script>
    function guardarPreferenciaNotificacion() {
        const preferencia = document.getElementById('notificacion-preferencia').value;
        if (currentUser) {
            db.collection('users').doc(currentUser.uid).update({
                notificacionPreferencia: preferencia
            })
                .then(() => {
                    alert('Preferencia de notificación guardada correctamente.');
                })
                .catch(error => {
                    console.error('Error al guardar preferencia:', error);
                    alert('Error al guardar preferencia: ' + error.message);
                });
        }
    }

    function cerrarSesionUsuario() {
        auth.signOut()
            .then(() => {
                currentUser = null;
                isVerifiedUser = false;
                window.location.reload();
            })
            .catch(error => {
                console.error('Error al cerrar sesión:', error);
                alert('Error al cerrar sesión: ' + error.message);
            });
    }

    function cerrarSesionAdmin() {
        auth.signOut()
            .then(() => {
                isAdminLoggedIn = false;
                adminUser = null;
                window.location.reload();
            })
            .catch(error => {
                console.error('Error al cerrar sesión del admin:', error);
                alert('Error al cerrar sesión: ' + error.message);
            });
    }
</script>
<script>
    function registrarAdmin() {
        const nombre = document.getElementById('admin-nombre').value.trim();
        const email = document.getElementById('admin-registro-email').value.trim();
        const password = document.getElementById('admin-registro-password').value.trim();

        if (!nombre || !email || !password) {
            alert('Por favor, completa todos los campos para registrar un administrador.');
            return;
        }

        auth.createUserWithEmailAndPassword(email, password)
            .then(userCredential => {
                const user = userCredential.user;
                return db.collection('users').doc(user.uid).set({
                    nombre: nombre,
                    email: email,
                    isAdmin: true,
                    timestamp: new Date().toISOString()
                });
            })
            .then(() => {
                alert('Administrador registrado correctamente.');
            })
            .catch(error => {
                console.error('Error al registrar administrador:', error);
                alert('Error al registrar administrador: ' + error.message);
            });
    }

    function verificarUsuario() {
        const email = document.getElementById('user-verification-email').value.trim();
        if (!email) {
            alert('Por favor, ingresa el correo del usuario.');
            return;
        }

        db.collection('users').where('email', '==', email).get()
            .then(snapshot => {
                if (snapshot.empty) {
                    alert('No se encontró un usuario con ese correo.');
                    return;
                }
                snapshot.forEach(doc => {
                    db.collection('users').doc(doc.id).update({
                        isVerified: true
                    })
                        .then(() => {
                            alert('Usuario verificado correctamente.');
                        })
                        .catch(error => {
                            console.error('Error al verificar usuario:', error);
                            alert('Error: ' + error.message);
                        });
                });
            })
            .catch(error => {
                console.error('Error al buscar usuario:', error);
                alert('Error: ' + error.message);
            });
    }
</script>
<script>
    function quitarVerificacionUsuario() {
        const email = document.getElementById('user-verification-email').value.trim();
        if (!email) {
            alert('Por favor, ingresa el correo del usuario.');
            return;
        }

        db.collection('users').where('email', '==', email).get()
            .then(snapshot => {
                if (snapshot.empty) {
                    alert('No se encontró un usuario con ese correo.');
                    return;
                }
                snapshot.forEach(doc => {
                    db.collection('users').doc(doc.id).update({
                        isVerified: false
                    })
                        .then(() => {
                            alert('Insignia de verificado quitada correctamente.');
                        })
                        .catch(error => {
                            console.error('Error al quitar verificación:', error);
                            alert('Error: ' + error.message);
                        });
                });
            })
            .catch(error => {
                console.error('Error al buscar usuario:', error);
                alert('Error: ' + error.message);
            });
    }

    function mostrarCamposLogo() {
        const logoSource = document.getElementById('logo-source').value;
        document.getElementById('logo-url-section').style.display = logoSource === 'url' ? 'block' : 'none';
        document.getElementById('logo-upload-section').style.display = logoSource === 'upload' ? 'block' : 'none';
    }
</script>
<script>
    function guardarLogo() {
        const logoSource = document.getElementById('logo-source').value;
        if (logoSource === 'url') {
            const logoUrl = document.getElementById('logo-url').value.trim();
            if (!logoUrl) {
                alert('Por favor, ingresa una URL válida para el logo.');
                return;
            }
            db.collection('config').doc('appSettings').set({
                logoUrl: logoUrl
            }, { merge: true })
                .then(() => {
                    alert('Logo actualizado correctamente.');
                    cargarLogo();
                })
                .catch(error => {
                    console.error('Error al guardar logo:', error);
                    alert('Error: ' + error.message);
                });
        } else {
            const fileInput = document.getElementById('logo-upload');
            const file = fileInput.files[0];
            if (!file) {
                alert('Por favor, selecciona una imagen para el logo.');
                return;
            }
            const storageRef = storage.ref(`logos/logo-${Date.now()}`);
            storageRef.put(file)
                .then(snapshot => snapshot.ref.getDownloadURL())
                .then(downloadURL => {
                    return db.collection('config').doc('appSettings').set({
                        logoUrl: downloadURL
                    }, { merge: true });
                })
                .then(() => {
                    alert('Logo subido y actualizado correctamente.');
                    cargarLogo();
                })
                .catch(error => {
                    console.error('Error al subir logo:', error);
                    alert('Error: ' + error.message);
                });
        }
    }
</script>
<script>
    function cargarLogo() {
        db.collection('config').doc('appSettings').get()
            .then(doc => {
                if (doc.exists && doc.data().logoUrl) {
                    const logo = document.getElementById('app-logo');
                    logo.src = doc.data().logoUrl;
                    logo.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error al cargar el logo:', error);
            });
    }

    function mostrarCamposPublicidad() {
        const adType = document.getElementById('ad-type').value;
        document.getElementById('ad-texto').style.display = adType === 'texto' ? 'block' : 'none';
        document.getElementById('ad-imagen').style.display = adType === 'imagen' ? 'block' : 'none';
    }

    function mostrarCamposImagen() {
        const adImagenSource = document.getElementById('ad-imagen-source').value;
        document.getElementById('ad-imagen-url-section').style.display = adImagenSource === 'url' ? 'block' : 'none';
        document.getElementById('ad-imagen-upload-section').style.display = adImagenSource === 'upload' ? 'block' : 'none';
    }
</script>
<script>
    function guardarPublicidad() {
        const adType = document.getElementById('ad-type').value;
        if (adType === 'texto') {
            const adTexto = document.getElementById('ad-texto-content').value.trim();
            if (!adTexto) {
                alert('Por favor, ingresa el texto de la publicidad.');
                return;
            }
            db.collection('config').doc('ads').set({
                adType: 'texto',
                adContent: adTexto
            }, { merge: true })
                .then(() => {
                    alert('Publicidad guardada correctamente.');
                    cargarPublicidad();
                })
                .catch(error => {
                    console.error('Error al guardar publicidad:', error);
                    alert('Error: ' + error.message);
                });
        } else {
            const adImagenSource = document.getElementById('ad-imagen-source').value;
            if (adImagenSource === 'url') {
                const adImagenUrl = document.getElementById('ad-imagen-url').value.trim();
                if (!adImagenUrl) {
                    alert('Por favor, ingresa una URL válida para la imagen.');
                    return;
                }
                db.collection('config').doc('ads').set({
                    adType: 'imagen',
                    adContent: adImagenUrl
                }, { merge: true })
                    .then(() => {
                        alert('Publicidad guardada correctamente.');
                        cargarPublicidad();
                    })
                    .catch(error => {
                        console.error('Error al guardar publicidad:', error);
                        alert('Error: ' + error.message);
                    });
            } else {
                const fileInput = document.getElementById('ad-imagen-upload');
                const file = fileInput.files[0];
                if (!file) {
                    alert('Por favor, selecciona una imagen para la publicidad.');
                    return;
                }
                const storageRef = storage.ref(`ads/ad-${Date.now()}`);
                storageRef.put(file)
                    .then(snapshot => snapshot.ref.getDownloadURL())
                    .then(downloadURL => {
                        return db.collection('config').doc('ads').set({
                            adType: 'imagen',
                            adContent: downloadURL
                        }, { merge: true });
                    })
                    .then(() => {
                        alert('Publicidad guardada correctamente.');
                        cargarPublicidad();
                    })
                    .catch(error => {
                        console.error('Error al subir publicidad:', error);
                        alert('Error: ' + error.message);
                    });
            }
        }
    }
</script>
<script>
    function cargarPublicidad() {
        db.collection('config').doc('ads').get()
            .then(doc => {
                const publicidadSection = document.getElementById('publicidad-section');
                if (doc.exists) {
                    const data = doc.data();
                    if (data.adType === 'texto') {
                        publicidadSection.innerHTML = `<p>${data.adContent}</p>`;
                    } else if (data.adType === 'imagen') {
                        publicidadSection.innerHTML = `<img src="${data.adContent}" alt="Publicidad" style="max-width: 100%; border-radius: 5px;">`;
                    }
                } else {
                    publicidadSection.innerHTML = '';
                }
            })
            .catch(error => {
                console.error('Error al cargar publicidad:', error);
            });
    }
</script>
<script>
    function mostrarCamposImagenSecundaria() {
        const adSecundariaSource = document.getElementById('ad-secundaria-source').value;
        document.getElementById('ad-secundaria-url-section').style.display = adSecundariaSource === 'url' ? 'block' : 'none';
        document.getElementById('ad-secundaria-upload-section').style.display = adSecundariaSource === 'upload' ? 'block' : 'none';
    }

    function guardarPublicidadSecundaria() {
        const adSecundariaSource = document.getElementById('ad-secundaria-source').value;
        const adLink = document.getElementById('ad-secundaria-link').value.trim();
        if (!adLink) {
            alert('Por favor, ingresa un enlace para la publicidad secundaria.');
            return;
        }
        if (adSecundariaSource === 'url') {
            const adImagenUrl = document.getElementById('ad-secundaria-imagen-url').value.trim();
            if (!adImagenUrl) {
                alert('Por favor, ingresa una URL válida para la imagen.');
                return;
            }
            db.collection('config').doc('adsSecundaria').set({
                adContent: adImagenUrl,
                adLink: adLink
            }, { merge: true })
                .then(() => {
                    alert('Publicidad secundaria guardada correctamente.');
                    cargarPublicidadSecundaria();
                })
                .catch(error => {
                    console.error('Error al guardar publicidad secundaria:', error);
                    alert('Error: ' + error.message);
                });
        } else {
            const fileInput = document.getElementById('ad-secundaria-imagen-upload');
            const file = fileInput.files[0];
            if (!file) {
                alert('Por favor, selecciona una imagen para la publicidad secundaria.');
                return;
            }
            const storageRef = storage.ref(`adsSecundaria/ad-${Date.now()}`);
            storageRef.put(file)
                .then(snapshot => snapshot.ref.getDownloadURL())
                .then(downloadURL => {
                    return db.collection('config').doc('adsSecundaria').set({
                        adContent: downloadURL,
                        adLink: adLink
                    }, { merge: true });
                })
                .then(() => {
                    alert('Publicidad secundaria guardada correctamente.');
                    cargarPublicidadSecundaria();
                })
                .catch(error => {
                    console.error('Error al subir publicidad secundaria:', error);
                    alert('Error: ' + error.message);
                });
        }
    }
</script>
<script>
    function cargarPublicidadSecundaria() {
        db.collection('config').doc('adsSecundaria').get()
            .then(doc => {
                const donacionesSection = document.getElementById('donaciones-section');
                if (doc.exists) {
                    const data = doc.data();
                    donacionesSection.innerHTML = `
                        <a href="${data.adLink}" target="_blank">
                            <img src="${data.adContent}" alt="Publicidad Secundaria" style="max-width: 100%; border-radius: 5px;">
                        </a>
                    `;
                } else {
                    donacionesSection.innerHTML = '';
                }
            })
            .catch(error => {
                console.error('Error al cargar publicidad secundaria:', error);
            });
    }
</script>
<script>
    function guardarPopupMessage() {
        const popupMessage = document.getElementById('popup-message-content').value.trim();
        if (!popupMessage) {
            alert('Por favor, ingresa un mensaje para el pop-up.');
            return;
        }
        db.collection('config').doc('popup').set({
            message: popupMessage
        }, { merge: true })
            .then(() => {
                alert('Mensaje del pop-up guardado correctamente.');
                cargarPopupMessage();
            })
            .catch(error => {
                console.error('Error al guardar mensaje del pop-up:', error);
                alert('Error: ' + error.message);
            });
    }

    function cargarPopupMessage() {
        db.collection('config').doc('popup').get()
            .then(doc => {
                if (doc.exists) {
                    document.getElementById('popup-message').textContent = doc.data().message;
                }
            })
            .catch(error => {
                console.error('Error al cargar mensaje del pop-up:', error);
            });
    }
</script>
<script>
    function solicitarPermisoNotificaciones() {
        if (!("Notification" in window)) {
            console.log("Este navegador no soporta notificaciones.");
            return;
        }

        Notification.requestPermission().then(permission => {
            if (permission === "granted") {
                console.log("Permiso para notificaciones concedido.");
                messaging.getToken({ vapidKey: 'BJJ6z5xX8tW8aL5y5nZ1eX9qM2vJ4kP7rT9uW3yA1bN5mQ8xL2zH6jK9pR4tY7uI0oS3dF5gH8jL1qW2eR4tY' })
                    .then(token => {
                        if (currentUser) {
                            db.collection('users').doc(currentUser.uid).update({
                                fcmToken: token
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error al obtener token de FCM:', error);
                    });
            }
        });
    }

    function guardarFechaProximoCambio(uid, fecha) {
        db.collection('calculos').doc(uid).set({
            fechaProximoCambio: fecha
        }, { merge: true })
            .catch(error => {
                console.error('Error al guardar fecha de próximo cambio:', error);
            });
    }
</script>
<script>
    function programarNotificacion(uid) {
        db.collection('users').doc(uid).get()
            .then(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    if (userData.notificacionPreferencia === 'movil' && userData.fcmToken) {
                        const fechaCambio = fechaProximoCambio;
                        if (fechaCambio) {
                            const now = new Date();
                            const diasRestantes = Math.floor((fechaCambio - now) / (1000 * 60 * 60 * 24));
                            if (diasRestantes <= 3 && diasRestantes >= 0) {
                                fetch('https://fcm.googleapis.com/fcm/send', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': 'key=YOUR_SERVER_KEY'
                                    },
                                    body: JSON.stringify({
                                        to: userData.fcmToken,
                                        notification: {
                                            title: 'Recordatorio de Cambio de Pezoneras',
                                            body: `Faltan ${diasRestantes} días para el próximo cambio de pezoneras.`
                                        }
                                    })
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        console.log('Notificación enviada:', data);
                                    })
                                    .catch(error => {
                                        console.error('Error al enviar notificación:', error);
                                    });
                            }
                        }
                    }
                }
            })
            .catch(error => {
                console.error('Error al programar notificación:', error);
            });
    }
</script>
<script>
    function probarNotificacion() {
        if (!currentUser) {
            alert('Debes estar autenticado para probar notificaciones.');
            return;
        }
        db.collection('users').doc(currentUser.uid).get()
            .then(doc => {
                if (doc.exists && doc.data().fcmToken) {
                    fetch('https://fcm.googleapis.com/fcm/send', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'key=YOUR_SERVER_KEY'
                        },
                        body: JSON.stringify({
                            to: doc.data().fcmToken,
                            notification: {
                                title: 'Notificación de Prueba',
                                body: 'Esta es una notificación de prueba desde JCALCULO.'
                            }
                        })
                    })
                        .then(response => response.json())
                        .then(data => {
                            alert('Notificación de prueba enviada. Revisa tu dispositivo.');
                            console.log('Notificación de prueba:', data);
                        })
                        .catch(error => {
                            console.error('Error al enviar notificación de prueba:', error);
                            alert('Error: ' + error.message);
                        });
                } else {
                    alert('No tienes un token de notificación. Asegúrate de haber dado permisos.');
                }
            })
            .catch(error => {
                console.error('Error al probar notificación:', error);
                alert('Error: ' + error.message);
            });
    }
</script>
<script>
    function cerrarPopup() {
        document.getElementById('popup').style.display = 'none';
    }

    function mostrarLoginAdmin() {
        document.getElementById('admin-login').style.display = 'block';
        document.getElementById('registro-section').style.display = 'none';
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('user-section').style.display = 'none';
        document.getElementById('formulario-section').style.display = 'none';
        document.getElementById('auth-message').style.display = 'none';
        document.getElementById('calculator-info').style.display = 'none';
    }

    function volverAlInicio() {
        document.getElementById('admin-login').style.display = 'none';
        document.getElementById('registro-section').style.display = 'block';
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('user-section').style.display = 'none';
        document.getElementById('formulario-section').style.display = 'none';
        document.getElementById('auth-message').style.display = 'block';
        document.getElementById('calculator-info').style.display = 'block';
    }

    function mostrarRegistro() {
        document.getElementById('registro-section').style.display = 'block';
        document.getElementById('login-section').style.display = 'none';
    }

    function mostrarLoginUsuario() {
        document.getElementById('registro-section').style.display = 'none';
        document.getElementById('login-section').style.display = 'block';
    }

    function mostrarCamposProfesion() {
        const profesion = document.getElementById('profesion').value;
        document.getElementById('empresa-section').style.display = profesion === 'ganadero' ? 'block' : 'none';
        document.getElementById('otra-profesion-section').style.display = profesion === 'otro' ? 'block' : 'none';
    }

    function mostrarCamposModificacion() {
        const realizarModificacion = document.getElementById('realizarModificacion').value;
        document.getElementById('modificacion-campos').style.display = realizarModificacion === 'si' ? 'block' : 'none';
    }
</script>
