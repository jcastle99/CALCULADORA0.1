<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCALCULO</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #005566;
            --secondary-color: #003d4a;
            --bg-light: #f9f9f9;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --border-radius: 5px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            background: var(--primary-color);
            color: #333;
            padding: 20px;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            position: relative;
        }

        .logo {
            display: block;
            margin: 0 auto 15px;
            width: 120px;
        }

        h1, .signature {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        h1 {
            font-size: 24px;
        }

        .signature {
            font-family: 'Dancing Script', cursive;
            font-size: 28px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        label {
            display: block;
            margin: 8px 0 4px;
            font-weight: bold;
            color: var(--primary-color);
        }

        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            font-size: 14px;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
        }

        button {
            width: 100%;
            padding: 10px;
            background: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            margin-top: 10px;
            font-size: 14px;
        }

        button:hover {
            background: var(--secondary-color);
        }

        .section {
            margin-top: 15px;
            padding: 12px;
            background: #f0f0f0;
            border-radius: var(--border-radius);
            display: none;
            text-align: center;
        }

        #resultado, #calculos-registrados, #report-section, #calculator-info {
            background: var(--bg-light);
            border: 1px solid #ddd;
            padding: 12px;
            border-radius: var(--border-radius);
        }

        #calculator-info {
            background: linear-gradient(135deg, #e0f7fa, #b2ebf2);
            box-shadow: var(--shadow);
        }

        #calculator-info h3 {
            color: var(--primary-color);
            font-size: 18px;
        }

        .popup {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .popup-content {
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            max-width: 400px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 20px;
            cursor: pointer;
        }

        .admin-link {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            color: var(--primary-color);
            opacity: 0.5;
        }

        .admin-link:hover {
            opacity: 1;
        }

        .verified-badge {
            background: #28a745;
            color: #fff;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 5px;
        }

        #export-excel-btn, #view-report-btn {
            background: #28a745;
        }

        #export-excel-btn:hover, #view-report-btn:hover {
            background: #218838;
        }

        #calculos-registrados ul, #admin-calculos ul {
            list-style: none;
            padding: 0;
        }

        #calculos-registrados li, #admin-calculos li {
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div id="popup" class="popup">
        <div class="popup-content">
            <span class="close-btn" onclick="cerrarPopup()">칑</span>
            <h2 id="popup-title">춰Optimiza tu producci칩n con JCALCULO!</h2>
            <p id="popup-message">Reg칤strate para gestionar tus pezoneras f치cilmente.</p>
            <p id="popup-contact">游닎 Soporte: <a href="mailto:alfstiven@gmail.com">alfstiven@gmail.com</a></p>
        </div>
    </div>

    <div class="container">
        <a href="#" class="admin-link" onclick="mostrarLoginAdmin()">Admin</a>
        <img id="app-logo" class="logo" style="display: none;" alt="Logo de JCALCULO">
        <h1>JCALCULO</h1>
        <div id="auth-message" class="auth-message">Por favor, reg칤strate o inicia sesi칩n.</div>

        <div id="calculator-info" class="section">
            <h3>춰Gestiona tus Pezoneras! 游</h3>
            <p>Con <strong>JCALCULO</strong>, optimiza el cambio de pezoneras, calcula su durabilidad y recibe notificaciones. 游댒 Ahorra tiempo y mejora tu orde침o. 游낷</p>
        </div>

        <div id="registro-section" class="section">
            <h3>Reg칤strate</h3>
            <label for="nombre">Nombre:</label>
            <input type="text" id="nombre" placeholder="Tu nombre" required>
            <label for="profesion">Profesi칩n:</label>
            <select id="profesion" onchange="mostrarCamposProfesion()" required>
                <option value="" disabled selected>Selecciona...</option>
                <option value="ganadero">Ganadero</option>
                <option value="tecnico">T칠cnico</option>
                <option value="otro">Otro</option>
            </select>
            <div id="empresa-section" style="display: none;">
                <label for="empresa">Granja:</label>
                <input type="text" id="empresa" placeholder="Nombre de la granja" required>
            </div>
            <div id="otra-profesion-section" style="display: none;">
                <label for="otra-profesion">Especifica:</label>
                <input type="text" id="otra-profesion" placeholder="Tu profesi칩n">
            </div>
            <label for="telefono">Tel칠fono:</label>
            <input type="tel" id="telefono" placeholder="+573001234567" required>
            <label for="email">Correo:</label>
            <input type="email" id="email" placeholder="tu@correo.com" required>
            <label for="password">Contrase침a:</label>
            <input type="password" id="password" placeholder="Contrase침a" required>
            <button onclick="registrarUsuario()">Registrarse</button>
            <p>쯏a tienes cuenta? <a href="#" onclick="mostrarLoginUsuario()">Inicia sesi칩n</a></p>
        </div>

        <div id="login-section" class="section">
            <h3>Iniciar Sesi칩n</h3>
            <label for="login-email">Correo:</label>
            <input type="email" id="login-email" placeholder="tu@correo.com" required>
            <label for="login-password">Contrase침a:</label>
            <input type="password" id="login-password" placeholder="Contrase침a" required>
            <button onclick="loginUsuario()">Iniciar Sesi칩n</button>
            <p><a href="#" onclick="recuperarContrasena()">쯆lvidaste tu contrase침a?</a></p>
            <p>쯅o tienes cuenta? <a href="#" onclick="mostrarRegistro()">Reg칤strate</a></p>
        </div>

        <div id="user-section" class="section">
            <h3>Bienvenido, <span id="user-name">Usuario</span><span id="verified-badge" class="verified-badge" style="display: none;">Verificado</span></h3>
            <p>Profesi칩n: <span id="user-profesion">N/A</span></p>
            <label for="notificacion-preferencia">Notificaciones:</label>
            <select id="notificacion-preferencia">
                <option value="email">Correo</option>
                <option value="movil">M칩vil</option>
                <option value="ninguna">Ninguna</option>
            </select>
            <button onclick="guardarPreferenciaNotificacion()">Guardar</button>
            <button onclick="cerrarSesionUsuario()">Cerrar Sesi칩n</button>
        </div>

        <div id="formulario-section" class="section">
            <form id="formulario">
                <label for="ordenosDia">Orde침os por D칤a:</label>
                <input type="number" id="ordenosDia" required>
                <label for="puntosOrdeno">Puntos de Orde침o:</label>
                <input type="number" id="puntosOrdeno" required>
                <label for="vacas">Vacas Orde침adas:</label>
                <input type="number" id="vacas" required>
                <label for="durabilidad">Durabilidad de Pezoneras:</label>
                <input type="number" id="durabilidad" value="2500" required>
                <label for="fechaInicio">Fecha Inicio:</label>
                <input type="date" id="fechaInicio">
                <label for="diasEspecificos">D칤as Espec칤ficos:</label>
                <input type="number" id="diasEspecificos">
                <label for="realizarModificacion">쯄odificar?</label>
                <select id="realizarModificacion" onchange="mostrarCamposModificacion()">
                    <option value="no">No</option>
                    <option value="si">S칤</option>
                </select>
                <div id="modificacion-campos" style="display: none;">
                    <label for="fechaCambio">Fecha de Cambio:</label>
                    <input type="date" id="fechaCambio">
                    <label for="nuevoNumeroVacas">Nuevas Vacas:</label>
                    <input type="number" id="nuevoNumeroVacas">
                    <label for="nuevoPuntosOrdeno">Nuevos Puntos:</label>
                    <input type="number" id="nuevoPuntosOrdeno">
                </div>
                <button type="button" onclick="calcular()">Calcular</button>
                <button type="button" onclick="limpiarPantalla()">Limpiar</button>
            </form>
            <div id="resultado"></div>
            <button id="guardar-resultado" style="display: none;" onclick="guardarResultado()">Guardar</button>
            <div id="calculos-registrados">
                <h3>C치lculos Guardados</h3>
                <button id="export-excel-btn" style="display: none;" onclick="exportarCalculosExcel()">Exportar</button>
                <button id="view-report-btn" style="display: none;" onclick="mostrarReporteGrafico()">Reporte</button>
                <ul id="lista-calculos"></ul>
            </div>
            <div id="report-section">
                <h3>An치lisis de Consumo</h3>
                <canvas id="report-canvas"></canvas>
            </div>
        </div>

        <div id="adsense-section" class="section">
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6163239656988692"></script>
            <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-tu-id-de-cliente" data-ad-slot="tu-id-de-slot" data-ad-format="auto"></ins>
            <script>(adsbygoogle = window.adsbygoogle || []).push({});</script>
        </div>

        <div id="publicidad-section" class="section"></div>

        <div id="admin-login" class="section">
            <h3>Admin Login</h3>
            <label for="admin-email">Correo:</label>
            <input type="email" id="admin-email" placeholder="alfstiven@gmail.com">
            <label for="admin-password">Contrase침a:</label>
            <input type="password" id="admin-password" placeholder="Contrase침a">
            <button onclick="loginAdmin()">Iniciar Sesi칩n</button>
        </div>

        <div id="admin-form" class="section">
            <h3>Configuraci칩n Admin</h3>
            <h4>Logo</h4>
            <select id="logo-source" onchange="mostrarCamposLogo()">
                <option value="url">URL</option>
                <option value="upload">Subir</option>
            </select>
            <div id="logo-url-section">
                <label for="logo-url">URL:</label>
                <input type="text" id="logo-url" placeholder="URL del logo">
            </div>
            <div id="logo-upload-section" style="display: none;">
                <label for="logo-upload">Subir:</label>
                <input type="file" id="logo-upload" accept="image/*">
            </div>
            <button onclick="guardarLogo()">Guardar</button>

            <h4>Publicidad Principal</h4>
            <select id="ad-type" onchange="mostrarCamposPublicidad()">
                <option value="texto">Texto</option>
                <option value="imagen">Imagen</option>
            </select>
            <div id="ad-texto">
                <label for="ad-texto-content">Texto:</label>
                <textarea id="ad-texto-content" placeholder="Texto de publicidad"></textarea>
            </div>
            <div id="ad-imagen" style="display: none;">
                <select id="ad-imagen-source" onchange="mostrarCamposImagen()">
                    <option value="url">URL</option>
                    <option value="upload">Subir</option>
                </select>
                <div id="ad-imagen-url-section">
                    <label for="ad-imagen-url">URL:</label>
                    <input type="text" id="ad-imagen-url" placeholder="URL de imagen">
                </div>
                <div id="ad-imagen-upload-section" style="display: none;">
                    <label for="ad-imagen-upload">Subir:</label>
                    <input type="file" id="ad-imagen-upload" accept="image/*">
                </div>
            </div>
            <button onclick="guardarPublicidad()">Guardar</button>

            <h4>Publicidad Secundaria</h4>
            <select id="ad-secundaria-source" onchange="mostrarCamposImagenSecundaria()">
                <option value="url">URL</option>
                <option value="upload">Subir</option>
            </select>
            <div id="ad-secundaria-url-section">
                <label for="ad-secundaria-imagen-url">URL:</label>
                <input type="text" id="ad-secundaria-imagen-url" placeholder="URL de imagen">
            </div>
            <div id="ad-secundaria-upload-section" style="display: none;">
                <label for="ad-secundaria-imagen-upload">Subir:</label>
                <input type="file" id="ad-secundaria-imagen-upload" accept="image/*">
            </div>
            <label for="ad-secundaria-link">Enlace:</label>
            <input type="text" id="ad-secundaria-link" placeholder="https://ejemplo.com">
            <button onclick="guardarPublicidadSecundaria()">Guardar</button>

            <h4>Pop-up</h4>
            <label for="popup-message-content">Mensaje:</label>
            <textarea id="popup-message-content" placeholder="Mensaje del pop-up"></textarea>
            <button onclick="guardarPopupMessage()">Guardar</button>

            <h4>Notificaci칩n</h4>
            <button onclick="probarNotificacion()">Probar</button>

            <h4>Usuarios Verificados</h4>
            <label for="user-verification-email">Correo:</label>
            <input type="email" id="user-verification-email" placeholder="correo@ejemplo.com">
            <button onclick="verificarUsuario()">Verificar</button>
            <button onclick="quitarVerificacionUsuario()">Quitar</button>

            <div id="admin-registro">
                <h4>Nuevo Admin</h4>
                <label for="admin-nombre">Nombre:</label>
                <input type="text" id="admin-nombre" placeholder="Nombre">
                <label for="admin-registro-email">Correo:</label>
                <input type="email" id="admin-registro-email" placeholder="correo@ejemplo.com">
                <label for="admin-registro-password">Contrase침a:</label>
                <input type="password" id="admin-registro-password" placeholder="Contrase침a">
                <button onclick="registrarAdmin()">Registrar</button>
            </div>

            <div id="admin-calculos">
                <h4>Historial</h4>
                <button onclick="exportarHistorialExcel()">Exportar</button>
                <h5>Cambios este mes:</h5>
                <ul id="lista-calculos-admin"></ul>
            </div>

            <button onclick="cerrarSesionAdmin()">Cerrar Sesi칩n</button>
        </div>

        <div id="whatsapp-section" class="section">
            <label for="codigoCliente">C칩digo Cliente:</label>
            <input type="text" id="codigoCliente" placeholder="C칩digo">
            <button onclick="enviarWhatsApp()">Enviar</button>
        </div>

        <div id="donaciones-section" class="section"></div>

        <div style="margin-top: 15px; text-align: center;">
            <p>쯇ezoneras nuevas? <a href="/comprar-pezoneras" target="_blank">Compra aqu칤</a>.</p>
        </div>

        <div class="signature">J.Castle</div>
    </div>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDokCTsjDgQ94nu23rXf_HkvLeXpZmJU2c",
            authDomain: "jcalculador-ac481.firebaseapp.com",
            projectId: "jcalculador-ac481",
            storageBucket: "jcalculador-ac481.firebasestorage.app",
            messagingSenderId: "597989051329",
            appId: "1:597989051329:web:33b32c795cf7f51c63bd40",
            measurementId: "G-X4Z78DYMLD"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const messaging = firebase.messaging();

        let resultadoTexto = '';
        let vacasIniciales = 0;
        let puntosOrdenoIniciales = 0;
        let totalPezoneras = 0;
        let isAdminLoggedIn = false;
        let fechaProximoCambio = null;
        let currentUser = null;
        let isVerifiedUser = false;
        let calculosData = [];

        const ADMIN_UID = 'Qnq9VPwWiHNNZC0DYXuRwDpLAr72';
        const ADMIN_EMAIL = 'alfstiven@gmail.com';

        function solicitarPermisoNotificaciones() {
            Notification.requestPermission().then(permission => {
                if (permission === 'granted') {
                    messaging.getToken({ vapidKey: 'BCaTUfW00kYdZyQ2BqdbR6HeTnAZtpxRWrF3jscJQXz4-3SaDNP2Z-y8EtWMtEu6DeUNekFhZQCQOYqRmEn-9Xg' })
                        .then(token => {
                            if (currentUser) {
                                db.collection('users').doc(currentUser.uid).update({ fcmToken: token });
                            }
                        }).catch(console.error);
                }
            }).catch(console.error);
        }

        function cargarLogo() {
            db.collection('config').doc('logo').get()
                .then(doc => {
                    const logo = document.getElementById('app-logo');
                    if (doc.exists) {
                        logo.src = doc.data().url;
                        logo.style.display = 'block';
                    } else {
                        logo.style.display = 'none';
                    }
                }).catch(() => {
                    document.getElementById('app-logo').style.display = 'none';
                });
        }

        function cargarPublicidad() {
            db.collection('config').doc('publicidad').get()
                .then(doc => {
                    const section = document.getElementById('publicidad-section');
                    if (doc.exists && !isVerifiedUser) {
                        const { type, content } = doc.data();
                        section.innerHTML = type === 'texto' ? `<p>${content}</p>` : `<img src="${content}" alt="Publicidad">`;
                        section.style.display = 'block';
                    } else {
                        section.style.display = 'none';
                    }
                }).catch(() => {
                    document.getElementById('publicidad-section').style.display = 'none';
                });
        }

        function cargarPublicidadSecundaria() {
            db.collection('config').doc('publicidad-secundaria').get()
                .then(doc => {
                    const section = document.getElementById('donaciones-section');
                    if (doc.exists && !isVerifiedUser) {
                        const { imagen, link } = doc.data();
                        section.innerHTML = `<a href="${link}" target="_blank"><img src="${imagen}" alt="Publicidad"></a>`;
                        section.style.display = 'block';
                    } else {
                        section.style.display = 'none';
                    }
                }).catch(() => {
                    document.getElementById('donaciones-section').style.display = 'none';
                });
        }

        function cargarPopupMessage() {
            db.collection('config').doc('popup').get()
                .then(doc => {
                    if (doc.exists) {
                        document.getElementById('popup-message').textContent = doc.data().message;
                    }
                }).catch(console.error);
        }

        window.onload = () => {
            document.getElementById('popup').style.display = 'flex';
            cargarLogo();
            cargarPublicidad();
            cargarPublicidadSecundaria();
            cargarPopupMessage();

            auth.onAuthStateChanged(user => {
                if (user) {
                    if (!user.emailVerified) {
                        alert('Verifica tu correo para continuar.');
                        auth.signOut();
                        return;
                    }
                    currentUser = user;
                    cargarDatosUsuario(user.uid);
                    toggleSections(['user-section', 'formulario-section'], ['registro-section', 'login-section', 'auth-message']);
                    solicitarPermisoNotificaciones();
                    programarNotificacion(user.uid);
                    cargarCalculosGuardados(user.uid);
                } else {
                    currentUser = null;
                    toggleSections(['registro-section', 'auth-message'], ['user-section', 'formulario-section']);
                    cargarPublicidad();
                    cargarPublicidadSecundaria();
                }
            });
        };

        function toggleSections(show = [], hide = []) {
            show.forEach(id => document.getElementById(id).style.display = 'block');
            hide.forEach(id => document.getElementById(id).style.display = 'none');
        }

        function cerrarPopup() {
            document.getElementById('popup').style.display = 'none';
        }

        function mostrarCamposModificacion() {
            document.getElementById('modificacion-campos').style.display = document.getElementById('realizarModificacion').value === 'si' ? 'block' : 'none';
        }

        function mostrarCamposProfesion() {
            const profesion = document.getElementById('profesion').value;
            document.getElementById('empresa-section').style.display = profesion === 'ganadero' ? 'block' : 'none';
            document.getElementById('otra-profesion-section').style.display = profesion === 'otro' ? 'block' : 'none';
        }

        function calcular() {
            const inputs = {
                ordenosDia: parseInt(document.getElementById('ordenosDia').value) || 0,
                puntosOrdeno: parseInt(document.getElementById('puntosOrdeno').value) || 0,
                vacas: parseInt(document.getElementById('vacas').value) || 0,
                durabilidad: parseInt(document.getElementById('durabilidad').value) || 0,
                diasEspecificos: parseInt(document.getElementById('diasEspecificos').value) || 0,
                fechaInicio: document.getElementById('fechaInicio').value,
                realizarModificacion: document.getElementById('realizarModificacion').value,
                fechaCambio: document.getElementById('fechaCambio').value,
                nuevoNumeroVacas: parseInt(document.getElementById('nuevoNumeroVacas').value) || 0,
                nuevoPuntosOrdeno: parseInt(document.getElementById('nuevoPuntosOrdeno').value) || 0
            };

            vacasIniciales = inputs.vacas;
            puntosOrdenoIniciales = inputs.puntosOrdeno;

            if (inputs.ordenosDia <= 0 || inputs.puntosOrdeno <= 0 || inputs.vacas <= 0 || inputs.durabilidad <= 0) {
                alert('Ingresa valores v치lidos (mayores a 0).');
                return;
            }

            let fechaInicio = inputs.fechaInicio ? new Date(inputs.fechaInicio) : new Date();
            if (isNaN(fechaInicio.getTime())) {
                alert('Selecciona una fecha de inicio v치lida.');
                return;
            }

            if (inputs.diasEspecificos > 0 && !inputs.ordenosDia && !inputs.puntosOrdeno && !inputs.vacas) {
                const fechaDiasEspecificos = new Date(fechaInicio.getTime() + inputs.diasEspecificos * 86400000);
                resultadoTexto = `Fecha Inicio: ${fechaInicio.toLocaleDateString('es-ES')}<br>Fecha para ${inputs.diasEspecificos} D칤as: ${fechaDiasEspecificos.toLocaleDateString('es-ES')}`;
                mostrarResultados();
                return;
            }

            const orde침osTotalesPorDia = inputs.ordenosDia * inputs.vacas;
            const orde침osPorPuntoPorDia = orde침osTotalesPorDia / inputs.puntosOrdeno;
            const diasDurabilidadInicial = inputs.durabilidad / orde침osPorPuntoPorDia;
            const fechaProximoCambioInicial = new Date(fechaInicio);
            fechaProximoCambioInicial.setDate(fechaInicio.getDate() + Math.floor(diasDurabilidadInicial));

            const diasEnMes = 30.42;
            const mesesEquivalentes = Math.round(diasDurabilidadInicial / diasEnMes);
            const pezonerasPorPunto = 4;
            totalPezoneras = inputs.puntosOrdeno * pezonerasPorPunto;
            let desgastePezonerasPorDiaInicial = totalPezoneras / diasDurabilidadInicial;
            let durabilidadAjustada = diasDurabilidadInicial;
            let fechaProximoCambioAjustada = fechaProximoCambioInicial;
            let mensajeAjuste = '';

            if (inputs.realizarModificacion === 'si' && inputs.fechaCambio && (inputs.nuevoNumeroVacas > 0 || inputs.nuevoPuntosOrdeno > 0)) {
                const fechaCambio = new Date(inputs.fechaCambio);
                if (isNaN(fechaCambio.getTime())) {
                    alert('Selecciona una fecha de cambio v치lida.');
                    return;
                }

                const diasTranscurridos = Math.floor((fechaCambio - fechaInicio) / (1000 * 60 * 60 * 24));
                if (diasTranscurridos < 0) {
                    alert('La fecha de cambio no puede ser anterior.');
                    return;
                }

                const orde침osPorPuntoHastaCambio = orde침osPorPuntoPorDia * diasTranscurridos;
                const durabilidadRestante = inputs.durabilidad - orde침osPorPuntoHastaCambio;

                if (durabilidadRestante <= 0) {
                    mensajeAjuste = `Nota: Las pezoneras debieron cambiarse antes de ${fechaCambio.toLocaleDateString('es-ES')}.`;
                } else {
                    const vacasAjustadas = inputs.nuevoNumeroVacas || inputs.vacas;
                    const puntosOrdenoAjustados = inputs.nuevoPuntosOrdeno || inputs.puntosOrdeno;
                    totalPezoneras = puntosOrdenoAjustados * pezonerasPorPunto;
                    const nuevosOrde침osPorPuntoPorDia = (inputs.ordenosDia * vacasAjustadas) / puntosOrdenoAjustados;
                    const diasDurabilidadRestante = durabilidadRestante / nuevosOrde침osPorPuntoPorDia;

                    fechaProximoCambioAjustada = new Date(fechaCambio);
                    fechaProximoCambioAjustada.setDate(fechaCambio.getDate() + Math.floor(diasDurabilidadRestante));
                    durabilidadAjustada = diasTranscurridos + diasDurabilidadRestante;
                    mensajeAjuste = `Ajuste:<br>Fecha: ${fechaCambio.toLocaleDateString('es-ES')}<br>Vacas: ${vacasAjustadas}<br>Puntos: ${puntosOrdenoAjustados}<br>Durabilidad: ${Math.floor(durabilidadAjustada)} d칤as<br>Pr칩ximo Cambio: ${fechaProximoCambioAjustada.toLocaleDateString('es-ES')}<br>Pezoneras: ${totalPezoneras}`;
                }
            }

            fechaProximoCambio = inputs.realizarModificacion === 'si' ? fechaProximoCambioAjustada : fechaProximoCambioInicial;

            resultadoTexto = isVerifiedUser ? `
                <div style="background: linear-gradient(135deg, #e0f7fa, #b2ebf2); padding: 12px; border-radius: 5px;">
                    <h3 style="color: #005566;">游늵 Reporte Premium</h3>
                    <p><strong>Inicio:</strong> ${fechaInicio.toLocaleDateString('es-ES')}</p>
                    <p><strong>Vacas:</strong> ${vacasIniciales}</p>
                    <p><strong>Puntos:</strong> ${puntosOrdenoIniciales}</p>
                    <p><strong>Durabilidad:</strong> ${Math.floor(diasDurabilidadInicial)} d칤as</p>
                    <p><strong>游뚿 Cambio:</strong> ${fechaProximoCambioInicial.toLocaleDateString('es-ES')}</p>
                    <p><strong>Meses:</strong> ${mesesEquivalentes}</p>
                    <p><strong>Pezoneras:</strong> ${totalPezoneras}</p>
                    ${mensajeAjuste ? `<p style="color: #d32f2f;"><strong>Ajustes:</strong><br>${mensajeAjuste}</p>` : ''}
                    <p style="font-style: italic;">Usuario verificado: sin publicidad.</p>
                </div>
            ` : `
                Inicio: ${fechaInicio.toLocaleDateString('es-ES')}<br>
                Vacas: ${vacasIniciales}<br>
                Puntos: ${puntosOrdenoIniciales}<br>
                Durabilidad: ${Math.floor(diasDurabilidadInicial)} d칤as<br>
                Cambio: ${fechaProximoCambioInicial.toLocaleDateString('es-ES')}<br>
                Meses: ${mesesEquivalentes}<br>
                Pezoneras: ${totalPezoneras}<br>
                ${mensajeAjuste}
            `;
            mostrarResultados();

            if (currentUser) {
                guardarFechaProximoCambio(currentUser.uid, fechaProximoCambio);
            }
        }

        function mostrarResultados() {
            document.getElementById('resultado').innerHTML = resultadoTexto.replace(/\n/g, '<br>');
            toggleSections(['whatsapp-section', 'guardar-resultado']);
        }

        function enviarWhatsApp() {
            const codigoCliente = document.getElementById('codigoCliente').value.trim();
            if (!codigoCliente) {
                alert('Ingresa el c칩digo del cliente.');
                return;
            }
            const mensaje = `C칩digo: ${codigoCliente}\n${resultadoTexto}`;
            window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(mensaje)}`, '_blank');
        }

        function limpiarPantalla() {
            const durabilidad = document.getElementById('durabilidad').value;
            document.getElementById('formulario').reset();
            document.getElementById('durabilidad').value = durabilidad;
            toggleSections([], ['modificacion-campos', 'resultado', 'whatsapp-section', 'guardar-resultado', 'report-section']);
            document.getElementById('codigoCliente').value = '';
            resultadoTexto = '';
            vacasIniciales = 0;
            puntosOrdenoIniciales = 0;
            totalPezoneras = 0;
            fechaProximoCambio = null;
        }

        function guardarResultado() {
            if (!currentUser) {
                alert('Autent칤cate para guardar.');
                return;
            }

            const calculo = {
                resultado: resultadoTexto,
                fechaProximoCambio: fechaProximoCambio?.toISOString() || null,
                vacas: vacasIniciales,
                puntos: puntosOrdenoIniciales,
                pezoneras: totalPezoneras,
                timestamp: new Date().toISOString()
            };

            const userCalcsRef = db.collection('calculos').doc(currentUser.uid).collection('registros');
            userCalcsRef.orderBy('timestamp', 'asc').get()
                .then(snapshot => {
                    if (snapshot.docs.length >= 10) {
                        userCalcsRef.doc(snapshot.docs[0].id).delete();
                    }
                    return userCalcsRef.add(calculo);
                })
                .then(() => {
                    alert('Resultado guardado.');
                    cargarCalculosGuardados(currentUser.uid);
                }).catch(error => {
                    alert('Error al guardar: ' + error.message);
                });
        }

        function cargarCalculosGuardados(uid) {
            const listaCalculos = document.getElementById('lista-calculos');
            listaCalculos.innerHTML = '';
            calculosData = [];

            db.collection('calculos').doc(uid).collection('registros').orderBy('timestamp', 'desc').get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const calc = doc.data();
                        calculosData.push({
                            fecha: new Date(calc.timestamp).toLocaleString('es-ES'),
                            resultado: calc.resultado,
                            pezoneras: calc.pezoneras,
                            vacas: calc.vacas,
                            puntos: calc.puntos,
                            fechaCambio: calc.fechaProximoCambio ? new Date(calc.fechaProximoCambio).toLocaleDateString('es-ES') : 'N/A'
                        });
                        listaCalculos.innerHTML += `
                            <li>
                                <strong>Fecha:</strong> ${new Date(calc.timestamp).toLocaleString('es-ES')}<br>
                                ${calc.resultado.replace(/\n/g, '<br>')}
                            </li>
                        `;
                    });
                }).catch(console.error);
        }

        function exportarCalculosExcel() {
            const data = calculosData.map(calc => ({
                Fecha: calc.fecha,
                Vacas: calc.vacas,
                Puntos: calc.puntos,
                Pezoneras: calc.pezoneras,
                'Pr칩ximo Cambio': calc.fechaCambio
            }));
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'C치lculos');
            XLSX.writeFile(wb, 'CalculosPezoneras.xlsx');
        }

        function mostrarReporteGrafico() {
            const ctx = document.getElementById('report-canvas').getContext('2d');
            document.getElementById('report-section').style.display = 'block';

            if (window.myChart) window.myChart.destroy();

            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: calculosData.map(calc => calc.fecha),
                    datasets: [
                        { label: 'Pezoneras', data: calculosData.map(calc => calc.pezoneras), borderColor: '#005566', backgroundColor: 'rgba(0, 85, 102, 0.2)', fill: true },
                        { label: 'Vacas', data: calculosData.map(calc => calc.vacas), borderColor: '#28a745', backgroundColor: 'rgba(40, 167, 69, 0.2)', fill: true }
                    ]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: { title: { display: true, text: 'Consumo de Pezoneras y Vacas' } }
                }
            });
        }

        function cargarHistorialAdmin() {
            const listaCalculosAdmin = document.getElementById('lista-calculos-admin');
            listaCalculosAdmin.innerHTML = '';
            const hoy = new Date();
            const mesActual = hoy.getMonth();
            const a침oActual = hoy.getFullYear();

            db.collection('users').get().then(userSnapshot => {
                const promesas = userSnapshot.docs.map(userDoc => {
                    const userId = userDoc.id;
                    const email = userDoc.data().email;
                    return db.collection('calculos').doc(userId).collection('registros').orderBy('timestamp', 'desc').get()
                        .then(snapshot => {
                            snapshot.forEach(doc => {
                                const calc = doc.data();
                                if (calc.fechaProximoCambio) {
                                    const fechaCambio = new Date(calc.fechaProximoCambio);
                                    if (fechaCambio.getMonth() === mesActual && fechaCambio.getFullYear() === a침oActual) {
                                        listaCalculosAdmin.innerHTML += `
                                            <li>
                                                Correo: ${email} | Fecha: ${fechaCambio.toLocaleDateString('es-ES')} | 
                                                Puntos: ${calc.puntos} | Pezoneras: ${calc.pezoneras}
                                            </li>
                                        `;
                                    }
                                }
                            });
                        });
                });
                Promise.all(promesas).catch(() => {
                    listaCalculosAdmin.innerHTML = '<li>Error al cargar historial.</li>';
                });
            }).catch(console.error);
        }

        function exportarHistorialExcel() {
            const hoy = new Date();
            const mesActual = hoy.getMonth();
            const a침oActual = hoy.getFullYear();
            const historialData = [];

            db.collection('users').get().then(userSnapshot => {
                const promesas = userSnapshot.docs.map(userDoc => {
                    const userId = userDoc.id;
                    const email = userDoc.data().email;
                    return db.collection('calculos').doc(userId).collection('registros').orderBy('timestamp', 'desc').get()
                        .then(snapshot => {
                            snapshot.forEach(doc => {
                                const calc = doc.data();
                                if (calc.fechaProximoCambio) {
                                    const fechaCambio = new Date(calc.fechaProximoCambio);
                                    if (fechaCambio.getMonth() === mesActual && fechaCambio.getFullYear() === a침oActual) {
                                        historialData.push({
                                            Email: email,
                                            'Fecha Cambio': fechaCambio.toLocaleDateString('es-ES'),
                                            Vacas: calc.vacas,
                                            Puntos: calc.puntos,
                                            Pezoneras: calc.pezoneras
                                        });
                                    }
                                }
                            });
                        });
                });
                Promise.all(promesas).then(() => {
                    const ws = XLSX.utils.json_to_sheet(historialData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Historial');
                    XLSX.writeFile(wb, 'HistorialCalculos.xlsx');
                });
            }).catch(error => {
                alert('Error al exportar: ' + error.message);
            });
        }

        function registrarUsuario() {
            const nombre = document.getElementById('nombre').value.trim();
            const profesion = document.getElementById('profesion').value;
            const empresa = document.getElementById('empresa').value.trim();
            const otraProfesion = document.getElementById('otra-profesion').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!nombre || !profesion || !telefono || !email || !password || (profesion === 'ganadero' && !empresa) || (profesion === 'otro' && !otraProfesion)) {
                alert('Completa todos los campos.');
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    const userData = {
                        nombre,
                        profesion: profesion === 'otro' ? otraProfesion : profesion,
                        empresa: profesion === 'ganadero' ? empresa : null,
                        telefono,
                        email,
                        isVerified: false,
                        notificacionPreferencia: 'email',
                        timestamp: new Date().toISOString()
                    };
                    return Promise.all([
                        db.collection('users').doc(user.uid).set(userData),
                        user.sendEmailVerification()
                    ]);
                })
                .then(() => {
                    alert('Usuario registrado. Verifica tu correo.');
                    toggleSections(['login-section'], ['registro-section']);
                    document.getElementById('registro-section').querySelectorAll('input').forEach(input => input.value = '');
                }).catch(error => {
                    alert('Error al registrar: ' + error.message);
                });
        }

        function loginUsuario() {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();

            if (!email || !password) {
                alert('Completa todos los campos.');
                return;
            }

            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    if (!userCredential.user.emailVerified) {
                        alert('Verifica tu correo.');
                        auth.signOut();
                        return;
                    }
                    currentUser = userCredential.user;
                    cargarDatosUsuario(currentUser.uid);
                }).catch(error => {
                    alert('Error al iniciar: ' + error.message);
                });
        }

        function recuperarContrasena() {
            const email = document.getElementById('login-email').value.trim();
            if (!email) {
                alert('Ingresa tu correo.');
                return;
            }

            auth.sendPasswordResetEmail(email)
                .then(() => alert('Correo de recuperaci칩n enviado.'))
                .catch(error => alert('Error: ' + error.message));
        }

        function cargarDatosUsuario(uid) {
            db.collection('users').doc(uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById('user-name').textContent = data.nombre;
                        document.getElementById('user-profesion').textContent = data.profesion + (data.empresa ? ` (${data.empresa})` : '');
                        document.getElementById('notificacion-preferencia').value = data.notificacionPreferencia || 'email';
                        isVerifiedUser = data.isVerified || false;
                        toggleSections(isVerifiedUser ? [] : ['adsense-section']);
                        document.getElementById('verified-badge').style.display = isVerifiedUser ? 'inline-block' : 'none';
                        document.getElementById('export-excel-btn').style.display = isVerifiedUser ? 'block' : 'none';
                        document.getElementById('view-report-btn').style.display = isVerifiedUser ? 'block' : 'none';
                        cargarPublicidad();
                        cargarPublicidadSecundaria();
                    }
                }).catch(console.error);
        }

        function guardarPreferenciaNotificacion() {
            if (!currentUser) {
                alert('Autent칤cate para guardar.');
                return;
            }

            const preferencia = document.getElementById('notificacion-preferencia').value;
            db.collection('users').doc(currentUser.uid).update({ notificacionPreferencia: preferencia })
                .then(() => {
                    alert('Preferencia guardada.');
                    if (preferencia === 'movil') solicitarPermisoNotificaciones();
                }).catch(error => alert('Error: ' + error.message));
        }

        function cerrarSesionUsuario() {
            auth.signOut().then(() => {
                currentUser = null;
                isVerifiedUser = false;
                toggleSections(['registro-section', 'auth-message'], ['user-section', 'formulario-section']);
                document.getElementById('login-email').value = '';
                document.getElementById('login-password').value = '';
                document.getElementById('verified-badge').style.display = 'none';
                toggleSections(['adsense-section', 'publicidad-section', 'donaciones-section']);
                document.getElementById('export-excel-btn').style.display = 'none';
                document.getElementById('view-report-btn').style.display = 'none';
                limpiarPantalla();
            }).catch(error => alert('Error al cerrar: ' + error.message));
        }

        function guardarFechaProximoCambio(uid, fecha) {
            db.collection('users').doc(uid).update({ fechaProximoCambio: fecha.toISOString() }).catch(console.error);
        }

        function programarNotificacion(uid) {
            db.collection('users').doc(uid).get()
                .then(doc => {
                    if (doc.exists && doc.data().fechaProximoCambio) {
                        const fechaCambio = new Date(doc.data().fechaProximoCambio);
                        const diasRestantes = Math.ceil((fechaCambio - new Date()) / (1000 * 60 * 60 * 24));
                        if (diasRestantes <= 3 && diasRestantes > 0) {
                            const preferencia = doc.data().notificacionPreferencia;
                            if (preferencia === 'email') {
                                console.log(`Correo a ${doc.data().email}: ${diasRestantes} d칤as para cambio.`);
                            } else if (preferencia === 'movil' && doc.data().fcmToken && Notification.permission === 'granted') {
                                new Notification('JCALCULO', {
                                    body: `Faltan ${diasRestantes} d칤as para el cambio de pezoneras.`,
                                    icon: document.getElementById('app-logo').src || '/path/to/default-icon.png'
                                });
                            }
                        }
                    }
                }).catch(console.error);
        }

        function mostrarRegistro() {
            toggleSections(['registro-section'], ['login-section']);
        }

        function mostrarLoginUsuario() {
            toggleSections(['login-section'], ['registro-section']);
        }

        function mostrarLoginAdmin() {
            toggleSections(['admin-login']);
        }

        function loginAdmin() {
            const email = document.getElementById('admin-email').value.trim();
            const password = document.getElementById('admin-password').value.trim();

            if (!email || !password) {
                alert('Completa todos los campos.');
                return;
            }

            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    if (userCredential.user.uid === ADMIN_UID) {
                        isAdminLoggedIn = true;
                        toggleSections(['admin-form'], ['admin-login']);
                        cargarHistorialAdmin();
                    } else {
                        alert('Acceso denegado.');
                        auth.signOut();
                    }
                }).catch(error => alert('Error: ' + error.message));
        }

        function cerrarSesionAdmin() {
            auth.signOut().then(() => {
                isAdminLoggedIn = false;
                toggleSections([], ['admin-form']);
                document.getElementById('admin-email').value = '';
                document.getElementById('admin-password').value = '';
            }).catch(error => alert('Error: ' + error.message));
        }

        function mostrarCamposLogo() {
            const source = document.getElementById('logo-source').value;
            toggleSections([`logo-${source}-section`], [`logo-${source === 'url' ? 'upload' : 'url'}-section`]);
        }

        function guardarLogo() {
            const source = document.getElementById('logo-source').value;
            let logoUrl = '';

            if (source === 'url') {
                logoUrl = document.getElementById('logo-url').value.trim();
                if (!logoUrl) {
                    alert('Ingresa una URL v치lida.');
                    return;
                }
                db.collection('config').doc('logo').set({ url: logoUrl })
                    .then(() => {
                        alert('Logo guardado.');
                        cargarLogo();
                    }).catch(error => alert('Error: ' + error.message));
            } else {
                const file = document.getElementById('logo-upload').files[0];
                if (!file) {
                    alert('Selecciona una imagen.');
                    return;
                }
                const storageRef = storage.ref(`logos/logo-${Date.now()}`);
                storageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL())
                    .then(url => {
                        return db.collection('config').doc('logo').set({ url });
                    })
                    .then(() => {
                        alert('Logo guardado.');
                        cargarLogo();
                    }).catch(error => alert('Error: ' + error.message));
            }
        }

        function mostrarCamposPublicidad() {
            const type = document.getElementById('ad-type').value;
            toggleSections([`ad-${type}`], [`ad-${type === 'texto' ? 'imagen' : 'texto'}`]);
        }

        function mostrarCamposImagen() {
            const source = document.getElementById('ad-imagen-source').value;
            toggleSections([`ad-imagen-${source}-section`], [`ad-imagen-${source === 'url' ? 'upload' : 'url'}-section`]);
        }

        function guardarPublicidad() {
            const type = document.getElementById('ad-type').value;
            let content = '';

            if (type === 'texto') {
                content = document.getElementById('ad-texto-content').value.trim();
                if (!content) {
                    alert('Ingresa el texto.');
                    return;
                }
                db.collection('config').doc('publicidad').set({ type, content })
                    .then(() => {
                        alert('Publicidad guardada.');
                        cargarPublicidad();
                    }).catch(error => alert('Error: ' + error.message));
            } else {
                const source = document.getElementById('ad-imagen-source').value;
                if (source === 'url') {
                    content = document.getElementById('ad-imagen-url').value.trim();
                    if (!content) {
                        alert('Ingresa una URL.');
                        return;
                    }
                    db.collection('config').doc('publicidad').set({ type, content })
                        .then(() => {
                            alert('Publicidad guardada.');
                            cargarPublicidad();
                        }).catch(error => alert('Error: ' + error.message));
                } else {
                    const file = document.getElementById('ad-imagen-upload').files[0];
                    if (!file) {
                        alert('Selecciona una imagen.');
                        return;
                    }
                    const storageRef = storage.ref(`publicidad/principal-${Date.now()}`);
                    storageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL())
                        .then(url => {
                            return db.collection('config').doc('publicidad').set({ type, content: url });
                        })
                        .then(() => {
                            alert('Publicidad guardada.');
                            cargarPublicidad();
                        }).catch(error => alert('Error: ' + error.message));
                }
            }
        }

        function mostrarCamposImagenSecundaria() {
            const source = document.getElementById('ad-secundaria-source').value;
            toggleSections([`ad-secundaria-${source}-section`], [`ad-secundaria-${source === 'url' ? 'upload' : 'url'}-section`]);
        }

        function guardarPublicidadSecundaria() {
            const link = document.getElementById('ad-secundaria-link').value.trim();
            if (!link) {
                alert('Ingresa un enlace.');
                return;
            }

            const source = document.getElementById('ad-secundaria-source').value;
            if (source === 'url') {
                const imagen = document.getElementById('ad-secundaria-imagen-url').value.trim();
                if (!imagen) {
                    alert('Ingresa una URL.');
                    return;
                }
                db.collection('config').doc('publicidad-secundaria').set({ imagen, link })
                    .then(() => {
                        alert('Publicidad secundaria guardada.');
                        cargarPublicidadSecundaria();
                    }).catch(error => alert('Error: ' + error.message));
            } else {
                const file = document.getElementById('ad-secundaria-imagen-upload').files[0];
                if (!file) {
                    alert('Selecciona una imagen.');
                    return;
                }
                const storageRef = storage.ref(`publicidad/secundaria-${Date.now()}`);
                storageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL())
                    .then(imagen => {
                        return db.collection('config').doc('publicidad-secundaria').set({ imagen, link });
                    })
                    .then(() => {
                        alert('Publicidad secundaria guardada.');
                        cargarPublicidadSecundaria();
                    }).catch(error => alert('Error: ' + error.message));
            }
        }

        function guardarPopupMessage() {
            const message = document.getElementById('popup-message-content').value.trim();
            if (!message) {
                alert('Ingresa un mensaje.');
                return;
            }
            db.collection('config').doc('popup').set({ message })
                .then(() => {
                    alert('Mensaje guardado.');
                    cargarPopupMessage();
                }).catch(error => alert('Error: ' + error.message));
        }

        function probarNotificacion() {
            if (Notification.permission === 'granted') {
                new Notification('JCALCULO - Prueba', {
                    body: 'Esta es una notificaci칩n de prueba.',
                    icon: document.getElementById('app-logo').src || '/path/to/default-icon.png'
                });
            } else {
                alert('Permite las notificaciones para probar.');
                solicitarPermisoNotificaciones();
            }
        }

        function verificarUsuario() {
            const email = document.getElementById('user-verification-email').value.trim();
            if (!email) {
                alert('Ingresa un correo.');
                return;
            }

            db.collection('users').where('email', '==', email).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        alert('Usuario no encontrado.');
                        return;
                    }
                    snapshot.forEach(doc => {
                        db.collection('users').doc(doc.id).update({ isVerified: true })
                            .then(() => {
                                alert('Usuario verificado.');
                                if (currentUser && currentUser.email === email) {
                                    isVerifiedUser = true;
                                    document.getElementById('verified-badge').style.display = 'inline-block';
                                    toggleSections([], ['adsense-section']);
                                    cargarPublicidad();
                                    cargarPublicidadSecundaria();
                                }
                            }).catch(error => alert('Error: ' + error.message));
                    });
                }).catch(error => alert('Error: ' + error.message));
        }

        function quitarVerificacionUsuario() {
            const email = document.getElementById('user-verification-email').value.trim();
            if (!email) {
                alert('Ingresa un correo.');
                return;
            }

            db.collection('users').where('email', '==', email).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        alert('Usuario no encontrado.');
                        return;
                    }
                    snapshot.forEach(doc => {
                        db.collection('users').doc(doc.id).update({ isVerified: false })
                            .then(() => {
                                alert('Verificaci칩n retirada.');
                                if (currentUser && currentUser.email === email) {
                                    isVerifiedUser = false;
                                    document.getElementById('verified-badge').style.display = 'none';
                                    toggleSections(['adsense-section']);
                                    cargarPublicidad();
                                    cargarPublicidadSecundaria();
                                }
                            }).catch(error => alert('Error: ' + error.message));
                    });
                }).catch(error => alert('Error: ' + error.message));
        }

        function registrarAdmin() {
            const nombre = document.getElementById('admin-nombre').value.trim();
            const email = document.getElementById('admin-registro-email').value.trim();
            const password = document.getElementById('admin-registro-password').value.trim();

            if (!nombre || !email || !password) {
                alert('Completa todos los campos.');
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    return Promise.all([
                        db.collection('users').doc(user.uid).set({
                            nombre,
                            email,
                            isAdmin: true,
                            timestamp: new Date().toISOString()
                        }),
                        user.sendEmailVerification()
                    ]);
                })
                .then(() => {
                    alert('Admin registrado. Verifica el correo.');
                    document.getElementById('admin-nombre').value = '';
                    document.getElementById('admin-registro-email').value = '';
                    document.getElementById('admin-registro-password').value = '';
                }).catch(error => alert('Error: ' + error.message));
        }
    </script>
</body>
</html>
