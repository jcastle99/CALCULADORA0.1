<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JCALCULO</title>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script&display=swap" rel="stylesheet">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-messaging-compat.js"></script>
    <!-- SheetJS para exportar a Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Chart.js para grÃ¡ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Cookie Consent for AdSense -->
    <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #005566;
            color: #333;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            max-width: 700px;
            width: 100%;
            margin: 0 auto;
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
            box-sizing: border-box;
        }
        .logo {
            display: block;
            margin: 0 auto 20px;
            width: 150px;
        }
        h1 {
            text-align: center;
            color: #005566;
            font-size: 24px;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin: 10px 0 5px;
            font-weight: bold;
            color: #005566;
        }
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 14px;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #005566;
            outline: none;
        }
        button {
            width: 100%;
            padding: 10px;
            background: #005566;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 14px;
        }
        button:hover {
            background: #003d4a;
        }
        #resultado {
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .modificacion-campos {
            display: none;
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin-top: 10px;
        }
        #whatsapp-section, #donaciones-section {
            display: none;
            margin-top: 20px;
        }
        .signature {
            text-align: center;
            margin-top: 20px;
            font-family: 'Dancing Script', cursive;
            font-size: 28px;
            color: #005566;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }
        .popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .popup-content {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            position: relative;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }
        .popup-content h2 {
            color: #005566;
            margin-top: 0;
        }
        .popup-content p {
            margin: 10px 0;
        }
        .popup-content a {
            color: #005566;
            text-decoration: underline;
        }
        .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 24px;
            cursor: pointer;
            color: #333;
        }
        .admin-link {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            color: #005566;
            text-decoration: none;
            opacity: 0.5;
        }
        .admin-link:hover {
            opacity: 1;
        }
        #publicidad-section {
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        #publicidad-section img {
            max-width: 100%;
            height: auto;
        }
        #donaciones-section {
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 5px;
            text-align: center;
            display: none;
        }
        #donaciones-section img {
            max-width: 300px;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        #admin-form {
            display: none;
            margin-top: 20px;
        }
        #admin-login {
            display: none;
            margin-top: 20px;
        }
        .admin-loading {
            text-align: center;
            color: #005566;
            font-style: italic;
            margin-top: 10px;
        }
        #registro-section {
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 5px;
        }
        #login-section {
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 5px;
            display: none;
        }
        #user-section {
            display: none;
            margin-top: 20px;
        }
        #formulario-section {
            display: none;
        }
        .auth-message {
            text-align: center;
            margin-bottom: 20px;
            color: #005566;
        }
        #calculos-registrados {
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 5px;
        }
        #calculos-registrados ul {
            list-style: none;
            padding: 0;
        }
        #calculos-registrados li {
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
        }
        #admin-calculos {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 5px;
        }
        #admin-calculos ul {
            list-style: none;
            padding: 0;
        }
        #admin-calculos li {
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
        }
        #admin-registro {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 5px;
        }
        #calculator-info {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%);
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        #calculator-info h3 {
            color: #005566;
            font-size: 20px;
            margin-bottom: 10px;
        }
        #calculator-info p {
            color: #333;
            font-size: 14px;
            line-height: 1.5;
        }
        #calculator-info strong {
            color: #d32f2f;
        }
        .verified-badge {
            display: inline-block;
            background: #28a745;
            color: #fff;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 5px;
        }
        #export-excel-btn, #view-report-btn {
            background: #28a745;
            margin-top: 10px;
        }
        #export-excel-btn:hover, #view-report-btn:hover {
            background: #218838;
        }
        #report-section {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        #report-canvas {
            max-width: 100%;
        }
        .adsense-fallback {
            text-align: center;
            color: #d32f2f;
            font-style: italic;
            margin-top: 10px;
            display: none;
        }
        .footer-links {
            text-align: center;
            margin-top: 20px;
            font-size: 12px;
        }
        .footer-links a {
            color: #005566;
            text-decoration: none;
            margin: 0 10px;
        }
        .footer-links a:hover {
            text-decoration: underline;
        }
        /* Nuevos estilos */
        #benefits-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1001;
            justify-content: center;
            align-items: center;
        }
        #benefits-popup .popup-content {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        #benefits-popup h2 {
            color: #005566;
            margin-top: 0;
        }
        #benefits-popup ul {
            text-align: left;
            margin: 10px 0;
            padding-left: 20px;
        }
        #benefits-popup button {
            background: #28a745;
        }
        #benefits-popup button:hover {
            background: #218838;
        }
        #admin-users-section {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #f0f0f0;
            border-radius: 5px;
        }
        #admin-users-section table {
            width: 100%;
            border-collapse: collapse;
        }
        #admin-users-section th, #admin-users-section td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
        #admin-users-section th {
            background: #005566;
            color: #fff;
        }
        #admin-users-section select {
            padding: 5px;
            margin-bottom: 10px;
        }
        #admin-users-section .action-btn {
            background: #d32f2f;
            padding: 5px 10px;
            font-size: 12px;
        }
        #admin-users-section .action-btn:hover {
            background: #b71c1c;
        }
        .delete-calc-btn {
            background: #d32f2f;
            padding: 5px 10px;
            font-size: 12px;
            margin-left: 10px;
            display: inline-block;
        }
        .delete-calc-btn:hover {
            background: #b71c1c;
        }
    </style>
</head>
<body>
    <!-- Pop-up inicial -->
    <div id="popup" class="popup">
        <div class="popup-content">
            <span class="close-btn" onclick="cerrarPopup()">Ã</span>
            <h2 id="popup-title">Â¡Optimiza tu producciÃ³n con JCALCULO!</h2>
            <p id="popup-message">Descubre la herramienta que revoluciona la gestiÃ³n de pezoneras. Â¡RegÃ­strate y toma el control hoy!</p>
            <p id="popup-contact">ð§ Soporte: <a href="mailto:alfstiven@gmail.com">alfstiven@gmail.com</a></p>
        </div>
    </div>

    <!-- Pop-up de beneficios para no verificados -->
    <div id="benefits-popup" class="popup">
        <div class="popup-content">
            <span class="close-btn" onclick="cerrarBenefitsPopup()">Ã</span>
            <h2>Â¡ConviÃ©rtete en usuario verificado!</h2>
            <p>Disfruta de beneficios exclusivos:</p>
            <ul>
                <li>ð GrÃ¡fico de desgaste de pezoneras</li>
                <li>ðï¸ Eliminar cÃ¡lculos guardados</li>
                <li>ð« Experiencia sin publicidad</li>
                <li>ð Reportes premium y exportaciÃ³n a Excel</li>
            </ul>
            <p>Contacta al administrador para verificar tu cuenta.</p>
            <button onclick="cerrarBenefitsPopup()">Entendido</button>
        </div>
    </div>

    <div class="container">
        <a href="#" class="admin-link" onclick="mostrarLoginAdmin()">Admin</a>
        <img id="app-logo" class="logo" style="display: none;" alt="Logo de JCALCULO">
        <h1>JCALCULO</h1>

        <div id="auth-message" class="auth-message">
            Por favor, regÃ­strate o inicia sesiÃ³n para usar la calculadora.
        </div>

        <div id="calculator-info">
            <h3>Â¡Gestiona tus Pezoneras como Nunca Antes! ð</h3>
            <p>Con <strong>JCALCULO</strong>, optimiza el cambio de tus pezoneras de manera fÃ¡cil y precisa. Nuestra herramienta calcula el nÃºmero exacto de pezoneras necesarias, estima su durabilidad y te <strong>notifica el prÃ³ximo cambio</strong> para que nunca pierdas el control. ð Ahorra tiempo, mejora la eficiencia de tu ordeÃ±o y lleva tu producciÃ³n al siguiente nivel. Â¡ConfÃ­a en JCALCULO, la soluciÃ³n que todo ganadero necesita! ð</p>
        </div>

        <div id="registro-section">
            <h3>RegÃ­strate</h3>
            <label for="nombre">Nombre:</label>
            <input type="text" id="nombre" placeholder="Tu nombre" required>
            <label for="profesion">ProfesiÃ³n:</label>
            <select id="profesion" onchange="mostrarCamposProfesion()" required>
                <option value="" selected>Selecciona...</option>
                <option value="ganadero">Ganadero</option>
                <option value="tecnico">TÃ©cnico</option>
                <option value="otro">Otro</option>
            </select>
            <div id="empresa-section" style="display: none;">
                <label for="empresa">Nombre de la Granja o ExplotaciÃ³n:</label>
                <input type="text" id="empresa" placeholder="Nombre de la granja o explotaciÃ³n" required>
            </div>
            <div id="otra-profesion-section" style="display: none;">
                <label for="otra-profesion">Especifica tu ProfesiÃ³n:</label>
                <input type="text" id="otra-profesion" placeholder="Escribe tu profesiÃ³n">
            </div>
            <label for="telefono">NÃºmero de Celular o TelÃ©fono:</label>
            <input type="tel" id="telefono" placeholder="Ej. +573001234567" pattern="[0-9+]+" required>
            <label for="email">Correo ElectrÃ³nico:</label>
            <input type="email" id="email" placeholder="tu@correo.com" required>
            <label for="password">ContraseÃ±a:</label>
            <input type="password" id="password" placeholder="ContraseÃ±a" required>
            <button type="button" onclick="registrarUsuario()">Registrarse</button>
            <p>Â¿Ya tienes cuenta? <a href="#" onclick="mostrarLoginUsuario()">Inicia sesiÃ³n</a></p>
        </div>

        <div id="login-section">
            <h3>Iniciar SesiÃ³n</h3>
            <label for="login-email">Correo ElectrÃ³nico:</label>
            <input type="email" id="login-email" placeholder="tu@correo.com" required>
            <label for="login-password">ContraseÃ±a:</label>
            <input type="password" id="login-password" placeholder="ContraseÃ±a" required>
            <button type="button" onclick="loginUsuario()">Iniciar SesiÃ³n</button>
            <p><a href="#" onclick="recuperarContrasena()">Â¿Olvidaste tu contraseÃ±a?</a></p>
            <p>Â¿No tienes cuenta? <a href="#" onclick="mostrarRegistro()">RegÃ­strate</a></p>
        </div>

        <div id="user-section">
            <h3>Bienvenido, <span id="user-name">Usuario</span><span id="verified-badge" class="verified-badge" style="display: none;">Verificado</span></h3>
            <p>ProfesiÃ³n: <span id="user-profesion">N/A</span></p>
            <label for="notificacion-preferencia">Notificarme sobre el cambio de pezoneras:</label>
            <select id="notificacion-preferencia">
                <option value="email">Por Correo ElectrÃ³nico</option>
                <option value="movil">Por NotificaciÃ³n MÃ³vil</option>
                <option value="ninguna">No notificar</option>
            </select>
            <button type="button" onclick="guardarPreferenciaNotificacion()">Guardar Preferencia</button>
            <button type="button" onclick="cerrarSesionUsuario()">Cerrar SesiÃ³n</button>
        </div>

        <div id="formulario-section">
            <form id="formulario">
                <label for="ordenosDia">OrdeÃ±os por DÃ­a:</label>
                <input type="number" id="ordenosDia" required>
                <label for="puntosOrdeno">Puntos de OrdeÃ±o (Inicial):</label>
                <input type="number" id="puntosOrdeno" required>
                <label for="vacas">Vacas OrdeÃ±adas (Inicial):</label>
                <input type="number" id="vacas" required>
                <label for="durabilidad">Durabilidad de Pezoneras por OrdeÃ±o por Punto:</label>
                <input type="number" id="durabilidad" value="2500" required>
                <label for="fechaInicio">Fecha de Inicio (opcional):</label>
                <input type="date" id="fechaInicio" placeholder="YYYY-MM-DD">
                <label for="diasEspecificos">Calcular para DÃ­as EspecÃ­ficos ( opcional):</label>
                <input type="number" id="diasEspecificos" placeholder="NÃºmero de dÃ­as">
                <label for="realizarModificacion">Â¿Modificar Vacas o Puntos?</label>
                <select id="realizarModificacion" onchange="mostrarCamposModificacion()">
                    <option value="no">No</option>
                    <option value="si">SÃ­</option>
                </select>
                <div id="modificacion-campos" class="modificacion-campos">
                    <label for="fechaCambio">Fecha de Cambio:</label>
                    <input type="date" id="fechaCambio" placeholder="YYYY-MM-DD">
                    <label for="nuevoNumeroVacas">Nuevo NÃºmero de Vacas:</label>
                    <input type="number" id="nuevoNumeroVacas" placeholder="Nuevo nÃºmero de vacas">
                    <label for="nuevoPuntosOrdeno">Nuevo NÃºmero de Puntos:</label>
                    <input type="number" id="nuevoPuntosOrdeno" placeholder="Nuevo nÃºmero de puntos">
                </div>
                <button type="button" onclick="calcular()">Calcular</button>
                <button type="button" onclick="limpiarPantalla()">Limpiar</button>
            </form>
            <div id="resultado"></div>
            <button id="guardar-resultado" style="display: none;" onclick="guardarResultado()">Guardar Resultado</button>
            <div id="calculos-registrados">
                <h3>CÃ¡lculos Guardados</h3>
                <button id="export-excel-btn" style="display: none;" onclick="exportarCalculosExcel()">Exportar a Excel</button>
                <button id="view-report-btn" style="display: none;" onclick="mostrarReporteGrafico()">Ver Reporte GrÃ¡fico</button>
                <ul id="lista-calculos"></ul>
            </div>
            <div id="report-section">
                <h3>AnÃ¡lisis de Desgaste de Pezoneras</h3>
                <canvas id="report-canvas"></canvas>
            </div>
        </div>

        <div id="adsense-section" style="margin-top: 20px; text-align: center; display: none;">
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6163239656988692"></script>
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="ca-pub-6163239656988692"
                 data-ad-slot="YOUR_AD_SLOT_ID"
                 data-ad-format="auto"></ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
            <div class="adsense-fallback">No se pudo cargar el anuncio. Por favor, revisa tu conexiÃ³n o desactiva el bloqueador de anuncios.</div>
        </div>

        <div id="publicidad-section"></div>

        <div id="admin-login" style="display: none; margin-top: 20px;">
            <h3>Iniciar SesiÃ³n (Admin)</h3>
            <label for="admin-email">Correo ElectrÃ³nico:</label>
            <input type="email" id="admin-email" placeholder="alfstiven@gmail.com">
            <label for="admin-password">ContraseÃ±a:</label>
            <input type="password" id="admin-password" placeholder="ContraseÃ±a">
            <button type="button" onclick="loginAdmin()">Iniciar SesiÃ³n</button>
            <div id="admin-login-loading" class="admin-loading" style="display: none;">Cargando...</div>
        </div>

        <div id="admin-form" style="display: none;">
            <h3>Administrar ConfiguraciÃ³n</h3>
            <h4>Actualizar Logo</h4>
            <label for="logo-source">Fuente del Logo:</label>
            <select id="logo-source" onchange="mostrarCamposLogo()">
                <option value="url">URL</option>
                <option value="upload">Subir desde el dispositivo</option>
            </select>
            <div id="logo-url-section" style="display: block;">
                <label for="logo-url">URL del Logo:</label>
                <input type="text" id="logo-url" placeholder="Ingresa la URL del logo">
            </div>
            <div id="logo-upload-section" style="display: none;">
                <label for="logo-upload">Subir Logo:</label>
                <input type="file" id="logo-upload" accept="image/*">
            </div>
            <button type="button" onclick="guardarLogo()">Guardar Logo</button>

            <h4>Publicidad Principal (Texto o Imagen)</h4>
            <label for="ad-type">Tipo de Publicidad:</label>
            <select id="ad-type" onchange="mostrarCamposPublicidad()">
                <option value="texto">Texto</option>
                <option value="imagen">Imagen</option>
            </select>
            <div id="ad-texto" style="display: block;">
                <label for="ad-texto-content">Texto de la Publicidad:</label>
                <textarea id="ad-texto-content" placeholder="Escribe el texto de la publicidad"></textarea>
            </div>
            <div id="ad-imagen" style="display: none;">
                <label for="ad-imagen-source">Fuente de la Imagen:</label>
                <select id="ad-imagen-source" onchange="mostrarCamposImagen()">
                    <option value="url">URL</option>
                    <option value="upload">Subir desde el dispositivo</option>
                </select>
                <div id="ad-imagen-url-section" style="display: block;">
                    <label for="ad-imagen-url">URL de la Imagen:</label>
                    <input type="text" id="ad-imagen-url" placeholder="Ingresa la URL de la imagen (opcional)">
                </div>
                <div id="ad-imagen-upload-section" style="display: none;">
                    <label for="ad-imagen-upload">Subir Imagen:</label>
                    <input type="file" id="ad-imagen-upload" accept="image/*">
                </div>
            </div>
            <button type="button" onclick="guardarPublicidad()">Guardar Publicidad Principal</button>

            <h4>Publicidad Secundaria (Imagen con Enlace)</h4>
            <label for="ad-secundaria-source">Fuente de la Imagen:</label>
            <select id="ad-secundaria-source" onchange="mostrarCamposImagenSecundaria()">
                <option value="url">URL</option>
                <option value="upload">Subir desde el dispositivo</option>
            </select>
            <div id="ad-secundaria-url-section" style="display: block;">
                <label for="ad-secundaria-imagen-url">URL de la Imagen:</label>
                <input type="text" id="ad-secundaria-imagen-url" placeholder="Ingresa la URL de la imagen (opcional)">
            </div>
            <div id="ad-secundaria-upload-section" style="display: none;">
                <label for="ad-secundaria-imagen-upload">Subir Imagen:</label>
                <input type="file" id="ad-secundaria-imagen-upload" accept="image/*">
            </div>
            <label for="ad-secundaria-link">Enlace de la Publicidad:</label>
            <input type="text" id="ad-secundaria-link" placeholder="Ingresa el enlace (ej. https://ejemplo.com)">
            <button type="button" onclick="guardarPublicidadSecundaria()">Guardar Publicidad Secundaria</button>

            <h4>Mensaje del Pop-up</h4>
            <label for="popup-message-content">Mensaje del Pop-up:</label>
            <textarea id="popup-message-content" placeholder="Escribe el mensaje del pop-up"></textarea>
            <button type="button" onclick="guardarPopupMessage()">Guardar Mensaje del Pop-up</button>

            <h4>Probar NotificaciÃ³n</h4>
            <button type="button" onclick="probarNotificacion()">Enviar NotificaciÃ³n de Prueba</button>

            <h4>Gestionar Usuarios Verificados</h4>
            <label for="user-verification-email">Correo del Usuario:</label>
            <input type="email" id="user-verification-email" placeholder="correo@ejemplo.com">
            <button type="button" onclick="verificarUsuario()">Asignar Insignia de Verificado</button>
            <button type="button" onclick="quitarVerificacionUsuario()">Quitar Insignia de Verificado</button>

            <div id="admin-users-section">
                <h4>Lista de Usuarios</h4>
                <label for="user-filter">Filtrar por:</label>
                <select id="user-filter" onchange="filtrarUsuarios()">
                    <option value="all">Todos</option>
                    <option value="verified">Verificados</option>
                    <option value="unverified">No Verificados</option>
                </select>
                <table id="users-table">
                    <thead>
                        <tr>
                            <th>Correo</th>
                            <th>Estado</th>
                            <th>Fecha VerificaciÃ³n</th>
                            <th>Fecha Caducidad</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body"></tbody>
                </table>
            </div>

            <h4>Cancelar Modificaciones</h4>
            <label for="cancel-user-email">Correo del Usuario:</label>
            <input type="email" id="cancel-user-email" placeholder="correo@ejemplo.com">
            <label for="cancel-calc-id">ID del CÃ¡lculo:</label>
            <input type="text" id="cancel-calc-id" placeholder="ID del cÃ¡lculo">
            <button type="button" onclick="cancelarModificacion()">Cancelar ModificaciÃ³n</button>

            <div id="admin-registro">
                <h4>Registrar Nuevo Administrador</h4>
                <label for="admin-nombre">Nombre:</label>
                <input type="text" id="admin-nombre" placeholder="Nombre del administrador">
                <label for="admin-registro-email">Correo ElectrÃ³nico:</label>
                <input type="email" id="admin-registro-email" placeholder="correo@ejemplo.com">
                <label for="admin-registro-password">ContraseÃ±a:</label>
                <input type="password" id="admin-registro-password" placeholder="ContraseÃ±a">
                <button type="button" onclick="registrarAdmin()">Registrar Administrador</button>
            </div>

            <div id="admin-calculos">
                <h4>Historial de CÃ¡lculos</h4>
                <button type="button" onclick="exportarHistorialExcel()">Exportar a Excel</button>
                <h5>Usuarios con cambio este mes:</h5>
                <ul id="lista-calculos-admin"></ul>
            </div>

            <button type="button" onclick="cerrarSesionAdmin()">Cerrar SesiÃ³n</button>
        </div>

        <div id="whatsapp-section">
            <label for="codigoCliente">CÃ³digo del Cliente:</label>
            <input type="text" id="codigoCliente" placeholder="Ingresa el cÃ³digo del cliente" required>
            <button type="button" onclick="enviarWhatsApp()">Enviar por WhatsApp</button>
        </div>

        <div id="donaciones-section" style="text-align: center;"></div>

        <div style="margin-top: 20px; text-align: center;">
            <p>Â¿Necesitas pezoneras nuevas? <a href="/comprar-pezoneras" target="_blank">Compra aquÃ­</a>.</p>
        </div>

        <div class="signature">J.Castle</div>

        <div class="footer-links">
            <a href="/politica-de-privacidad.html" target="_blank">PolÃ­tica de Privacidad</a>
        </div>
    </div>
<script>
    // ConfiguraciÃ³n de Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyDokCTsjDgQ94nu23rXf_HkvLeXpZmJU2c",
        authDomain: "jcalculador-ac481.firebaseapp.com",
        projectId: "jcalculador-ac481",
        storageBucket: "jcalculador-ac481.firebasestorage.app",
        messagingSenderId: "597989051329",
        appId: "1:597989051329:web:33b32c795cf7f51c63bd40",
        measurementId: "G-X4Z78DYMLD"
    };

    // Inicializar Firebase
    let app, auth, db, storage, messaging;
    try {
        app = firebase.initializeApp(firebaseConfig);
        auth = firebase.auth();
        db = firebase.firestore();
        storage = firebase.storage();
        messaging = firebase.messaging();
        console.log("Firebase inicializado correctamente.");
    } catch (error) {
        console.error("Error al inicializar Firebase:", error);
        alert("Error al cargar la aplicaciÃ³n. Por favor, revisa la consola para mÃ¡s detalles.");
    }

    let resultadoTexto = '';
    let vacasIniciales = 0;
    let puntosOrdenoIniciales = 0;
    let totalPezoneras = 0;
    let isAdminLoggedIn = false;
    let fechaProximoCambio = null;
    let currentUser = null;
    let adminUser = null;
    let isVerifiedUser = false;
    let calculosData = [];

    const ADMIN_UID = 'KBb7nqyZFIMDDFHEGdX31stvp1L2';
    const ADMIN_EMAIL = 'alfstiven@gmail.com';

    // Inicializar Cookie Consent
    window.addEventListener("load", function(){
        try {
            window.cookieconsent.initialise({
                "palette": {
                    "popup": { "background": "#005566" },
                    "button": { "background": "#28a745" }
                },
                "position": "bottom-right",
                "content": {
                    "message": "Este sitio utiliza cookies para mostrar anuncios personalizados a travÃ©s de Google AdSense. Al continuar navegando, aceptas nuestra polÃ­tica de privacidad.",
                    "dismiss": "Aceptar",
                    "link": "Ver PolÃ­tica de Privacidad",
                    "href": "/politica-de-privacidad.html"
                },
                onStatusChange: function(status) {
                    if (status === 'accept') {
                        const adsenseSection = document.getElementById('adsense-section');
                        if (adsenseSection) {
                            adsenseSection.style.display = isVerifiedUser ? 'none' : 'block';
                        }
                    }
                }
            });
            console.log("Cookie Consent inicializado.");
        } catch (error) {
            console.error("Error al inicializar Cookie Consent:", error);
        }
    });

    function solicitarPermisoNotificaciones() {
        if (!('Notification' in window)) {
            console.log("Este navegador no soporta notificaciones.");
            return;
        }
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                console.log('Permiso de notificaciones concedido.');
                messaging.getToken({ vapidKey: 'BCaTUfW00kYdZyQ2BqdbR6HeTnAZtpxRWrF3jscJQXz4-3SaDNP2Z-y8EtWMtEu6DeUNekFhZQCQOYqRmEn-9Xg' }).then(token => {
                    console.log('Token FCM:', token);
                    if (currentUser) {
                        db.collection('users').doc(currentUser.uid).update({
                            fcmToken: token
                        }).catch(error => {
                            console.error('Error al guardar el token FCM:', error);
                        });
                    }
                }).catch(error => {
                    console.error('Error al obtener el token FCM:', error);
                });
            } else {
                console.log('Permiso de notificaciones denegado.');
            }
        }).catch(error => {
            console.error('Error al solicitar permiso de notificaciones:', error);
        });
    }

    function cargarLogo() {
        try {
            db.collection('config').doc('logo').get()
                .then(doc => {
                    if (doc.exists) {
                        const logoUrl = doc.data().url;
                        const logoElement = document.getElementById('app-logo');
                        if (logoElement) {
                            logoElement.src = logoUrl;
                            logoElement.style.display = 'block';
                        }
                    } else {
                        document.getElementById('app-logo').style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error al cargar el logo:', error);
                    document.getElementById('app-logo').style.display = 'none';
                });
        } catch (error) {
            console.error("Error en cargarLogo:", error);
        }
    }
    window.onload = function() {
        try {
            const popup = document.getElementById('popup');
            if (popup) {
                popup.style.display = 'flex';
            }
            cargarLogo();
            cargarPublicidad();
            cargarPublicidadSecundaria();
            cargarPopupMessage();

            auth.onAuthStateChanged(user => {
                if (user) {
                    if (!user.emailVerified) {
                        alert('Por favor, verifica tu correo electrÃ³nico para continuar.');
                        auth.signOut();
                        return;
                    }
                    currentUser = user;
                    cargarDatosUsuario(user.uid);
                    document.getElementById('registro-section').style.display = 'none';
                    document.getElementById('login-section').style.display = 'none';
                    document.getElementById('user-section').style.display = 'block';
                    document.getElementById('formulario-section').style.display = 'block';
                    document.getElementById('auth-message').style.display = 'none';
                    solicitarPermisoNotificaciones();
                    programarNotificacion(user.uid);
                    cargarCalculosGuardados(user.uid);
                    if (!isVerifiedUser) {
                        setTimeout(() => {
                            document.getElementById('benefits-popup').style.display = 'flex';
                        }, 5000);
                    }
                } else {
                    currentUser = null;
                    document.getElementById('registro-section').style.display = 'block';
                    document.getElementById('user-section').style.display = 'none';
                    document.getElementById('formulario-section').style.display = 'none';
                    document.getElementById('auth-message').style.display = 'block';
                    cargarPublicidad();
                    cargarPublicidadSecundaria();
                }
            });
        } catch (error) {
            console.error("Error en window.onload:", error);
        }
    };

    function cerrarPopup() {
        try {
            const popup = document.getElementById('popup');
            if (popup) {
                popup.style.display = 'none';
            }
        } catch (error) {
            console.error("Error en cerrarPopup:", error);
        }
    }

    function cerrarBenefitsPopup() {
        try {
            const benefitsPopup = document.getElementById('benefits-popup');
            if (benefitsPopup) {
                benefitsPopup.style.display = 'none';
            }
        } catch (error) {
            console.error("Error en cerrarBenefitsPopup:", error);
        }
    }
    function mostrarCamposModificacion() {
        try {
            const seleccion = document.getElementById('realizarModificacion').value;
            const modificacionCampos = document.getElementById('modificacion-campos');
            if (modificacionCampos) {
                modificacionCampos.style.display = seleccion === 'si' ? 'block' : 'none';
            }
        } catch (error) {
            console.error("Error en mostrarCamposModificacion:", error);
        }
    }

    function mostrarCamposProfesion() {
        try {
            const profesion = document.getElementById('profesion').value;
            const empresaSection = document.getElementById('empresa-section');
            const otraProfesionSection = document.getElementById('otra-profesion-section');

            if (empresaSection && otraProfesionSection) {
                empresaSection.style.display = profesion === 'ganadero' ? 'block' : 'none';
                otraProfesionSection.style.display = profesion === 'otro' ? 'block' : 'none';
            }
        } catch (error) {
            console.error("Error en mostrarCamposProfesion:", error);
        }
    }

    function calcular() {
        try {
            const ordenosDiaInput = document.getElementById('ordenosDia').value;
            const puntosOrdenoInput = document.getElementById('puntosOrdeno').value;
            const vacasInput = document.getElementById('vacas').value;
            const durabilidadInput = document.getElementById('durabilidad').value;
            const fechaInicioInput = document.getElementById('fechaInicio').value;
            const diasEspecificosInput = document.getElementById('diasEspecificos').value;
            const realizarModificacion = document.getElementById('realizarModificacion').value;
            const fechaCambioInput = document.getElementById('fechaCambio').value;
            const nuevoNumeroVacasInput = document.getElementById('nuevoNumeroVacas').value;
            const nuevoPuntosOrdenoInput = document.getElementById('nuevoPuntosOrdeno').value;

            const ordenosDia = parseInt(ordenosDiaInput) || 0;
            let puntosOrdeno = parseInt(puntosOrdenoInput) || 0;
            const vacas = parseInt(vacasInput) || 0;
            const durabilidad = parseInt(durabilidadInput) || 0;
            const diasEspecificos = parseInt(diasEspecificosInput) || 0;
            const nuevoNumeroVacas = parseInt(nuevoNumeroVacasInput) || 0;
            const nuevoPuntosOrdeno = parseInt(nuevoPuntosOrdenoInput) || 0;

            vacasIniciales = vacas;
            puntosOrdenoIniciales = puntosOrdeno;

            if (ordenosDia <= 0) {
                alert("Por favor, ingresa un nÃºmero vÃ¡lido de ordeÃ±os por dÃ­a (mayor que 0).");
                return;
            }
            if (puntosOrdeno <= 0) {
                alert("Por favor, ingresa un nÃºmero vÃ¡lido de puntos de ordeÃ±o (mayor que 0).");
                return;
            }
            if (vacas <= 0) {
                alert("Por favor, ingresa un nÃºmero vÃ¡lido de vacas ordeÃ±adas (mayor que 0).");
                return;
            }
            if (durabilidad <= 0) {
                alert("Por favor, ingresa una durabilidad vÃ¡lida para las pezoneras (mayor que 0).");
                return;
            }

            let fechaInicio = fechaInicioInput ? new Date(fechaInicioInput) : new Date();
            if (isNaN(fechaInicio.getTime())) {
                alert("Por favor, selecciona una fecha de inicio vÃ¡lida.");
                return;
            }

            if (diasEspecificos > 0 && ordenosDia === 0 && puntosOrdeno === 0 && vacas === 0) {
                const fechaDiasEspecificos = new Date(fechaInicio.getTime() + diasEspecificos * 86400000);
                resultadoTexto = `
                    Calculadora JCALCULO Cambio de Pezoneras
                    Fecha Inicio: ${fechaInicio.toLocaleDateString('es-ES')}
                    Fecha para ${diasEspecificos} DÃ­as: ${fechaDiasEspecificos.toLocaleDateString('es-ES')}
                `;
                mostrarResultados();
                return;
            }

            const ordeÃ±osTotalesPorDia = ordenosDia * vacas;
            const ordeÃ±osPorPuntoPorDia = ordeÃ±osTotalesPorDia / puntosOrdeno;
            const diasDurabilidadInicial = durabilidad / ordeÃ±osPorPuntoPorDia;

            const fechaProximoCambioInicial = new Date(fechaInicio);
            fechaProximoCambioInicial.setDate(fechaInicio.getDate() + Math.floor(diasDurabilidadInicial));

            let fechaDiasEspecificos = diasEspecificos > 0 ? `Fecha para ${diasEspecificos} DÃ­as: ${new Date(fechaInicio.getTime() + diasEspecificos * 86400000).toLocaleDateString('es-ES')}` : '';

            const diasEnMes = 30.42;
            const mesesEquivalentes = Math.round(diasDurabilidadInicial / diasEnMes);

            const pezonerasPorPunto = 4;
            totalPezoneras = puntosOrdeno * pezonerasPorPunto;
            let desgastePezonerasPorDiaInicial = totalPezoneras / diasDurabilidadInicial;

            let durabilidadAjustada = diasDurabilidadInicial;
            let fechaProximoCambioAjustada = fechaProximoCambioInicial;
            let desgastePezonerasPorDiaAjustada = desgastePezonerasPorDiaInicial;
            let mensajeAjuste = '';

            if (realizarModificacion === 'si' && fechaCambioInput && (nuevoNumeroVacas > 0 || nuevoPuntosOrdeno > 0)) {
                const fechaCambio = new Date(fechaCambioInput);
                if (isNaN(fechaCambio.getTime())) {
                    alert("Por favor, selecciona una fecha de cambio vÃ¡lida.");
                    return;
                }

                const diasTranscurridos = Math.floor((fechaCambio - fechaInicio) / (1000 * 60 * 60 * 24));

                if (diasTranscurridos < 0) {
                    alert("La fecha de cambio no puede ser anterior a la fecha de inicio.");
                    return;
                }

                const ordeÃ±osPorPuntoHastaCambio = ordeÃ±osPorPuntoPorDia * diasTranscurridos;
                const durabilidadRestante = durabilidad - ordeÃ±osPorPuntoHastaCambio;

                if (durabilidadRestante <= 0) {
                    mensajeAjuste = `Nota: Las pezoneras ya debieron cambiarse antes de ${fechaCambio.toLocaleDateString('es-ES')}.`;
                } else {
                    const vacasAjustadas = nuevoNumeroVacas > 0 ? nuevoNumeroVacas : vacas;
                    const puntosOrdenoAjustados = nuevoPuntosOrdeno > 0 ? nuevoPuntosOrdeno : puntosOrdeno;
                    totalPezoneras = puntosOrdenoAjustados * pezonerasPorPunto;
                    const nuevosOrdeÃ±osTotalesPorDia = ordenosDia * vacasAjustadas;
                    const nuevosOrdeÃ±osPorPuntoPorDia = nuevosOrdeÃ±osTotalesPorDia / puntosOrdenoAjustados;
                    const diasDurabilidadRestante = durabilidadRestante / nuevosOrdeÃ±osPorPuntoPorDia;

                    fechaProximoCambioAjustada = new Date(fechaCambio);
                    fechaProximoCambioAjustada.setDate(fechaCambio.getDate() + Math.floor(diasDurabilidadRestante));

                    durabilidadAjustada = diasTranscurridos + diasDurabilidadRestante;
                    desgastePezonerasPorDiaAjustada = totalPezoneras / durabilidadAjustada;

                    mensajeAjuste = `
                        Ajuste por ModificaciÃ³n:
                        Fecha de Cambio: ${fechaCambio.toLocaleDateString('es-ES')}
                        Nuevo NÃºmero de Vacas: ${vacasAjustadas}
                        Nuevo NÃºmero de Puntos: ${puntosOrdenoAjustados}
                        Durabilidad Ajustada: ${Math.floor(durabilidadAjustada)} dÃ­as
                        Nueva Fecha de Cambio: ${fechaProximoCambioAjustada.toLocaleDateString('es-ES')}
                        Total Pezoneras: ${totalPezoneras}
                        Desgaste por DÃ­a: ${desgastePezonerasPorDiaAjustada.toFixed(2)}
                    `;
                }
            }

            fechaProximoCambio = realizarModificacion === 'si' ? fechaProximoCambioAjustada : fechaProximoCambioInicial;

            resultadoTexto = isVerifiedUser ? `
                <div style="background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); padding: 15px; border-radius: 5px;">
                    <h3 style="color: #005566;">ð Reporte Premium JCALCULO</h3>
                    <p><strong>Fecha Inicio:</strong> ${fechaInicio.toLocaleDateString('es-ES')}</p>
                    <p><strong>Vacas Iniciales:</strong> ${vacasIniciales}</p>
                    <p><strong>Puntos Iniciales:</strong> ${puntosOrdenoIniciales}</p>
                    <p><strong>Durabilidad Inicial:</strong> ${Math.floor(diasDurabilidadInicial)} dÃ­as</p>
                    <p><strong>ð¨ PrÃ³ximo Cambio:</strong> ${fechaProximoCambioInicial.toLocaleDateString('es-ES')}</p>
                    <p><strong>Meses Equivalentes:</strong> ${mesesEquivalentes}</p>
                    ${fechaDiasEspecificos ? `<p><strong>Fecha EspecÃ­fica:</strong> ${fechaDiasEspecificos}</p>` : ''}
                    <p><strong>Total Pezoneras:</strong> ${totalPezoneras}</p>
                    <p><strong>Desgaste Diario:</strong> ${desgastePezonerasPorDiaInicial.toFixed(2)}</p>
                    ${mensajeAjuste ? `<p style="color: #d32f2f;"><strong>Ajustes Aplicados:</strong><br>${mensajeAjuste.replace(/\n/g, '<br>')}</p>` : ''}
                    <p style="font-style: italic;">Gracias por ser un usuario verificado. Â¡Disfruta de una experiencia sin publicidad y reportes avanzados!</p>
                </div>
            ` : `
                Calculadora JCALCULO Cambio de Pezoneras
                Fecha Inicio: ${fechaInicio.toLocaleDateString('es-ES')}
                Vacas Iniciales: ${vacasIniciales}
                Puntos Iniciales: ${puntosOrdenoIniciales}
                Durabilidad Inicial: ${Math.floor(diasDurabilidadInicial)} dÃ­as
                PrÃ³ximo Cambio Inicial: ${fechaProximoCambioInicial.toLocaleDateString('es-ES')}
                Meses Equivalentes: ${mesesEquivalentes}
                ${fechaDiasEspecificos}
                Total Pezoneras Inicial: ${totalPezoneras}
                Desgaste por DÃ­a Inicial: ${desgastePezonerasPorDiaInicial.toFixed(2)}
                ${mensajeAjuste}
            `;
            mostrarResultados();

            if (currentUser) {
                guardarFechaProximoCambio(currentUser.uid, fechaProximoCambio);
            }
        } catch (error) {
            console.error("Error en calcular:", error);
            alert("Error al realizar el cÃ¡lculo. Por favor, revisa la consola para mÃ¡s detalles.");
        }
    }

    function mostrarResultados() {
        try {
            const resultado = document.getElementById('resultado');
            const whatsappSection = document.getElementById('whatsapp-section');
            const guardarResultadoBtn = document.getElementById('guardar-resultado');

            if (resultado && whatsappSection && guardarResultadoBtn) {
                resultado.innerHTML = resultadoTexto.replace(/\n/g, '<br>');
                whatsappSection.style.display = 'block';
                guardarResultadoBtn.style.display = 'block';
            }
        } catch (error) {
            console.error("Error en mostrarResultados:", error);
        }
    }
    function enviarWhatsApp() {
        try {
            const codigoCliente = document.getElementById('codigoCliente').value.trim();
            if (!codigoCliente) {
                alert("Ingresa el cÃ³digo del cliente.");
                return;
            }
            const mensajeWhatsApp = `CÃ³digo del Cliente: ${codigoCliente}\n${resultadoTexto}`;
            const urlWhatsApp = `https://api.whatsapp.com/send?text=${encodeURIComponent(mensajeWhatsApp)}`;
            window.open(urlWhatsApp, '_blank');
        } catch (error) {
            console.error("Error en enviarWhatsApp:", error);
        }
    }

    function limpiarPantalla() {
        try {
            const durabilidad = document.getElementById('durabilidad').value;
            document.getElementById('formulario').reset();
            document.getElementById('durabilidad').value = durabilidad;
            document.getElementById('modificacion-campos').style.display = 'none';
            document.getElementById('resultado').innerHTML = '';
            document.getElementById('whatsapp-section').style.display = 'none';
            document.getElementById('guardar-resultado').style.display = 'none';
            document.getElementById('codigoCliente').value = '';
            document.getElementById('report-section').style.display = 'none';
            resultadoTexto = '';
            vacasIniciales = 0;
            puntosOrdenoIniciales = 0;
            totalPezoneras = 0;
            fechaProximoCambio = null;
        } catch (error) {
            console.error("Error en limpiarPantalla:", error);
        }
    }

    function guardarResultado() {
        try {
            if (!currentUser) {
                alert('Debes estar autenticado para guardar el resultado.');
                return;
            }

            const calculo = {
                resultado: resultadoTexto,
                fechaProximoCambio: fechaProximoCambio ? fechaProximoCambio.toISOString() : null,
                fechaInicio: document.getElementById('fechaInicio').value ? new Date(document.getElementById('fechaInicio').value).toISOString() : new Date().toISOString(),
                vacas: vacasIniciales,
                vacasIniciales: vacasIniciales,
                puntos: puntosOrdenoIniciales,
                puntosIniciales: puntosOrdenoIniciales,
                pezoneras: totalPezoneras,
                pezonerasIniciales: totalPezoneras,
                timestamp: new Date().toISOString(),
                hasModification: document.getElementById('realizarModificacion').value === 'si'
            };

            const userCalcsRef = db.collection('calculos').doc(currentUser.uid).collection('registros');

            userCalcsRef.orderBy('timestamp', 'asc').get()
                .then(snapshot => {
                    const calculos = snapshot.docs;
                    if (calculos.length >= 10) {
                        const oldestCalculo = calculos[0];
                        userCalcsRef.doc(oldestCalculo.id).delete();
                    }
                    return userCalcsRef.add(calculo);
                })
                .then(() => {
                    alert('Resultado guardado correctamente.');
                    cargarCalculosGuardados(currentUser.uid);
                })
                .catch(error => {
                    console.error('Error al guardar el resultado:', error);
                    alert('Error al guardar el resultado: ' + error.message);
                });
        } catch (error) {
            console.error("Error en guardarResultado:", error);
        }
    }

    function cargarCalculosGuardados(uid) {
        try {
            const listaCalculos = document.getElementById('lista-calculos');
            listaCalculos.innerHTML = '';
            calculosData = [];

            db.collection('calculos').doc(uid).collection('registros')
                .orderBy('timestamp', 'desc')
                .get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const calc = doc.data();
                        const calcId = doc.id;
                        calculosData.push({
                            id: calcId,
                            fecha: new Date(calc.timestamp).toLocaleString('es-ES'),
                            resultado: calc.resultado,
                            pezoneras: calc.pezoneras,
                            vacas: calc.vacas,
                            puntos: calc.puntos,
                            fechaCambio: calc.fechaProximoCambio ? new Date(calc.fechaProximoCambio).toISOString() : null,
                            fechaInicio: calc.fechaInicio ? new Date(calc.fechaInicio).toISOString() : null,
                            hasModification: calc.hasModification || false
                        });
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <strong>Fecha:</strong> ${new Date(calc.timestamp).toLocaleString('es-ES')}<br>
                            ${calc.resultado.replace(/\n/g, '<br>')}
                            ${isVerifiedUser ? `<button class="delete-calc-btn" onclick="eliminarCalculo('${calcId}')">Eliminar</button>` : ''}
                        `;
                        listaCalculos.appendChild(li);
                    });
                }).catch(error => {
                    console.error('Error al cargar cÃ¡lculos guardados:', error);
                });
        } catch (error) {
            console.error("Error en cargarCalculosGuardados:", error);
        }
    }

    function eliminarCalculo(calcId) {
        try {
            if (!currentUser || !isVerifiedUser) {
                alert('Debes ser un usuario verificado para eliminar cÃ¡lculos.');
                return;
            }
            if (confirm('Â¿EstÃ¡s seguro de que deseas eliminar este cÃ¡lculo?')) {
                db.collection('calculos').doc(currentUser.uid).collection('registros').doc(calcId)
                    .delete()
                    .then(() => {
                        alert('CÃ¡lculo eliminado correctamente.');
                        cargarCalculosGuardados(currentUser.uid);
                    })
                    .catch(error => {
                        console.error('Error al eliminar cÃ¡lculo:', error);
                        alert('Error al eliminar cÃ¡lculo: ' + error.message);
                    });
            }
        } catch (error) {
            console.error("Error en eliminarCalculo:", error);
        }
    }
    function mostrarReporteGrafico() {
        try {
            if (!isVerifiedUser) {
                alert('Esta funciÃ³n es exclusiva para usuarios verificados.');
                return;
            }

            const ctx = document.getElementById('report-canvas').getContext('2d');
            document.getElementById('report-section').style.display = 'block';

            // Obtener el Ãºltimo cÃ¡lculo
            const ultimoCalculo = calculosData.sort((a, b) => new Date(b.fecha) - new Date(a.fecha))[0];

            if (!ultimoCalculo || !ultimoCalculo.fechaInicio || !ultimoCalculo.fechaCambio) {
                alert('No hay datos suficientes para mostrar el grÃ¡fico.');
                document.getElementById('report-section').style.display = 'none';
                return;
            }

            const startDate = new Date(ultimoCalculo.fechaInicio);
            const endDate = new Date(ultimoCalculo.fechaCambio);
            const totalPezoneras = ultimoCalculo.pezoneras || 0;
            const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            const desgastePorDia = totalPezoneras / days;

            const labels = [];
            const dataPoints = [];

            for (let i = 0; i <= days; i++) {
                const currentDate = new Date(startDate.getTime() + i * 24 * 60 * 60 * 1000);
                labels.push(currentDate.toLocaleDateString('es-ES'));
                dataPoints.push(totalPezoneras - (desgastePorDia * i));
            }

            if (window.myChart) {
                window.myChart.destroy();
            }

            window.myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pezoneras Restantes',
                        data: dataPoints,
                        borderColor: '#005566',
                        backgroundColor: 'rgba(0, 85, 102, 0.2)',
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Pezoneras Restantes'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Fecha'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Desgaste de Pezoneras (Ãltimo CÃ¡lculo)'
                        }
                    }
                }
            });
        } catch (error) {
            console.error("Error en mostrarReporteGrafico:", error);
        }
    }

    function exportarCalculosExcel() {
        try {
            const data = calculosData.map(calc => ({
                Fecha: calc.fecha,
                'Vacas Iniciales': calc.vacas,
                'Puntos Iniciales': calc.puntos,
                'Pezoneras Totales': calc.pezoneras,
                'Fecha PrÃ³ximo Cambio': calc.fechaCambio ? new Date(calc.fechaCambio).toLocaleDateString('es-ES') : 'N/A'
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'CÃ¡lculos');
            XLSX.writeFile(wb, 'CalculosPezoneras.xlsx');
        } catch (error) {
            console.error("Error en exportarCalculosExcel:", error);
        }
    }
    function cargarHistorialAdmin() {
        try {
            const listaCalculosAdmin = document.getElementById('lista-calculos-admin');
            listaCalculosAdmin.innerHTML = '';

            const hoy = new Date();
            const mesActual = hoy.getMonth();
            const aÃ±oActual = hoy.getFullYear();

            db.collection('users').get()
                .then(userSnapshot => {
                    const promesas = [];
                    userSnapshot.forEach(userDoc => {
                        const userId = userDoc.id;
                        const userData = userDoc.data();
                        const email = userData.email;

                        const promesa = db.collection('calculos').doc(userId).collection('registros')
                            .orderBy('timestamp', 'desc')
                            .get()
                            .then(snapshot => {
                                snapshot.forEach(doc => {
                                    const calc = doc.data();
                                    if (calc.fechaProximoCambio) {
                                        const fechaCambio = new Date(calc.fechaProximoCambio);
                                        if (fechaCambio.getMonth() === mesActual && fechaCambio.getFullYear() === aÃ±oActual) {
                                            const li = document.createElement('li');
                                            li.innerHTML = `
                                                Correo: ${email} | 
                                                Fecha de Cambio: ${fechaCambio.toLocaleDateString('es-ES')} | 
                                                Puntos: ${calc.puntos} | 
                                                Pezoneras: ${calc.pezoneras}
                                            `;
                                            listaCalculosAdmin.appendChild(li);
                                        }
                                    }
                                });
                            })
                            .catch(error => {
                                console.error(`Error al cargar cÃ¡lculos de ${email}:`, error);
                            });
                        promesas.push(promesa);
                    });
                    return Promise.all(promesas);
                })
                .catch(error => {
                    console.error('Error al cargar historial de usuarios:', error);
                    listaCalculosAdmin.innerHTML = '<li>Error al cargar el historial.</li>';
                });
        } catch (error) {
            console.error("Error en cargarHistorialAdmin:", error);
        }
    }

    function exportarHistorialExcel() {
        try {
            const hoy = new Date();
            const mesActual = hoy.getMonth();
            const aÃ±oActual = hoy.getFullYear();
            const historialData = [];

            db.collection('users').get()
                .then(userSnapshot => {
                    const promesas = [];
                    userSnapshot.forEach(userDoc => {
                        const userId = userDoc.id;
                        const userData = userDoc.data();
                        const email = userData.email;

                        const promesa = db.collection('calculos').doc(userId).collection('registros')
                            .orderBy('timestamp', 'desc')
                            .get()
                            .then(snapshot => {
                                snapshot.forEach(doc => {
                                    const calc = doc.data();
                                    if (calc.fechaProximoCambio) {
                                        const fechaCambio = new Date(calc.fechaProximoCambio);
                                        if (fechaCambio.getMonth() === mesActual && fechaCambio.getFullYear() === aÃ±oActual) {
                                            historialData.push({
                                                Email: email,
                                                'Fecha Cambio': fechaCambio.toLocaleDateString('es-ES'),
                                                'Vacas': calc.vacas,
                                                'Puntos': calc.puntos,
                                                'Pezoneras': calc.pezoneras
                                            });
                                        }
                                    }
                                });
                            });
                        promesas.push(promesa);
                    });
                    return Promise.all(promesas);
                })
                .then(() => {
                    const ws = XLSX.utils.json_to_sheet(historialData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Historial');
                    XLSX.writeFile(wb, 'HistorialCalculos.xlsx');
                })
                .catch(error => {
                    console.error('Error al exportar historial a Excel:', error);
                    alert('Error al exportar historial: ' + error.message);
                });
        } catch (error) {
            console.error("Error en exportarHistorialExcel:", error);
        }
    }

    function cancelarModificacion() {
        try {
            if (!isAdminLoggedIn) {
                alert('Debes ser un administrador para realizar esta acciÃ³n.');
                return;
            }

            const email = document.getElementById('cancel-user-email').value.trim();
            const calcId = document.getElementById('cancel-calc-id').value.trim();

            if (!email || !calcId) {
                alert('Por favor, ingresa el correo del usuario y el ID del cÃ¡lculo.');
                return;
            }

            db.collection('users').where('email', '==', email).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        alert('No se encontrÃ³ un usuario con ese correo.');
                        return;
                    }
                    snapshot.forEach(doc => {
                        const userId = doc.id;
                        db.collection('calculos').doc(userId).collection('registros').doc(calcId).get()
                            .then(calcDoc => {
                                if (!calcDoc.exists) {
                                    alert('No se encontrÃ³ un cÃ¡lculo con ese ID.');
                                    return;
                                }
                                const calcData = calcDoc.data();
                                if (!calcData.hasModification) {
                                    alert('Este cÃ¡lculo no tiene modificaciones para cancelar.');
                                    return;
                                }
                                const updatedCalc = {
                                    resultado: calcData.resultado.replace(/Ajuste por ModificaciÃ³n:[\s\S]*/g, ''),
                                    fechaProximoCambio: calcData.fechaProximoCambioInicial || calcData.fechaProximoCambio,
                                    fechaInicio: calcData.fechaInicio,
                                    vacas: calcData.vacasIniciales,
                                    vacasIniciales: calcData.vacasIniciales,
                                    puntos: calcData.puntosIniciales,
                                    puntosIniciales: calcData.puntosIniciales,
                                    pezoneras: calcData.pezonerasIniciales,
                                    pezonerasIniciales: calcData.pezonerasIniciales,
                                    timestamp: calcData.timestamp,
                                    hasModification: false
                                };
                                return db.collection('calculos').doc(userId).collection('registros').doc(calcId).set(updatedCalc);
                            })
                            .then(() => {
                                alert('ModificaciÃ³n cancelada correctamente.');
                                document.getElementById('cancel-user-email').value = '';
                                document.getElementById('cancel-calc-id').value = '';
                            })
                            .catch(error => {
                                console.error('Error al cancelar modificaciÃ³n:', error);
                                alert('Error al cancelar modificaciÃ³n: ' + error.message);
                            });
                    });
                })
                .catch(error => {
                    console.error('Error al buscar usuario:', error);
                    alert('Error al buscar usuario: ' + error.message);
                });
        } catch (error) {
            console.error("Error en cancelarModificacion:", error);
        }
    }
       function registrarUsuario() {
        try {
            const nombre = document.getElementById('nombre').value.trim();
            const profesion = document.getElementById('profesion').value;
            const empresa = document.getElementById('empresa').value.trim();
            const otraProfesion = document.getElementById('otra-profesion').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();

            if (!nombre || !profesion || !telefono || !email || !password) {
                alert('Por favor, completa todos los campos obligatorios.');
                return;
            }

            if (profesion === 'ganadero' && !empresa) {
                alert('Por favor, ingresa el nombre de la granja o explotaciÃ³n.');
                return;
            }

            if (profesion === 'otro' && !otraProfesion) {
                alert('Por favor, especifica tu profesiÃ³n.');
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    const userData = {
                        nombre: nombre,
                        profesion: profesion === 'otro' ? otraProfesion : profesion,
                        empresa: profesion === 'ganadero' ? empresa : null,
                        telefono: telefono,
                        email: email,
                        isVerified: false,
                        notificacionPreferencia: 'email',
                        timestamp: new Date().toISOString()
                    };
                    return Promise.all([
                        db.collection('users').doc(user.uid).set(userData),
                        user.sendEmailVerification()
                    ]);
                })
                .then(() => {
                    alert('Usuario registrado correctamente. Por favor, verifica tu correo para continuar.');
                    document.getElementById('registro-section').style.display = 'none';
                    document.getElementById('login-section').style.display = 'block';
                    document.getElementById('nombre').value = '';
                    document.getElementById('profesion').value = '';
                    document.getElementById('empresa').value = '';
                    document.getElementById('otra-profesion').value = '';
                    document.getElementById('telefono').value = '';
                    document.getElementById('email').value = '';
                    document.getElementById('password').value = '';
                })
                .catch(error => {
                    console.error('Error al registrar usuario:', error);
                    alert('Error al registrar usuario: ' + error.message);
                });
        } catch (error) {
            console.error("Error en registrarUsuario:", error);
            alert("Error al registrar usuario. Por favor, revisa la consola para mÃ¡s detalles.");
        }
    }

    function loginUsuario() {
        try {
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value.trim();

            if (!email || !password) {
                alert('Por favor, completa todos los campos.');
                return;
            }

            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    if (!user.emailVerified) {
                        alert('Por favor, verifica tu correo electrÃ³nico para continuar.');
                        auth.signOut();
                        return;
                    }
                    currentUser = user;
                    console.log("Usuario autenticado:", user.uid);
                    cargarDatosUsuario(user.uid);
                })
                .catch(error => {
                    console.error('Error al iniciar sesiÃ³n:', error);
                    alert('Error al iniciar sesiÃ³n: ' + error.message);
                });
        } catch (error) {
            console.error("Error en loginUsuario:", error);
            alert("Error al iniciar sesiÃ³n. Por favor, revisa la consola para mÃ¡s detalles.");
        }
    }

    function recuperarContrasena() {
        try {
            const email = document.getElementById('login-email').value.trim();
            if (!email) {
                alert('Por favor, ingresa tu correo electrÃ³nico para recuperar la contraseÃ±a.');
                return;
            }

            auth.sendPasswordResetEmail(email)
                .then(() => {
                    alert('Se ha enviado un correo para restablecer tu contraseÃ±a. Revisa tu bandeja de entrada.');
                })
                .catch(error => {
                    console.error('Error al enviar correo de recuperaciÃ³n:', error);
                    alert('Error al enviar correo de recuperaciÃ³n: ' + error.message);
                });
        } catch (error) {
            console.error("Error en recuperarContrasena:", error);
        }
    }

    function cargarDatosUsuario(uid) {
        try {
            db.collection('users').doc(uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        document.getElementById('user-name').textContent = data.nombre;
                        document.getElementById('user-profesion').textContent = data.profesion + (data.empresa ? ` (${data.empresa})` : '');
                        document.getElementById('notificacion-preferencia').value = data.notificacionPreferencia || 'email';
                        isVerifiedUser = data.isVerified || false;
                        document.getElementById('verified-badge').style.display = isVerifiedUser ? 'inline-block' : 'none';
                        document.getElementById('adsense-section').style.display = isVerifiedUser ? 'none' : 'block';
                        document.getElementById('publicidad-section').style.display = isVerifiedUser ? 'none' : 'block';
                        document.getElementById('donaciones-section').style.display = isVerifiedUser ? 'none' : 'block';
                        document.getElementById('export-excel-btn').style.display = isVerifiedUser ? 'block' : 'none';
                        document.getElementById('view-report-btn').style.display = isVerifiedUser ? 'block' : 'none';
                        cargarPublicidad();
                        cargarPublicidadSecundaria();
                        if (!isVerifiedUser) {
                            setTimeout(() => {
                                document.getElementById('benefits-popup').style.display = 'flex';
                            }, 5000);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error al cargar datos del usuario:', error);
                });
        } catch (error) {
            console.error("Error en cargarDatosUsuario:", error);
        }
    }

    function cerrarSesionUsuario() {
        try {
            auth.signOut()
                .then(() => {
                    currentUser = null;
                    isVerifiedUser = false;
                    document.getElementById('user-section').style.display = 'none';
                    document.getElementById('formulario-section').style.display = 'none';
                    document.getElementById('registro-section').style.display = 'block';
                    document.getElementById('auth-message').style.display = 'block';
                    document.getElementById('adsense-section').style.display = 'block';
                    document.getElementById('publicidad-section').style.display = 'block';
                    document.getElementById('donaciones-section').style.display = 'block';
                    document.getElementById('lista-calculos').innerHTML = '';
                    document.getElementById('export-excel-btn').style.display = 'none';
                    document.getElementById('view-report-btn').style.display = 'none';
                })
                .catch(error => {
                    console.error('Error al cerrar sesiÃ³n:', error);
                    alert('Error al cerrar sesiÃ³n: ' + error.message);
                });
        } catch (error) {
            console.error("Error en cerrarSesionUsuario:", error);
        }
    }

    function guardarPreferenciaNotificacion() {
        try {
            if (!currentUser) {
                alert('Debes estar autenticado para guardar preferencias.');
                return;
            }

            const preferencia = document.getElementById('notificacion-preferencia').value;
            db.collection('users').doc(currentUser.uid).update({
                notificacionPreferencia: preferencia
            })
                .then(() => {
                    alert('Preferencia de notificaciÃ³n guardada correctamente.');
                })
                .catch(error => {
                    console.error('Error al guardar preferencia de notificaciÃ³n:', error);
                    alert('Error al guardar preferencia: ' + error.message);
                });
        } catch (error) {
            console.error("Error en guardarPreferenciaNotificacion:", error);
        }
    }

    function mostrarLoginAdmin() {
        try {
            document.getElementById('admin-login').style.display = 'block';
            document.getElementById('registro-section').style.display = 'none';
            document.getElementById('login-section').style.display = 'none';
            document.getElementById('user-section').style.display = 'none';
            document.getElementById('formulario-section').style.display = 'none';
        } catch (error) {
            console.error("Error en mostrarLoginAdmin:", error);
        }
    }

    function loginAdmin() {
        try {
            const email = document.getElementById('admin-email').value.trim();
            const password = document.getElementById('admin-password').value.trim();
            const adminLoading = document.getElementById('admin-login-loading');

            if (!email || !password) {
                alert('Por favor, completa todos los campos.');
                return;
            }

            adminLoading.style.display = 'block';

            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    if (user.uid === ADMIN_UID || user.email === ADMIN_EMAIL) {
                        isAdminLoggedIn = true;
                        adminUser = user;
                        document.getElementById('admin-login').style.display = 'none';
                        document.getElementById('admin-form').style.display = 'block';
                        document.getElementById('admin-registro').style.display = 'block';
                        document.getElementById('admin-calculos').style.display = 'block';
                        document.getElementById('admin-users-section').style.display = 'block';
                        document.getElementById('registro-section').style.display = 'none';
                        document.getElementById('login-section').style.display = 'none';
                        document.getElementById('user-section').style.display = 'none';
                        document.getElementById('formulario-section').style.display = 'none';
                        document.getElementById('auth-message').style.display = 'none';
                        cargarHistorialAdmin();
                        cargarUsuariosAdmin();
                    } else {
                        alert('No tienes permisos de administrador.');
                        auth.signOut();
                    }
                })
                .catch(error => {
                    console.error('Error al iniciar sesiÃ³n como administrador:', error);
                    alert('Error al iniciar sesiÃ³n: ' + error.message);
                })
                .finally(() => {
                    adminLoading.style.display = 'none';
                });
        } catch (error) {
            console.error("Error en loginAdmin:", error);
            alert("Error al iniciar sesiÃ³n como administrador. Por favor, revisa la consola para mÃ¡s detalles.");
        }
    }

    function cerrarSesionAdmin() {
        try {
            auth.signOut()
                .then(() => {
                    isAdminLoggedIn = false;
                    adminUser = null;
                    document.getElementById('admin-form').style.display = 'none';
                    document.getElementById('admin-registro').style.display = 'none';
                    document.getElementById('admin-calculos').style.display = 'none';
                    document.getElementById('admin-users-section').style.display = 'none';
                    document.getElementById('registro-section').style.display = 'block';
                    document.getElementById('auth-message').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error al cerrar sesiÃ³n del administrador:', error);
                    alert('Error al cerrar sesiÃ³n: ' + error.message);
                });
        } catch (error) {
            console.error("Error en cerrarSesionAdmin:", error);
        }
    }

    function registrarAdmin() {
        try {
            const nombre = document.getElementById('admin-nombre').value.trim();
            const email = document.getElementById('admin-registro-email').value.trim();
            const password = document.getElementById('admin-registro-password').value.trim();

            if (!nombre || !email || !password) {
                alert('Por favor, completa todos los campos.');
                return;
            }

            if (!isAdminLoggedIn) {
                alert('Debes ser un administrador para registrar otro administrador.');
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    const user = userCredential.user;
                    return db.collection('admins').doc(user.uid).set({
                        nombre: nombre,
                        email: email,
                        timestamp: new Date().toISOString()
                    });
                })
                .then(() => {
                    alert('Administrador registrado correctamente.');
                    document.getElementById('admin-nombre').value = '';
                    document.getElementById('admin-registro-email').value = '';
                    document.getElementById('admin-registro-password').value = '';
                })
                .catch(error => {
                    console.error('Error al registrar administrador:', error);
                    alert('Error al registrar administrador: ' + error.message);
                });
        } catch (error) {
            console.error("Error en registrarAdmin:", error);
        }
    }

    function verificarUsuario() {
        try {
            const email = document.getElementById('user-verification-email').value.trim();
            if (!email) {
                alert('Por favor, ingresa el correo del usuario.');
                return;
            }

            if (!isAdminLoggedIn) {
                alert('Debes ser un administrador para realizar esta acciÃ³n.');
                return;
            }

            const verificationDate = new Date();
            const expirationDate = new Date();
            expirationDate.setFullYear(verificationDate.getFullYear() + 1); // SuscripciÃ³n vÃ¡lida por 1 aÃ±o

            db.collection('users').where('email', '==', email).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        alert('No se encontrÃ³ un usuario con ese correo.');
                        return;
                    }
                    snapshot.forEach(doc => {
                        db.collection('users').doc(doc.id).update({
                            isVerified: true,
                            verificationDate: verificationDate.toISOString(),
                            verificationExpiration: expirationDate.toISOString()
                        })
                            .then(() => {
                                alert('Usuario verificado correctamente.');
                                cargarUsuariosAdmin(document.getElementById('user-filter').value);
                                if (currentUser && currentUser.email === email) {
                                    isVerifiedUser = true;
                                    document.getElementById('verified-badge').style.display = 'inline-block';
                                    document.getElementById('adsense-section').style.display = 'none';
                                    document.getElementById('publicidad-section').style.display = 'none';
                                    document.getElementById('donaciones-section').style.display = 'none';
                                    document.getElementById('export-excel-btn').style.display = 'block';
                                    document.getElementById('view-report-btn').style.display = 'block';
                                }
                            })
                            .catch(error => {
                                console.error('Error al verificar usuario:', error);
                                alert('Error al verificar usuario: ' + error.message);
                            });
                    });
                })
                .catch(error => {
                    console.error('Error al buscar usuario:', error);
                    alert('Error al buscar usuario: ' + error.message);
                });
        } catch (error) {
            console.error("Error en verificarUsuario:", error);
            alert('Error inesperado al verificar usuario. Por favor, revisa la consola.');
        }
    }

    function quitarVerificacionUsuario() {
        try {
            const email = document.getElementById('user-verification-email').value.trim();
            if (!email) {
                alert('Por favor, ingresa el correo del usuario.');
                return;
            }

            if (!isAdminLoggedIn) {
                alert('Debes ser un administrador para realizar esta acciÃ³n.');
                return;
            }

            db.collection('users').where('email', '==', email).get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        alert('No se encontrÃ³ un usuario con ese correo.');
                        return;
                    }
                    snapshot.forEach(doc => {
                        db.collection('users').doc(doc.id).update({
                            isVerified: false,
                            verificationDate: null,
                            verificationExpiration: null
                        })
                            .then(() => {
                                alert('VerificaciÃ³n retirada correctamente.');
                                cargarUsuariosAdmin(document.getElementById('user-filter').value);
                                if (currentUser && currentUser.email === email) {
                                    isVerifiedUser = false;
                                    document.getElementById('verified-badge').style.display = 'none';
                                    document.getElementById('adsense-section').style.display = 'block';
                                    document.getElementById('publicidad-section').style.display = 'block';
                                    document.getElementById('donaciones-section').style.display = 'block';
                                    document.getElementById('export-excel-btn').style.display = 'none';
                                    document.getElementById('view-report-btn').style.display = 'none';
                                }
                            })
                            .catch(error => {
                                console.error('Error al quitar verificaciÃ³n:', error);
                                alert('Error al quitar verificaciÃ³n: ' + error.message);
                            });
                    });
                })
                .catch(error => {
                    console.error('Error al buscar usuario:', error);
                    alert('Error al buscar usuario: ' + error.message);
                });
        } catch (error) {
            console.error("Error en quitarVerificacionUsuario:", error);
            alert('Error inesperado al quitar verificaciÃ³n. Por favor, revisa la consola.');
        }
    }

    function cargarUsuariosAdmin(filtro = 'all') {
        try {
            const usersTableBody = document.getElementById('users-table-body');
            usersTableBody.innerHTML = '';

            db.collection('users').get()
                .then(snapshot => {
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        const userId = doc.id;
                        const isVerified = user.isVerified || false;
                        const verificationDate = user.verificationDate ? new Date(user.verificationDate).toLocaleDateString('es-ES') : 'N/A';
                        const expirationDate = user.verificationExpiration ? new Date(user.verificationExpiration).toLocaleDateString('es-ES') : 'N/A';

                        if (filtro === 'verified' && !isVerified) return;
                        if (filtro === 'unverified' && isVerified) return;

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${user.email}</td>
                            <td>${isVerified ? 'Verificado' : 'No Verificado'}</td>
                            <td>${verificationDate}</td>
                            <td>${expirationDate}</td>
                            <td>
                                ${isVerified ? 
                                    `<button class="action-btn" onclick="quitarVerificacionUsuarioAdmin('${user.email}')">Quitar VerificaciÃ³n</button>` :
                                    `<button class="action-btn" onclick="verificarUsuarioAdmin('${user.email}')">Verificar</button>`}
                            </td>
                        `;
                        usersTableBody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error al cargar usuarios:', error);
                    usersTableBody.innerHTML = '<tr><td colspan="5">Error al cargar usuarios.</td></tr>';
                });
        } catch (error) {
            console.error("Error en cargarUsuariosAdmin:", error);
        }
    }

    function filtrarUsuarios() {
        try {
            const filtro = document.getElementById('user-filter').value;
            cargarUsuariosAdmin(filtro);
        } catch (error) {
            console.error("Error en filtrarUsuarios:", error);
        }
    }

    function verificarUsuarioAdmin(email) {
        try {
            document.getElementById('user-verification-email').value = email;
            verificarUsuario();
        } catch (error) {
            console.error("Error en verificarUsuarioAdmin:", error);
        }
    }

    function quitarVerificacionUsuarioAdmin(email) {
        try {
            document.getElementById('user-verification-email').value = email;
            quitarVerificacionUsuario();
        } catch (error) {
            console.error("Error en quitarVerificacionUsuarioAdmin:", error);
        }
    }


